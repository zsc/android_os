<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬4ç« ï¼šInitè¿›ç¨‹ä¸ç³»ç»Ÿå¯åŠ¨</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Android OS æ·±åº¦åŸç†è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬1ç« ï¼šAndroidç³»ç»Ÿæ¶æ„æ¦‚è§ˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬2ç« ï¼šLinuxå†…æ ¸å±‚å®šåˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬3ç« ï¼šç¡¬ä»¶æŠ½è±¡å±‚(HAL)</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬4ç« ï¼šInitè¿›ç¨‹ä¸ç³»ç»Ÿå¯åŠ¨</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬5ç« ï¼šZygoteä¸åº”ç”¨è¿›ç¨‹ç®¡ç†</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬6ç« ï¼šAndroid Runtime (ART)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬7ç« ï¼šBinder IPCæœºåˆ¶æ·±åº¦å‰–æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬8ç« ï¼šç³»ç»ŸæœåŠ¡æ¶æ„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬9ç« ï¼šContentProviderä¸æ•°æ®å…±äº«</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬10ç« ï¼šAndroidå›¾å½¢ç³»ç»Ÿæ¶æ„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬11ç« ï¼šéŸ³é¢‘ç³»ç»Ÿæ¶æ„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬12ç« ï¼šç›¸æœºä¸å¤šåª’ä½“æ¡†æ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬13ç« ï¼šAndroidå®‰å…¨æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬14ç« ï¼šå¯†é’¥ç®¡ç†ä¸ç¡¬ä»¶å®‰å…¨</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬15ç« ï¼šæ¼æ´æ¡ˆä¾‹åˆ†æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬16ç« ï¼šNeural Networks API (NNAPI)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬17ç« ï¼šTensorFlow Liteé›†æˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬18ç« ï¼šML Kitä¸è®¾å¤‡ç«¯AI</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬19ç« ï¼šNPU/TPUç¡¬ä»¶åŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter20.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬20ç« ï¼šåå¤„ç†å™¨ç³»ç»Ÿé›†æˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter21.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬21ç« ï¼šMIUIç³»ç»Ÿæ¶æ„å‰–æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter22.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬22ç« ï¼šColorOS/EMUIæŠ€æœ¯åˆ†æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter23.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬23ç« ï¼šå‚å•†å†…æ ¸ä¸é©±åŠ¨å®šåˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter24.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬24ç« ï¼šå‚å•†AIèƒ½åŠ›å¯¹æ¯”</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter25.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬25ç« ï¼šOriginOSæ·±åº¦å‰–æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter26.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬26ç« ï¼šAndroidè™šæ‹ŸåŒ–æŠ€æœ¯</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter27.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬27ç« ï¼šå®æ—¶æ€§ä¸æ€§èƒ½ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter28.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬28ç« ï¼šé€†å‘å·¥ç¨‹ä¸å®‰å…¨ç ”ç©¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter29.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬29ç« ï¼šAndroidæœªæ¥æ¼”è¿›</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter30.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">é™„å½•Aï¼šè°ƒè¯•å·¥å…·ä¸æŠ€å·§</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter31.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">é™„å½•Bï¼šæºç ç¼–è¯‘ä¸å®šåˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter32.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬32ç« ï¼šå‚è€ƒèµ„æº</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">AndroidOSåŸç†æ•™ç¨‹é¡¹ç›®è¯´æ˜</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="README.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Android OS æ·±åº¦åŸç†è§£æ</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="4init">ç¬¬4ç« ï¼šInitè¿›ç¨‹ä¸ç³»ç»Ÿå¯åŠ¨</h1>
<p>Initè¿›ç¨‹æ˜¯Androidç³»ç»Ÿä¸­ç¬¬ä¸€ä¸ªç”¨æˆ·ç©ºé—´è¿›ç¨‹ï¼Œæ‰¿æ‹…ç€æ•´ä¸ªç³»ç»Ÿçš„åˆå§‹åŒ–é‡ä»»ã€‚æœ¬ç« å°†æ·±å…¥å‰–æInitè¿›ç¨‹çš„å®ç°åŸç†ï¼ŒåŒ…æ‹¬å…¶å¯åŠ¨æµç¨‹ã€RCè„šæœ¬è§£æã€å±æ€§æœåŠ¡ã€SELinuxç­–ç•¥åŠ è½½ç­‰æ ¸å¿ƒæœºåˆ¶ã€‚é€šè¿‡ä¸Linuxä¼ ç»Ÿinitã€iOSçš„launchdã€é¸¿è’™OSçš„initå¯¹æ¯”ï¼Œè¯»è€…å°†å…¨é¢ç†è§£Androidç‹¬ç‰¹çš„ç³»ç»Ÿå¯åŠ¨æ¶æ„ã€‚</p>
<h2 id="41-init">4.1 Initè¿›ç¨‹æºç åˆ†æ</h2>
<h3 id="411-init">4.1.1 Initè¿›ç¨‹çš„è¯ç”Ÿ</h3>
<p>å½“Linuxå†…æ ¸å®Œæˆè‡ªèº«åˆå§‹åŒ–åï¼Œä¼šå¯åŠ¨ç¬¬ä¸€ä¸ªç”¨æˆ·ç©ºé—´è¿›ç¨‹â€”â€”Initè¿›ç¨‹ï¼ˆPID=1ï¼‰ã€‚Androidçš„Initè¿›ç¨‹å®ç°ä½äº<code>system/core/init/</code>ç›®å½•ï¼Œå…¶å…¥å£å‡½æ•°æ˜¯<code>main()</code>ã€‚å†…æ ¸é€šè¿‡<code>run_init_process()</code>è°ƒç”¨<code>/init</code>äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¿™æ˜¯ramdiskä¸­çš„ç¬¬ä¸€ä¸ªç¨‹åºã€‚</p>
<p><strong>å†…æ ¸åˆ°ç”¨æˆ·ç©ºé—´çš„è½¬æ¢</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">kernel_init</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">run_init_process</span><span class="p">(</span><span class="s">&quot;/init&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">execve</span><span class="p">(</span><span class="s">&quot;/init&quot;</span><span class="p">)</span>
</code></pre></div>

<p>å†…æ ¸åœ¨<code>kernel_init()</code>å‡½æ•°ä¸­æŒ‰ä»¥ä¸‹é¡ºåºå°è¯•å¯åŠ¨initï¼š</p>
<ol>
<li><code>ramdisk_execute_command</code>ï¼ˆé€šå¸¸æ˜¯<code>/init</code>ï¼‰</li>
<li><code>/sbin/init</code></li>
<li><code>/etc/init</code></li>
<li><code>/bin/init</code></li>
<li><code>/bin/sh</code>ï¼ˆç´§æ€¥æ¨¡å¼ï¼‰</li>
</ol>
<p>Androidå°†initæ”¾åœ¨ramdiskæ ¹ç›®å½•ï¼Œç¡®ä¿ç¬¬ä¸€ä¸ªè¢«æ‰¾åˆ°ã€‚å†…æ ¸ä¼ é€’çš„ç¯å¢ƒå˜é‡æå…¶æœ‰é™ï¼š</p>
<ul>
<li><code>HOME=/</code></li>
<li><code>TERM=linux</code></li>
<li><code>PATH=/sbin:/usr/sbin:/bin:/usr/bin</code></li>
</ul>
<p>Initè¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š</p>
<p><strong>First Stage Init</strong>
First Stage Initåœ¨ramdiskç¯å¢ƒä¸­è¿è¡Œï¼Œä½¿ç”¨é™æ€é“¾æ¥çš„æœ€å°åŒ–äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¸»è¦ä»»åŠ¡æ˜¯å‡†å¤‡çœŸæ­£çš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼š</p>
<ul>
<li>æŒ‚è½½åŸºç¡€æ–‡ä»¶ç³»ç»Ÿï¼ˆ/devã€/procã€/sysç­‰ï¼‰</li>
<li>ä½¿ç”¨<code>mount("tmpfs", "/dev", "tmpfs", MS_NOSUID, "mode=0755")</code></li>
<li>åˆ›å»ºå¿…è¦çš„å­ç›®å½•ï¼š/dev/ptsã€/dev/socketã€/dev/dm-user</li>
<li>æŒ‚è½½<code>mount("devpts", "/dev/pts", "devpts", 0, NULL)</code>æ”¯æŒä¼ªç»ˆç«¯</li>
<li>æŒ‚è½½<code>mount("proc", "/proc", "proc", 0, "hidepid=2")</code>å¢å¼ºå®‰å…¨æ€§</li>
<li>
<p>æŒ‚è½½<code>mount("sysfs", "/sys", "sysfs", 0, NULL)</code>å¯¼å‡ºå†…æ ¸å¯¹è±¡</p>
</li>
<li>
<p>åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹</p>
</li>
<li><code>/dev/null</code>ã€<code>/dev/zero</code>ã€<code>/dev/full</code>ç­‰åŸºç¡€è®¾å¤‡</li>
<li><code>/dev/kmsg</code>ç”¨äºå†…æ ¸æ—¥å¿—ï¼ˆä¸»è®¾å¤‡å·1ï¼Œæ¬¡è®¾å¤‡å·11ï¼‰</li>
<li><code>/dev/random</code>ã€<code>/dev/urandom</code>ç”¨äºéšæœºæ•°ï¼ˆä¸»è®¾å¤‡å·1ï¼Œæ¬¡è®¾å¤‡å·8/9ï¼‰</li>
<li><code>/dev/ptmx</code>ä¼ªç»ˆç«¯ä¸»è®¾å¤‡ï¼ˆä¸»è®¾å¤‡å·5ï¼Œæ¬¡è®¾å¤‡å·2ï¼‰</li>
<li>
<p>ä½¿ç”¨<code>mknod()</code>ç³»ç»Ÿè°ƒç”¨åˆ›å»ºï¼Œè®¾ç½®æƒé™0666æˆ–0600</p>
</li>
<li>
<p>åˆå§‹åŒ–å†…æ ¸æ—¥å¿—</p>
</li>
<li>é€šè¿‡<code>android::base::InitLogging()</code>è®¾ç½®æ—¥å¿—ç³»ç»Ÿ</li>
<li>é‡å®šå‘stdout/stderråˆ°<code>/dev/kmsg</code></li>
<li>è®¾ç½®æ—¥å¿—çº§åˆ«å’Œæ ¼å¼ï¼ˆæ—¶é—´æˆ³ã€è¿›ç¨‹ä¿¡æ¯ç­‰ï¼‰</li>
<li>
<p>é…ç½®klogè¿‡æ»¤è§„åˆ™ï¼Œé¿å…æ—¥å¿—é£æš´</p>
</li>
<li>
<p>æŒ‚è½½å¿…è¦çš„å—è®¾å¤‡</p>
</li>
<li>è§£æè®¾å¤‡æ ‘ï¼ˆdevice treeï¼‰è·å–åˆ†åŒºä¿¡æ¯</li>
<li>ç­‰å¾…å—è®¾å¤‡å°±ç»ªï¼ˆé€šè¿‡ueventç›‘å¬ï¼‰</li>
<li>æŒ‚è½½systemåˆ†åŒºåˆ°<code>/system</code>ï¼ˆåªè¯»ï¼‰</li>
<li>æŒ‚è½½vendoråˆ†åŒºåˆ°<code>/vendor</code>ï¼ˆåªè¯»ï¼‰</li>
<li>
<p>å¤„ç†A/Båˆ†åŒºçš„sloté€‰æ‹©</p>
</li>
<li>
<p>åŠ è½½SELinuxç­–ç•¥ï¼ˆå¦‚æœæ˜¯å¼ºåˆ¶æ¨¡å¼ï¼‰</p>
</li>
<li>è°ƒç”¨<code>SelinuxInitialize()</code>åŠ è½½ç¼–è¯‘åçš„ç­–ç•¥</li>
<li>è®¾ç½®è¿›ç¨‹ä¸Šä¸‹æ–‡ä¸º<code>u:r:init:s0</code></li>
<li>ä»<code>/system/etc/selinux/plat_sepolicy.cil</code>åŠ è½½å¹³å°ç­–ç•¥</li>
<li>åˆå¹¶<code>/vendor/etc/selinux/vendor_sepolicy.cil</code>å‚å•†ç­–ç•¥</li>
<li>
<p>é€šè¿‡<code>selinux_android_load_policy()</code>åŠ è½½åˆ°å†…æ ¸</p>
</li>
<li>
<p>æ‰§è¡ŒSecond Stage Init</p>
</li>
<li>é€šè¿‡<code>execv("/system/bin/init", argv)</code>é‡æ–°æ‰§è¡Œè‡ªèº«</li>
<li>ä¼ é€’<code>--second-stage</code>å‚æ•°æ ‡è¯†</li>
<li>ä¿ç•™å¿…è¦çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆå¦‚<code>/dev/kmsg</code>ï¼‰</li>
</ul>
<p><strong>Second Stage Init</strong>
Second Stage Initä»çœŸæ­£çš„ç³»ç»Ÿåˆ†åŒºè¿è¡Œï¼Œæ‹¥æœ‰å®Œæ•´çš„åº“æ”¯æŒå’Œæ›´ä¸°å¯Œçš„åŠŸèƒ½ï¼š</p>
<ul>
<li>åˆå§‹åŒ–å±æ€§æœåŠ¡ï¼ˆProperty Serviceï¼‰</li>
<li>åˆ›å»ºå±æ€§å…±äº«å†…å­˜åŒºåŸŸï¼ˆ<code>/dev/__properties__</code>ï¼‰</li>
<li>åˆå§‹åŒ–å±æ€§åŒºåŸŸå¤´éƒ¨ï¼Œè®¾ç½®é­”æ•°å’Œç‰ˆæœ¬å·</li>
<li>å¯åŠ¨UnixåŸŸå¥—æ¥å­—ç›‘å¬å±æ€§è®¾ç½®è¯·æ±‚ï¼ˆ<code>/dev/socket/property_service</code>ï¼‰</li>
<li>åŠ è½½é»˜è®¤å±æ€§æ–‡ä»¶ï¼š<ul>
<li><code>/default.prop</code>ï¼ˆramdiskä¸­çš„å±æ€§ï¼‰</li>
<li><code>/system/build.prop</code>ï¼ˆç³»ç»Ÿå±æ€§ï¼‰</li>
<li><code>/vendor/build.prop</code>ï¼ˆå‚å•†å±æ€§ï¼‰</li>
<li><code>/product/build.prop</code>ï¼ˆäº§å“å±æ€§ï¼‰</li>
<li><code>/odm/build.prop</code>ï¼ˆODMå±æ€§ï¼‰</li>
</ul>
</li>
<li>
<p>è®¾ç½®å±æ€§åŒºåŸŸçš„SELinuxæ ‡ç­¾å’Œè®¿é—®æƒé™</p>
</li>
<li>
<p>è§£æRCè„šæœ¬</p>
</li>
<li>ä»ä»¥ä¸‹ç›®å½•æŒ‰é¡ºåºåŠ è½½RCæ–‡ä»¶ï¼š<ul>
<li><code>/init.rc</code>ï¼ˆä¸»é…ç½®æ–‡ä»¶ï¼‰</li>
<li><code>/system/etc/init/</code>ï¼ˆç³»ç»ŸæœåŠ¡ï¼‰</li>
<li><code>/vendor/etc/init/</code>ï¼ˆå‚å•†æœåŠ¡ï¼‰</li>
<li><code>/odm/etc/init/</code>ï¼ˆODMæœåŠ¡ï¼‰</li>
</ul>
</li>
<li>æ„å»ºActionå’ŒServiceçš„å†…éƒ¨æ•°æ®ç»“æ„</li>
<li>éªŒè¯è¯­æ³•æ­£ç¡®æ€§å’Œæƒé™è¦æ±‚</li>
<li>æ£€æŸ¥æœåŠ¡çš„å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨</li>
<li>
<p>é¢„å¤„ç†importè¯­å¥ï¼Œæ”¯æŒå±æ€§å€¼æ›¿æ¢</p>
</li>
<li>
<p>åˆå§‹åŒ–å­ç³»ç»Ÿ</p>
</li>
<li>å¯åŠ¨ueventdå¤„ç†è®¾å¤‡äº‹ä»¶ï¼ˆè½¯é“¾æ¥åˆ°initï¼‰</li>
<li>å¯åŠ¨watchdogdé˜²æ­¢ç³»ç»ŸæŒ‚èµ·ï¼ˆå¦‚æœç¡¬ä»¶æ”¯æŒï¼‰</li>
<li>åˆ›å»ºæ§åˆ¶æ¶ˆæ¯å¤„ç†å™¨ï¼ˆ<code>/dev/socket/init</code>ï¼‰</li>
<li>
<p>æ³¨å†Œä¿¡å·å¤„ç†å™¨ï¼ˆSIGCHLDã€SIGTERMç­‰ï¼‰</p>
</li>
<li>
<p>å¯åŠ¨ç³»ç»ŸæœåŠ¡</p>
</li>
<li>æ ¹æ®classå’Œè§¦å‘å™¨æœ‰åºå¯åŠ¨</li>
<li>è®¾ç½®è¿›ç¨‹çš„capabilitiesã€ä¼˜å…ˆçº§ã€cgroupç­‰</li>
<li>é…ç½®OOMè°ƒæ•´å€¼ä¿æŠ¤å…³é”®æœåŠ¡</li>
<li>
<p>è®¾ç½®è¿›ç¨‹çš„namespaceéš”ç¦»ï¼ˆå¦‚æœé…ç½®ï¼‰</p>
</li>
<li>
<p>è¿›å…¥ä¸»äº‹ä»¶å¾ªç¯</p>
</li>
<li>åŸºäºepollçš„äº‹ä»¶é©±åŠ¨æ¨¡å‹</li>
<li>å¤„ç†å±æ€§å˜åŒ–ã€å­è¿›ç¨‹é€€å‡ºã€æ§åˆ¶æ¶ˆæ¯ç­‰</li>
<li>æ‰§è¡Œpendingçš„Actioné˜Ÿåˆ—</li>
<li>ç›‘æ§æœåŠ¡å¥åº·çŠ¶æ€ï¼Œå¿…è¦æ—¶é‡å¯</li>
</ul>
<p><strong>å…³é”®ç¯å¢ƒå˜é‡è®¾ç½®</strong></p>
<div class="codehilite"><pre><span></span><code>PATH=/system/bin:/system/xbin:/vendor/bin:/odm/bin
LD_LIBRARY_PATH=/system/lib64:/vendor/lib64:/odm/lib64
ANDROID_ROOT=/system
ANDROID_DATA=/data
ANDROID_STORAGE=/storage
ANDROID_RUNTIME_ROOT=/apex/com.android.runtime
ANDROID_TZDATA_ROOT=/apex/com.android.tzdata
ANDROID_ART_ROOT=/apex/com.android.art
BOOTCLASSPATH=/apex/com.android.runtime/javalib/core-oj.jar:...
</code></pre></div>

<h3 id="412">4.1.2 å…³é”®æ•°æ®ç»“æ„</h3>
<p>Initè¿›ç¨‹ä½¿ç”¨ç²¾å¿ƒè®¾è®¡çš„æ•°æ®ç»“æ„ç®¡ç†ç³»ç»Ÿå¯åŠ¨ï¼Œè¿™äº›ç»“æ„ä½“ç°äº†Androidå¯¹å¯åŠ¨è¿‡ç¨‹çš„ç»†ç²’åº¦æ§åˆ¶ï¼š</p>
<p><strong>Actionï¼ˆåŠ¨ä½œï¼‰</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">Action</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Command</span><span class="o">&gt;</span><span class="w"> </span><span class="n">commands</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">property_triggers</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">event_trigger</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">oneshot</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">trigger_order</span><span class="p">;</span><span class="w">  </span><span class="c1">// è§¦å‘ä¼˜å…ˆçº§</span>

<span class="w">    </span><span class="c1">// æ‰§è¡ŒçŠ¶æ€ç®¡ç†</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">current_command</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">ExecuteOneCommand</span><span class="p">();</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">CheckPropertyTriggers</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// è§¦å‘å™¨ç®¡ç†</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">required_property_contexts</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">TriggersEqual</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Action</span><span class="o">&amp;</span><span class="w"> </span><span class="n">other</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æ‰§è¡Œæ§åˆ¶</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">time_point</span><span class="w"> </span><span class="n">last_command_time</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="o">&gt;</span><span class="w"> </span><span class="n">command_timeout</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Actionçš„å…³é”®ç‰¹æ€§ï¼š</p>
<ul>
<li><strong>è§¦å‘å™¨ç±»å‹</strong>ï¼šäº‹ä»¶è§¦å‘å™¨ï¼ˆå¦‚<code>boot</code>ï¼‰æˆ–å±æ€§è§¦å‘å™¨ï¼ˆå¦‚<code>property:sys.boot_completed=1</code>ï¼‰</li>
<li><strong>å‘½ä»¤é˜Ÿåˆ—</strong>ï¼šæ”¯æŒå¼‚æ­¥æ‰§è¡Œï¼Œæ¯æ¬¡å¾ªç¯åªæ‰§è¡Œä¸€ä¸ªå‘½ä»¤ï¼Œé¿å…é˜»å¡</li>
<li><strong>ä¼˜å…ˆçº§æ§åˆ¶</strong>ï¼šç›¸åŒè§¦å‘å™¨çš„ActionæŒ‰è§£æé¡ºåºæ‰§è¡Œ</li>
<li><strong>ä¸€æ¬¡æ€§æ‰§è¡Œ</strong>ï¼š<code>oneshot</code>æ ‡è®°çš„Actionåªæ‰§è¡Œä¸€æ¬¡</li>
</ul>
<p><strong>Serviceï¼ˆæœåŠ¡ï¼‰</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">Service</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span><span class="w">  </span><span class="c1">// SVC_RUNNING, SVC_DISABLED, SVC_RESTARTINGç­‰</span>
<span class="w">    </span><span class="kt">pid_t</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Option</span><span class="o">&gt;</span><span class="w"> </span><span class="n">options</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æœåŠ¡æ§åˆ¶</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">crash_count</span><span class="p">;</span>
<span class="w">    </span><span class="kt">time_t</span><span class="w"> </span><span class="n">time_started</span><span class="p">;</span>
<span class="w">    </span><span class="kt">time_t</span><span class="w"> </span><span class="n">time_crashed</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span><span class="w"> </span><span class="n">restart_period</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="n">s</span><span class="p">;</span><span class="w">  </span><span class="c1">// é‡å¯é—´éš”</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span><span class="o">&gt;</span><span class="w"> </span><span class="n">timeout_period</span><span class="p">;</span><span class="w">  </span><span class="c1">// å¯åŠ¨è¶…æ—¶</span>

<span class="w">    </span><span class="c1">// è¿›ç¨‹ç®¡ç†</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">console</span><span class="p">;</span><span class="w">  </span><span class="c1">// æ§åˆ¶å°è®¾å¤‡</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sigstop</span><span class="p">;</span><span class="w">  </span><span class="c1">// å¯åŠ¨åæ˜¯å¦æš‚åœ</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">rlimit</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">rlimits</span><span class="p">;</span><span class="w">  </span><span class="c1">// èµ„æºé™åˆ¶</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">writepid_files</span><span class="p">;</span><span class="w">  </span><span class="c1">// PIDæ–‡ä»¶è·¯å¾„</span>

<span class="w">    </span><span class="c1">// å®‰å…¨ä¸Šä¸‹æ–‡</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">seclabel</span><span class="p">;</span><span class="w">  </span><span class="c1">// SELinuxæ ‡ç­¾</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uid_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">supp_gids</span><span class="p">;</span><span class="w">  </span><span class="c1">// è¡¥å……ç»„ID</span>
<span class="w">    </span><span class="n">CapSet</span><span class="w"> </span><span class="n">capabilities</span><span class="p">;</span><span class="w">  </span><span class="c1">// Linux capabilities</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">updatable</span><span class="p">;</span><span class="w">  </span><span class="c1">// APEXæ›´æ–°</span>

<span class="w">    </span><span class="c1">// å‘½åç©ºé—´éš”ç¦»</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">namespace_flags</span><span class="p">;</span><span class="w">  </span><span class="c1">// CLONE_NEWPID, CLONE_NEWNETç­‰</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">namespaces_to_enter</span><span class="p">;</span><span class="w">  </span><span class="c1">// è¿›å…¥å·²å­˜åœ¨çš„namespace</span>

<span class="w">    </span><span class="c1">// cgroupå’Œè°ƒåº¦</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cgroup_paths</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">oom_score_adjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1000</span><span class="p">;</span><span class="w">  </span><span class="c1">// OOM killerè°ƒæ•´å€¼</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">// niceå€¼</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_param</span><span class="w"> </span><span class="n">scheduling_param</span><span class="p">;</span><span class="w">  </span><span class="c1">// å®æ—¶è°ƒåº¦å‚æ•°</span>

<span class="w">    </span><span class="c1">// æœåŠ¡ä¾èµ–</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">before_services</span><span class="p">;</span><span class="w">  </span><span class="c1">// å¿…é¡»åœ¨è¿™äº›æœåŠ¡å‰å¯åŠ¨</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">after_services</span><span class="p">;</span><span class="w">   </span><span class="c1">// å¿…é¡»åœ¨è¿™äº›æœåŠ¡åå¯åŠ¨</span>

<span class="w">    </span><span class="c1">// å…³é”®æœåŠ¡å¤„ç†</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_critical</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w">  </span><span class="c1">// å´©æºƒæ˜¯å¦è§¦å‘é‡å¯</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">critical_services_to_restart</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Serviceçš„é«˜çº§ç‰¹æ€§ï¼š</p>
<ul>
<li><strong>ç”Ÿå‘½å‘¨æœŸç®¡ç†</strong>ï¼šè‡ªåŠ¨é‡å¯ã€å´©æºƒè®¡æ•°ã€é€€é¿ç®—æ³•</li>
<li><strong>èµ„æºéš”ç¦»</strong>ï¼šæ”¯æŒLinux namespaceã€cgroupã€capabilities</li>
<li><strong>ä¾èµ–å…³ç³»</strong>ï¼šæœåŠ¡é—´çš„å¯åŠ¨é¡ºåºä¾èµ–</li>
<li><strong>æ›´æ–°æ”¯æŒ</strong>ï¼šä¸APEXæ¨¡å—ç³»ç»Ÿé›†æˆ</li>
</ul>
<p><strong>Propertyï¼ˆå±æ€§ï¼‰</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// å±æ€§å­˜å‚¨ç»“æ„</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">prop_info</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">atomic_uint_least32_t</span><span class="w"> </span><span class="n">serial</span><span class="p">;</span><span class="w">  </span><span class="c1">// ç‰ˆæœ¬å·ï¼Œç”¨äºæ£€æµ‹å˜åŒ–</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">value</span><span class="p">[</span><span class="n">PROP_VALUE_MAX</span><span class="p">];</span><span class="w">   </span><span class="c1">// å±æ€§å€¼ï¼ˆ92å­—èŠ‚ï¼‰</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="n">PROP_NAME_MAX</span><span class="p">];</span><span class="w">     </span><span class="c1">// å±æ€§åï¼ˆ32å­—èŠ‚ï¼‰</span>
<span class="p">};</span>

<span class="c1">// å±æ€§åŒºåŸŸç®¡ç†</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">prop_area</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">bytes_used</span><span class="p">;</span>
<span class="w">    </span><span class="kt">atomic_uint_least32_t</span><span class="w"> </span><span class="n">serial</span><span class="p">;</span><span class="w">  </span><span class="c1">// å…¨å±€ç‰ˆæœ¬å·</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">magic</span><span class="p">;</span><span class="w">  </span><span class="c1">// 0x504f5250 (&#39;PROP&#39;)</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">version</span><span class="p">;</span><span class="w">  </span><span class="c1">// å½“å‰ç‰ˆæœ¬å·</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">reserved</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w">  </span><span class="c1">// å®é™…å±æ€§æ•°æ®</span>
<span class="p">};</span>

<span class="c1">// å±æ€§èŠ‚ç‚¹ï¼ˆTrieæ ‘ç»“æ„ï¼‰</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">prop_bt</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">namelen</span><span class="p">;</span><span class="w">  </span><span class="c1">// åç§°é•¿åº¦</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">proplen</span><span class="p">;</span><span class="w">  </span><span class="c1">// å±æ€§æ•°é‡</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">children</span><span class="p">;</span><span class="w">  </span><span class="c1">// å­èŠ‚ç‚¹åç§»</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">props</span><span class="p">;</span><span class="w">  </span><span class="c1">// å±æ€§åˆ—è¡¨åç§»</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w">  </span><span class="c1">// èŠ‚ç‚¹åç§°</span>
<span class="p">};</span>

<span class="c1">// å±æ€§ä¸Šä¸‹æ–‡æ˜ å°„</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">prop_context</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">name_prefix</span><span class="p">;</span><span class="w">  </span><span class="c1">// å±æ€§å‰ç¼€</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">context</span><span class="p">;</span><span class="w">  </span><span class="c1">// SELinuxä¸Šä¸‹æ–‡</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">exact_match</span><span class="p">;</span><span class="w">  </span><span class="c1">// æ˜¯å¦ç²¾ç¡®åŒ¹é…</span>
<span class="p">};</span>
</code></pre></div>

<p>ç³»ç»Ÿå±æ€§çš„é«˜çº§ç‰¹æ€§ï¼š</p>
<ul>
<li><strong>å…±äº«å†…å­˜å®ç°</strong>ï¼šé€šè¿‡<code>mmap</code>æ˜ å°„åˆ°æ‰€æœ‰è¿›ç¨‹ï¼Œé›¶æ‹·è´è®¿é—®</li>
<li><strong>Trieæ ‘ç´¢å¼•</strong>ï¼šæ”¯æŒå‰ç¼€æŸ¥è¯¢å’Œé€šé…ç¬¦åŒ¹é…</li>
<li><strong>ç‰ˆæœ¬æ§åˆ¶</strong>ï¼šé€šè¿‡<code>serial</code>å­—æ®µæ£€æµ‹å±æ€§å˜åŒ–ï¼Œé¿å…è½®è¯¢</li>
<li><strong>åˆ†åŒºå­˜å‚¨</strong>ï¼šä¸åŒå‰ç¼€çš„å±æ€§å­˜å‚¨åœ¨ç‹¬ç«‹çš„å†…å­˜åŒºåŸŸ</li>
<li><strong>è®¿é—®æ§åˆ¶</strong>ï¼šç»“åˆSELinuxå’ŒUIDæƒé™è¿›è¡Œç»†ç²’åº¦æ§åˆ¶</li>
</ul>
<p><strong>å‘½ä»¤ç®¡ç†å™¨ï¼ˆCommandManagerï¼‰</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BuiltinFunctionMap</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">BuiltinFunction</span><span class="o">&gt;</span><span class="w"> </span><span class="n">functions_</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æ³¨å†Œçš„å†…ç½®å‘½ä»¤</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">RegisterBuiltinFunctions</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// æ–‡ä»¶ç³»ç»Ÿæ“ä½œ</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;chmod&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_chmod</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;chown&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_chown</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;copy&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_copy</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;mkdir&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_mkdir</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;mount&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_mount</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;umount&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_umount</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;symlink&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_symlink</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;rm&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_rm</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;rmdir&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_rmdir</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;write&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_write</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// æœåŠ¡æ§åˆ¶</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;class_start&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_class_start</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;class_stop&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_class_stop</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;class_reset&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_class_reset</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;start&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_start</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;stop&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_stop</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;restart&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_restart</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;enable&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_enable</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// å±æ€§æ“ä½œ</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;setprop&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_setprop</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;getprop&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_getprop</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;wait_for_prop&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_wait_for_prop</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// è¿›ç¨‹æ‰§è¡Œ</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;exec&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_exec</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;exec_start&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_exec_start</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;exec_background&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_exec_background</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// è§¦å‘å™¨ç®¡ç†</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;trigger&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_trigger</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// ç³»ç»Ÿæ§åˆ¶</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;bootchart&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_bootchart</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;init_user0&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_init_user0</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;installkey&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_installkey</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;load_persist_props&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_load_persist_props</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// ç½‘ç»œé…ç½®</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;hostname&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_hostname</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;domainname&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_domainname</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;ifup&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_ifup</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// å®‰å…¨ç›¸å…³</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;restorecon&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_restorecon</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;restorecon_recursive&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_restorecon_recursive</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;setrlimit&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_setrlimit</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;swapon_all&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_swapon_all</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// æ—¥å¿—å’Œè°ƒè¯•</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;loglevel&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_loglevel</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;mark_post_data&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_mark_post_data</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// å‘½ä»¤æ‰§è¡ŒåŒ…è£…</span>
<span class="w">    </span><span class="n">Result</span><span class="o">&lt;</span><span class="n">Success</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Execute</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span>
<span class="w">                           </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">functions_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">functions_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Error</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Unknown command: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p>å‘½ä»¤ç³»ç»Ÿçš„è®¾è®¡ç‰¹ç‚¹ï¼š</p>
<ul>
<li><strong>æ¨¡å—åŒ–è®¾è®¡</strong>ï¼šæ¯ä¸ªå‘½ä»¤æ˜¯ç‹¬ç«‹çš„å‡½æ•°ï¼Œæ˜“äºæ‰©å±•</li>
<li><strong>é”™è¯¯å¤„ç†</strong>ï¼šä½¿ç”¨<code>Result&lt;T&gt;</code>ç±»å‹å®‰å…¨åœ°è¿”å›é”™è¯¯</li>
<li><strong>å‚æ•°éªŒè¯</strong>ï¼šæ¯ä¸ªå‘½ä»¤å‡½æ•°è´Ÿè´£éªŒè¯è‡ªå·±çš„å‚æ•°</li>
<li><strong>å¼‚æ­¥æ”¯æŒ</strong>ï¼š<code>exec_background</code>ç­‰å‘½ä»¤æ”¯æŒéé˜»å¡æ‰§è¡Œ</li>
</ul>
<h3 id="413">4.1.3 äº‹ä»¶å¾ªç¯æœºåˆ¶</h3>
<p>Initè¿›ç¨‹çš„ä¸»å¾ªç¯é‡‡ç”¨é«˜æ•ˆçš„epollæœºåˆ¶ï¼Œè¿™æ˜¯Androidç³»ç»Ÿå“åº”æ€§çš„åŸºç¡€ã€‚ä¸ä¼ ç»Ÿçš„select/pollç›¸æ¯”ï¼Œepollåœ¨å¤§é‡æ–‡ä»¶æè¿°ç¬¦åœºæ™¯ä¸‹æ€§èƒ½æ›´ä¼˜ï¼š</p>
<p><strong>äº‹ä»¶æºç±»å‹</strong>
Initè¿›ç¨‹ç›‘å¬çš„äº‹ä»¶æºåŒ…æ‹¬ï¼š</p>
<ul>
<li>å±æ€§è®¾ç½®è¯·æ±‚ï¼ˆé€šè¿‡UnixåŸŸå¥—æ¥å­—<code>/dev/socket/property_service</code>ï¼‰</li>
<li>å­è¿›ç¨‹é€€å‡ºä¿¡å·ï¼ˆé€šè¿‡signalfdå°†SIGCHLDè½¬æ¢ä¸ºæ–‡ä»¶æè¿°ç¬¦äº‹ä»¶ï¼‰</li>
<li>æ§åˆ¶å‘½ä»¤ï¼ˆé€šè¿‡<code>/dev/socket/init</code>æ¥æ”¶å¦‚<code>ctl.start</code>ç­‰å‘½ä»¤ï¼‰</li>
<li>å†…æ ¸æ¶ˆæ¯ï¼ˆé€šè¿‡netlinkå¥—æ¥å­—æ¥æ”¶ueventç­‰ï¼‰</li>
<li>çœ‹é—¨ç‹—å®šæ—¶å™¨ï¼ˆé˜²æ­¢initè¿›ç¨‹æŒ‚èµ·ï¼‰</li>
<li>keychordäº‹ä»¶ï¼ˆç»„åˆé”®è§¦å‘ç‰¹æ®ŠåŠ¨ä½œï¼‰</li>
</ul>
<p><strong>Epollæ¶æ„å®ç°</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Epoll</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">epoll_fd_</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">handlers_</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">Open</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// åˆ›å»ºepollå®ä¾‹ï¼ŒEPOLL_CLOEXECé˜²æ­¢fdæ³„éœ²åˆ°å­è¿›ç¨‹</span>
<span class="w">        </span><span class="n">epoll_fd_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">epoll_create1</span><span class="p">(</span><span class="n">EPOLL_CLOEXEC</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">epoll_fd_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">PLOG</span><span class="p">(</span><span class="n">FATAL</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;epoll_create1 failed&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// æ³¨å†Œä¿¡å·å¤„ç†ï¼ˆä½¿ç”¨signalfdï¼‰</span>
<span class="w">        </span><span class="kt">sigset_t</span><span class="w"> </span><span class="n">mask</span><span class="p">;</span>
<span class="w">        </span><span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">);</span>
<span class="w">        </span><span class="n">sigaddset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">SIGCHLD</span><span class="p">);</span>
<span class="w">        </span><span class="n">sigaddset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">SIGTERM</span><span class="p">);</span>
<span class="w">        </span><span class="n">signal_fd_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">signalfd</span><span class="p">(</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">SFD_CLOEXEC</span><span class="p">);</span>
<span class="w">        </span><span class="n">RegisterHandler</span><span class="p">(</span><span class="n">signal_fd_</span><span class="p">,</span><span class="w"> </span><span class="n">HandleSignals</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// æ³¨å†Œå±æ€§æœåŠ¡</span>
<span class="w">        </span><span class="n">property_fd_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreatePropertySocket</span><span class="p">();</span>
<span class="w">        </span><span class="n">RegisterHandler</span><span class="p">(</span><span class="n">property_fd_</span><span class="p">,</span><span class="w"> </span><span class="n">HandlePropertySet</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// æ³¨å†Œæ§åˆ¶æ¶ˆæ¯</span>
<span class="w">        </span><span class="n">init_fd_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateInitSocket</span><span class="p">();</span>
<span class="w">        </span><span class="n">RegisterHandler</span><span class="p">(</span><span class="n">init_fd_</span><span class="p">,</span><span class="w"> </span><span class="n">HandleInitSocket</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// æ³¨å†Œkeychordï¼ˆç»„åˆé”®ï¼‰</span>
<span class="w">        </span><span class="n">keychord_fd_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OpenKeychordDevice</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">keychord_fd_</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">RegisterHandler</span><span class="p">(</span><span class="n">keychord_fd_</span><span class="p">,</span><span class="w"> </span><span class="n">HandleKeychord</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">RegisterHandler</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="n">handler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">epoll_event</span><span class="w"> </span><span class="n">ev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">        </span><span class="n">ev</span><span class="p">.</span><span class="n">events</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EPOLLIN</span><span class="p">;</span><span class="w">  </span><span class="c1">// ç›‘å¬å¯è¯»äº‹ä»¶</span>
<span class="w">        </span><span class="n">ev</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">epoll_ctl</span><span class="p">(</span><span class="n">epoll_fd_</span><span class="p">,</span><span class="w"> </span><span class="n">EPOLL_CTL_ADD</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ev</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">PLOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Failed to add fd &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; to epoll&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">handlers_</span><span class="p">[</span><span class="n">fd</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">handler</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">Wait</span><span class="p">(</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="o">&gt;</span><span class="w"> </span><span class="n">timeout</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">epoll_event</span><span class="w"> </span><span class="n">events</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">timeout_ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timeout</span><span class="p">.</span><span class="n">has_value</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">timeout_ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timeout</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">nr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">epoll_wait</span><span class="p">(</span><span class="n">epoll_fd_</span><span class="p">,</span><span class="w"> </span><span class="n">events</span><span class="p">,</span><span class="w"> </span>
<span class="w">                           </span><span class="n">arraysize</span><span class="p">(</span><span class="n">events</span><span class="p">),</span><span class="w"> </span><span class="n">timeout_ms</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">PLOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;epoll_wait failed&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">nullopt</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nr</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">handlers_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">handlers_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">nullopt</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>ä¸»å¾ªç¯å®ç°</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ... åˆå§‹åŒ–ä»£ç  ...</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 1. æ‰§è¡Œå¾…å¤„ç†çš„Actions</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ActionQueue</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ActionQueue</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
<span class="w">            </span><span class="n">action</span><span class="o">-&gt;</span><span class="n">ExecuteOneCommand</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">action</span><span class="o">-&gt;</span><span class="n">IsCompleted</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">ActionQueue</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 2. æ£€æŸ¥éœ€è¦é‡å¯çš„æœåŠ¡</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ServiceList</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">service</span><span class="p">.</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SVC_RESTARTING</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CurrentTime</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">service</span><span class="p">.</span><span class="n">time_crashed</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                    </span><span class="n">service</span><span class="p">.</span><span class="n">restart_period</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">service</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 3. è®¡ç®—è¶…æ—¶æ—¶é—´</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w">  </span><span class="c1">// é»˜è®¤æ— é™ç­‰å¾…</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ActionQueue</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">// æœ‰å¾…å¤„ç†å‘½ä»¤ï¼Œç«‹å³è¿”å›</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">HasRestartingServices</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CalculateRestartTimeout</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 4. ç­‰å¾…äº‹ä»¶</span>
<span class="w">        </span><span class="n">epoll_event</span><span class="w"> </span><span class="n">events</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">nr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">epoll_wait</span><span class="p">(</span><span class="n">epoll_fd</span><span class="p">,</span><span class="w"> </span><span class="n">events</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="n">timeout</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 5. å¤„ç†äº‹ä»¶</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nr</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">handlers_</span><span class="p">[</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span><span class="p">];</span>
<span class="w">            </span><span class="n">handler</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>ä¿¡å·å¤„ç†æœºåˆ¶</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">HandleSignals</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">signalfd_siginfo</span><span class="w"> </span><span class="n">info</span><span class="p">;</span>
<span class="w">    </span><span class="n">read</span><span class="p">(</span><span class="n">signal_fd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">ssi_signo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">SIGCHLD</span><span class="p">:</span>
<span class="w">            </span><span class="n">ReapChildren</span><span class="p">();</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">SIGTERM</span><span class="p">:</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">SIGINT</span><span class="p">:</span>
<span class="w">            </span><span class="n">HandleShutdown</span><span class="p">();</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">SIGUSR1</span><span class="p">:</span>
<span class="w">            </span><span class="n">HandleBootchart</span><span class="p">();</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">ReapChildren</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<span class="w">        </span><span class="kt">pid_t</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">waitpid</span><span class="p">(</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">WNOHANG</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="n">Service</span><span class="o">*</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FindServiceByPid</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">service</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">service</span><span class="o">-&gt;</span><span class="n">Reap</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">service</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SVC_CRITICAL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// å…³é”®æœåŠ¡å´©æºƒï¼Œå¯èƒ½è§¦å‘é‡å¯</span>
<span class="w">                </span><span class="n">HandleCriticalCrash</span><span class="p">(</span><span class="n">service</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="414">4.1.4 ä¸å…¶ä»–ç³»ç»Ÿçš„å¯¹æ¯”</h3>
<p><strong>Linuxä¼ ç»Ÿinitï¼ˆSysV/systemdï¼‰</strong></p>
<p><em>SysV initç‰¹ç‚¹ï¼š</em></p>
<ul>
<li>åŸºäºè¿è¡Œçº§åˆ«ï¼ˆ0-6ï¼‰ï¼Œæ¯ä¸ªçº§åˆ«å¯¹åº”ä¸åŒçš„ç³»ç»ŸçŠ¶æ€</li>
<li>ä½¿ç”¨Shellè„šæœ¬ï¼ˆ/etc/init.d/ï¼‰ï¼Œä¸²è¡Œæ‰§è¡Œ</li>
<li>ç®€å•ä½†å¯åŠ¨é€Ÿåº¦æ…¢ï¼Œç¼ºä¹ä¾èµ–ç®¡ç†</li>
<li>é€šè¿‡<code>update-rc.d</code>æˆ–<code>chkconfig</code>ç®¡ç†æœåŠ¡</li>
</ul>
<p><em>systemdç‰¹ç‚¹ï¼š</em></p>
<ul>
<li>åŸºäºUnitæ–‡ä»¶ï¼ˆ.serviceã€.socketã€.targetç­‰ï¼‰</li>
<li>æ”¯æŒä¾èµ–å…³ç³»ï¼ˆRequiresã€Afterã€Beforeç­‰ï¼‰</li>
<li>å¹¶è¡Œå¯åŠ¨æœåŠ¡ï¼Œæ˜¾è‘—æå‡å¯åŠ¨é€Ÿåº¦</li>
<li>Socketæ¿€æ´»å’ŒD-Busæ¿€æ´»</li>
<li>å†…ç½®æ—¥å¿—ç³»ç»Ÿï¼ˆjournaldï¼‰</li>
<li>Cgroupé›†æˆï¼Œæ›´å¥½çš„èµ„æºç®¡ç†</li>
</ul>
<p><em>Android initå¯¹æ¯”ï¼š</em></p>
<ul>
<li>æ›´è½»é‡çº§ï¼Œä¸“ä¸ºåµŒå…¥å¼è®¾å¤‡ä¼˜åŒ–</li>
<li>RCè„šæœ¬æ¯”systemd unitæ›´ç®€å•</li>
<li>è§¦å‘å™¨æœºåˆ¶æ›´çµæ´»ï¼Œé€‚åˆåŠ¨æ€ç³»ç»ŸçŠ¶æ€</li>
<li>æ·±åº¦é›†æˆAndroidç‰¹æ€§ï¼ˆå±æ€§ç³»ç»Ÿã€SELinuxï¼‰</li>
</ul>
<p><strong>iOS launchd</strong></p>
<p><em>æ¶æ„ç‰¹ç‚¹ï¼š</em></p>
<ul>
<li>ç»Ÿä¸€çš„è¿›ç¨‹ç®¡ç†å™¨ï¼Œæ›¿ä»£äº†initã€inetdã€cronç­‰</li>
<li>ä½¿ç”¨XML plistæ–‡ä»¶å®šä¹‰æœåŠ¡</li>
<li>æ”¯æŒå¤šç§å¯åŠ¨æ¡ä»¶ï¼ˆRunAtLoadã€StartIntervalã€WatchPathsç­‰ï¼‰</li>
<li>XPCï¼ˆè·¨è¿›ç¨‹é€šä¿¡ï¼‰åŸç”Ÿæ”¯æŒ</li>
</ul>
<p><em>ä¸Android initå¯¹æ¯”ï¼š</em></p>
<div class="codehilite"><pre><span></span><code>iOS<span class="w"> </span>launchd<span class="w"> </span>plist:
<span class="nt">&lt;dict&gt;</span>
<span class="w">    </span><span class="nt">&lt;key&gt;</span>Label<span class="nt">&lt;/key&gt;</span>
<span class="w">    </span><span class="nt">&lt;string&gt;</span>com.apple.service<span class="nt">&lt;/string&gt;</span>
<span class="w">    </span><span class="nt">&lt;key&gt;</span>ProgramArguments<span class="nt">&lt;/key&gt;</span>
<span class="w">    </span><span class="nt">&lt;array&gt;</span>
<span class="w">        </span><span class="nt">&lt;string&gt;</span>/usr/bin/service<span class="nt">&lt;/string&gt;</span>
<span class="w">    </span><span class="nt">&lt;/array&gt;</span>
<span class="w">    </span><span class="nt">&lt;key&gt;</span>RunAtLoad<span class="nt">&lt;/key&gt;</span>
<span class="w">    </span><span class="nt">&lt;true/&gt;</span>
<span class="nt">&lt;/dict&gt;</span>

Android<span class="w"> </span>RC:
service<span class="w"> </span>apple_service<span class="w"> </span>/system/bin/service
<span class="w">    </span>class<span class="w"> </span>core
<span class="w">    </span>user<span class="w"> </span>system
<span class="w">    </span>group<span class="w"> </span>system
</code></pre></div>

<p><em>æƒé™æ¨¡å‹å·®å¼‚ï¼š</em></p>
<ul>
<li>iOSï¼šåŸºäºentitlementså’Œæ²™ç®±profile</li>
<li>Androidï¼šåŸºäºLinux UID/GIDå’ŒSELinux</li>
<li>iOSæ›´å°é—­ä½†æ›´å®‰å…¨ï¼ŒAndroidæ›´çµæ´»</li>
</ul>
<p><strong>é¸¿è’™OS init</strong></p>
<p><em>åˆ†å¸ƒå¼ç‰¹æ€§ï¼š</em></p>
<ul>
<li>æœåŠ¡å¯ä»¥è·¨è®¾å¤‡å¯åŠ¨å’Œè¿ç§»</li>
<li>åˆ†å¸ƒå¼è½¯æ€»çº¿æ”¯æŒ</li>
<li>èƒ½åŠ›ï¼ˆAbilityï¼‰æ¡†æ¶é›†æˆ</li>
<li>æ”¯æŒåŸå­åŒ–æœåŠ¡</li>
</ul>
<p><em>ä¸Androidå¯¹æ¯”ï¼š</em></p>
<ul>
<li>é¸¿è’™ï¼š<code>distributed_service</code>æ ‡ç­¾æ”¯æŒè·¨è®¾å¤‡</li>
<li>Androidï¼šä»…æ”¯æŒæœ¬åœ°æœåŠ¡ç®¡ç†</li>
<li>é¸¿è’™ï¼šå†…ç½®åˆ†å¸ƒå¼å®‰å…¨è®¤è¯</li>
<li>Androidï¼šéœ€è¦é¢å¤–å®ç°è·¨è®¾å¤‡é€šä¿¡</li>
</ul>
<p><em>é…ç½®æ–‡ä»¶å¯¹æ¯”ï¼š</em></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// é¸¿è’™æœåŠ¡é…ç½®</span>
<span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;services&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">        </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;distributed_service&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/system/bin/d_service&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;distributed&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;capability&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;ohos.permission.DISTRIBUTED_DATA&quot;</span><span class="p">],</span>
<span class="w">        </span><span class="nt">&quot;devices&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;phone&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;tablet&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;tv&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="p">}]</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="42-rc">4.2 RCè„šæœ¬ä¸ç³»ç»Ÿå±æ€§</h2>
<h3 id="421-rc">4.2.1 RCè„šæœ¬è¯­æ³•</h3>
<p>Android RCï¼ˆRun Commandsï¼‰è„šæœ¬é‡‡ç”¨è‡ªå®šä¹‰çš„é¢†åŸŸç‰¹å®šè¯­è¨€ï¼ˆDSLï¼‰ï¼Œä¸»è¦åŒ…å«å››ç§è¯­å¥ç±»å‹ï¼š</p>
<p><strong>Actionå®šä¹‰</strong></p>
<div class="codehilite"><pre><span></span><code>on &lt;trigger&gt; [&amp;&amp; &lt;trigger&gt;]*
    &lt;command&gt;
    &lt;command&gt;
    ...
</code></pre></div>

<p><strong>å®Œæ•´çš„Actionç¤ºä¾‹</strong></p>
<div class="codehilite"><pre><span></span><code>#<span class="w"> </span>æ—©æœŸåˆå§‹åŒ–
on<span class="w"> </span>early-init
<span class="w">    </span>start<span class="w"> </span>ueventd
<span class="w">    </span>mkdir<span class="w"> </span>/mnt/vendor/persist<span class="w"> </span>0771<span class="w"> </span>root<span class="w"> </span>system

#<span class="w"> </span>å±æ€§è§¦å‘å™¨
on<span class="w"> </span>property:sys.boot_completed=1
<span class="w">    </span>setprop<span class="w"> </span>sys.runtime.firstboot.end<span class="w"> </span><span class="cp">${</span><span class="n">ro</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">firstboot</span><span class="o">.</span><span class="n">end</span><span class="cp">}</span>
<span class="w">    </span>exec_background<span class="w"> </span>-<span class="w"> </span>system<span class="w"> </span>system<span class="w"> </span>--<span class="w"> </span>/system/bin/bootstat<span class="w"> </span>--record_boot_complete

#<span class="w"> </span>å¤šæ¡ä»¶è§¦å‘å™¨
on<span class="w"> </span>property:vold.decrypt=trigger_restart_framework<span class="w"> </span><span class="err">&amp;&amp;</span><span class="w"> </span>property:ro.crypto.type=file
<span class="w">    </span>class_start<span class="w"> </span>main
<span class="w">    </span>class_start<span class="w"> </span>late_start
</code></pre></div>

<p><strong>Serviceå®šä¹‰</strong></p>
<div class="codehilite"><pre><span></span><code>service &lt;name&gt; &lt;pathname&gt; [ &lt;argument&gt; ]*
    &lt;option&gt;
    &lt;option&gt;
    ...
</code></pre></div>

<p><strong>å®Œæ•´çš„Serviceç¤ºä¾‹</strong></p>
<div class="codehilite"><pre><span></span><code><span class="gh">#</span> åŸºç¡€æœåŠ¡ç¤ºä¾‹
service servicemanager /system/bin/servicemanager
    class core animation
    user system
    group system readproc
    critical
    onrestart restart apexd
    onrestart restart audioserver
    onrestart restart gatekeeperd
    onrestart class_restart main
    writepid /dev/cpuset/system-background/tasks

<span class="gh">#</span> å‚å•†æœåŠ¡ç¤ºä¾‹ï¼ˆå°ç±³ï¼‰
service mi_thermald /system/bin/mi_thermald
    class main
    user system
    group system
    capabilities SYS_NICE NET_ADMIN
    socket mi_thermald stream 0660 system system
</code></pre></div>

<p><strong>Importè¯­å¥</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># é™æ€å¯¼å…¥</span>
<span class="kn">import</span> <span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="err">$</span><span class="p">{</span><span class="n">ro</span><span class="o">.</span><span class="n">hardware</span><span class="p">}</span><span class="o">.</span><span class="n">rc</span>
<span class="kn">import</span> <span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">/</span><span class="n">hw</span><span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="err">$</span><span class="p">{</span><span class="n">ro</span><span class="o">.</span><span class="n">hardware</span><span class="p">}</span><span class="o">.</span><span class="n">rc</span>
<span class="kn">import</span> <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">/</span><span class="n">hw</span><span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="err">$</span><span class="p">{</span><span class="n">ro</span><span class="o">.</span><span class="n">zygote</span><span class="p">}</span><span class="o">.</span><span class="n">rc</span>

<span class="c1"># åŠ¨æ€å¯¼å…¥ï¼ˆåŸºäºå±æ€§ï¼‰</span>
<span class="kn">import</span> <span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="n">recovery</span><span class="o">.</span><span class="err">$</span><span class="p">{</span><span class="n">ro</span><span class="o">.</span><span class="n">hardware</span><span class="p">}</span><span class="o">.</span><span class="n">rc</span>
</code></pre></div>

<p><strong>è§¦å‘å™¨ç±»å‹è¯¦è§£</strong></p>
<p><em>å¯åŠ¨é˜¶æ®µè§¦å‘å™¨ï¼š</em></p>
<ul>
<li><code>early-init</code>ï¼šæœ€æ—©çš„åˆå§‹åŒ–é˜¶æ®µï¼ŒSELinuxå°šæœªåŠ è½½</li>
<li><code>init</code>ï¼šåŸºç¡€æ–‡ä»¶ç³»ç»Ÿå·²æŒ‚è½½</li>
<li><code>late-init</code>ï¼šæ‰€æœ‰init.*è§¦å‘å™¨å®Œæˆå</li>
<li><code>boot</code>ï¼š/dataåˆ†åŒºå·²æŒ‚è½½ï¼ŒåŠ å¯†çŠ¶æ€ç¡®å®š</li>
<li><code>post-fs</code>ï¼š/systemæŒ‚è½½åç«‹å³æ‰§è¡Œ</li>
<li><code>post-fs-data</code>ï¼š/dataæŒ‚è½½å¹¶è§£å¯†åæ‰§è¡Œ</li>
<li><code>zygote-start</code>ï¼šåœ¨å¯åŠ¨zygoteå‰æ‰§è¡Œ</li>
<li><code>early-boot</code>ï¼šbootå®Œæˆåçš„æ—©æœŸé˜¶æ®µ</li>
<li><code>charger</code>ï¼šå……ç”µæ¨¡å¼ä¸‹çš„ç‰¹æ®Šè§¦å‘å™¨</li>
</ul>
<p><em>å±æ€§è§¦å‘å™¨ï¼š</em></p>
<div class="codehilite"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nx">ç²¾ç¡®åŒ¹é…</span>
<span class="nx">on</span><span class="w"> </span><span class="nx">property</span><span class="p">:</span><span class="nx">persist</span><span class="p">.</span><span class="nx">sys</span><span class="p">.</span><span class="nx">language</span><span class="p">=</span><span class="nx">zh</span><span class="o">-</span><span class="nx">CN</span>
<span class="w">    </span><span class="nx">setprop</span><span class="w"> </span><span class="nx">persist</span><span class="p">.</span><span class="nx">sys</span><span class="p">.</span><span class="nx">locale</span><span class="w"> </span><span class="nx">zh</span><span class="o">-</span><span class="nx">CN</span>

<span class="err">#</span><span class="w"> </span><span class="nx">é€šé…ç¬¦åŒ¹é…</span>
<span class="nx">on</span><span class="w"> </span><span class="nx">property</span><span class="p">:</span><span class="nx">sys</span><span class="p">.</span><span class="nx">boot_from_charger_mode</span><span class="p">=</span><span class="mi">1</span>
<span class="w">    </span><span class="nx">trigger</span><span class="w"> </span><span class="nx">late</span><span class="o">-</span><span class="nx">init</span>

<span class="err">#</span><span class="w"> </span><span class="nx">å¤šå±æ€§ç»„åˆ</span>
<span class="nx">on</span><span class="w"> </span><span class="nx">property</span><span class="p">:</span><span class="nx">ro</span><span class="p">.</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">state</span><span class="p">=</span><span class="nx">encrypted</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">property</span><span class="p">:</span><span class="nx">ro</span><span class="p">.</span><span class="nx">crypto</span><span class="p">.</span><span class="k">type</span><span class="p">=</span><span class="nx">file</span>
<span class="w">    </span><span class="nx">start</span><span class="w"> </span><span class="nx">vold_decrypt</span>
</code></pre></div>

<p><em>è‡ªå®šä¹‰è§¦å‘å™¨ï¼š</em></p>
<div class="codehilite"><pre><span></span><code># å®šä¹‰è§¦å‘å™¨
on enable-logging
    start logd
    start logd-reinit

# è§¦å‘è‡ªå®šä¹‰è§¦å‘å™¨
on boot
    trigger enable-logging
</code></pre></div>

<h3 id="422-rc">4.2.2 RCè„šæœ¬è§£æå™¨</h3>
<p>Initè¿›ç¨‹ä½¿ç”¨<code>ActionParser</code>ã€<code>ServiceParser</code>ç­‰ç±»è§£æRCæ–‡ä»¶ï¼š</p>
<p><strong>è§£æå™¨æ¶æ„</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Parser</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">SectionParser</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">parsers_</span><span class="p">;</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">AddSectionParser</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span>
<span class="w">                         </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">SectionParser</span><span class="o">&gt;</span><span class="w"> </span><span class="n">parser</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">parsers_</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">parser</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">ParseData</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Tokenizer</span><span class="w"> </span><span class="n">tokenizer</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">tokenizer</span><span class="p">.</span><span class="n">HasMore</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">tokens</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokenizer</span><span class="p">.</span><span class="n">GetLine</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IsSectionStart</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">current_parser_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parsers_</span><span class="p">[</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">current_parser_</span><span class="o">-&gt;</span><span class="n">ParseLine</span><span class="p">(</span><span class="n">tokens</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>è§£ææµç¨‹</strong></p>
<ol>
<li><strong>è¯æ³•åˆ†æï¼ˆTokenizerï¼‰</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// å°†æ–‡æœ¬åˆ†è§£ä¸ºTokenï¼Œå¤„ç†å¼•å·ã€è½¬ä¹‰å­—ç¬¦</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Tokenizer</span><span class="o">::</span><span class="n">GetLine</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// è·³è¿‡ç©ºç™½å’Œæ³¨é‡Š</span>
<span class="w">    </span><span class="n">SkipWhitespace</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;#&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">SkipToNextLine</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// è§£ætoken</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">IsEndOfLine</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;&quot;&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">tokens</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ParseQuotedString</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">tokens</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ParseWord</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<ol start="2">
<li><strong>è¯­æ³•åˆ†æï¼ˆParserï¼‰</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ActionParser</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">SectionParser</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">ParseSection</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// &quot;on&quot; &lt;trigger&gt; [&amp;&amp; &lt;trigger&gt;]*</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">Action</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&amp;&amp;&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">            </span><span class="n">action</span><span class="o">-&gt;</span><span class="n">AddTrigger</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">ParseLine</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// è§£æå‘½ä»¤</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Command</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
<span class="w">        </span><span class="n">current_action_</span><span class="o">-&gt;</span><span class="n">AddCommand</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<ol start="3">
<li><strong>è¯­ä¹‰æ£€æŸ¥</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kt">bool</span><span class="w"> </span><span class="nf">Service::ParseLine</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">OptionParserMap</span><span class="w"> </span><span class="n">option_parsers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;class&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ParseClass</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ParseUser</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;group&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ParseGroup</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;capabilities&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ParseCapabilities</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;seclabel&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ParseSeclabel</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;oneshot&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ParseOneshot</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;disabled&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ParseDisabled</span><span class="p">},</span>
<span class="w">        </span><span class="c1">// ... æ›´å¤šé€‰é¡¹</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">parser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">option_parsers</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parser</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">option_parsers</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Error</span><span class="p">(</span><span class="s">&quot;Invalid option: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">parser</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<ol start="4">
<li><strong>å˜é‡æ›¿æ¢å’Œæ¡ä»¶å¤„ç†</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// å±æ€§å€¼æ›¿æ¢</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="nf">ExpandProps</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">src</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ${property_name} -&gt; property_value</span>
<span class="w">    </span><span class="c1">// ${property_name:-default} -&gt; å¸¦é»˜è®¤å€¼</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">regex</span><span class="w"> </span><span class="n">prop_regex</span><span class="p">(</span><span class="sa">R</span><span class="s">&quot;</span><span class="dl">(</span><span class="s">\$\{([^}]+)\}</span><span class="dl">)</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">regex_replace</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">prop_regex</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="p">[](</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">smatch</span><span class="o">&amp;</span><span class="w"> </span><span class="n">match</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">GetProperty</span><span class="p">(</span><span class="n">match</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">str</span><span class="p">());</span>
<span class="w">        </span><span class="p">});</span>
<span class="p">}</span>

<span class="c1">// æ¡ä»¶å¯¼å…¥</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="o">::</span><span class="n">base</span><span class="o">::</span><span class="n">GetBoolProperty</span><span class="p">(</span><span class="s">&quot;ro.debuggable&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ParseConfig</span><span class="p">(</span><span class="s">&quot;/system/etc/init/debug.rc&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>è§£æä¼˜åŒ–</strong></p>
<ul>
<li>é¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶æ ¼å¼ï¼ˆ.rcbæ–‡ä»¶ï¼‰</li>
<li>ç¼“å­˜è§£æç»“æœé¿å…é‡å¤è§£æ</li>
<li>å¹¶è¡Œè§£æå¤šä¸ªRCæ–‡ä»¶</li>
<li>å¢é‡è§£ææ”¯æŒåŠ¨æ€åŠ è½½</li>
</ul>
<h3 id="423">4.2.3 ç³»ç»Ÿå±æ€§æœåŠ¡</h3>
<p>Androidçš„Property Serviceæä¾›äº†ä¸€ä¸ªå…¨å±€çš„é”®å€¼å¯¹å­˜å‚¨ç³»ç»Ÿï¼š</p>
<p><strong>å±æ€§åˆ†ç±»</strong></p>
<ul>
<li><code>ro.*</code>ï¼šåªè¯»å±æ€§ï¼Œå¯åŠ¨åä¸å¯ä¿®æ”¹</li>
<li><code>persist.*</code>ï¼šæŒä¹…åŒ–å±æ€§ï¼Œé‡å¯åä¿ç•™</li>
<li><code>sys.*</code>ï¼šç³»ç»Ÿæ§åˆ¶å±æ€§</li>
<li><code>debug.*</code>ï¼šè°ƒè¯•å±æ€§</li>
</ul>
<p><strong>å®ç°æœºåˆ¶</strong></p>
<ol>
<li>å±æ€§å­˜å‚¨åœ¨å…±äº«å†…å­˜åŒºåŸŸï¼ˆ<code>/dev/__properties__</code>ï¼‰</li>
<li>é€šè¿‡UnixåŸŸå¥—æ¥å­—<code>/dev/socket/property_service</code>æ¥æ”¶è®¾ç½®è¯·æ±‚</li>
<li>Initè¿›ç¨‹éªŒè¯æƒé™åæ›´æ–°å…±äº«å†…å­˜</li>
<li>é€šè¿‡<code>property_changed</code>è§¦å‘å™¨é€šçŸ¥ç›‘å¬è€…</li>
</ol>
<p><strong>è®¿é—®æ§åˆ¶</strong></p>
<ul>
<li>SELinuxä¸Šä¸‹æ–‡æ£€æŸ¥</li>
<li>UID/GIDæƒé™éªŒè¯</li>
<li>å±æ€§å‰ç¼€ç™½åå•</li>
</ul>
<h3 id="424">4.2.4 å‚å•†å®šåˆ¶æ‰©å±•</h3>
<p>å„å‚å•†åœ¨RCè„šæœ¬ä¸­æ·»åŠ äº†å¤§é‡å®šåˆ¶ï¼š</p>
<p><strong>å°ç±³MIUI</strong></p>
<ul>
<li>æ·»åŠ <code>on property:ro.miui.version</code>è§¦å‘å™¨</li>
<li>è‡ªå®šä¹‰<code>mi_thermald</code>æ¸©æ§æœåŠ¡</li>
<li>æ‰©å±•<code>persist.sys.miui.*</code>å±æ€§æ—</li>
</ul>
<p><strong>OPPO ColorOS</strong></p>
<ul>
<li><code>oplus_init</code>é˜¶æ®µç”¨äºå‚å•†æœåŠ¡åˆå§‹åŒ–</li>
<li>è‡ªå®šä¹‰<code>oplusreserve</code>åˆ†åŒºæŒ‚è½½</li>
<li>AIè°ƒåº¦ç›¸å…³å±æ€§é…ç½®</li>
</ul>
<p><strong>åä¸ºEMUI</strong></p>
<ul>
<li><code>hw_init</code>è§¦å‘å™¨æ—</li>
<li>åˆ†å¸ƒå¼èƒ½åŠ›ç›¸å…³æœåŠ¡é…ç½®</li>
<li>å®‰å…¨å¢å¼ºå±æ€§è®¾ç½®</li>
</ul>
<h2 id="43-selinux">4.3 SELinuxç­–ç•¥åŠ è½½</h2>
<h3 id="431-androidselinux">4.3.1 Androidä¸­çš„SELinux</h3>
<p>SELinuxï¼ˆSecurity-Enhanced Linuxï¼‰ä¸ºAndroidæä¾›äº†å¼ºåˆ¶è®¿é—®æ§åˆ¶ï¼ˆMACï¼‰æœºåˆ¶ã€‚ä¸ä¼ ç»ŸLinuxå‘è¡Œç‰ˆä¸åŒï¼ŒAndroidå¯¹SELinuxè¿›è¡Œäº†æ·±åº¦å®šåˆ¶ï¼š</p>
<p><strong>Android SELinuxç‰¹ç‚¹</strong></p>
<ul>
<li>ç²¾ç®€çš„ç­–ç•¥é›†ï¼Œä¸“æ³¨äºåº”ç”¨éš”ç¦»</li>
<li>ä¸UID/GIDæƒé™æ¨¡å‹ååŒå·¥ä½œ</li>
<li>æ”¯æŒåŠ¨æ€ç­–ç•¥æ›´æ–°ï¼ˆéƒ¨åˆ†åœºæ™¯ï¼‰</li>
<li>å‚å•†å¯æ‰©å±•çš„ç­–ç•¥æ¡†æ¶</li>
</ul>
<p><strong>ç­–ç•¥ç»„æˆ</strong></p>
<ol>
<li><strong>å¹³å°ç­–ç•¥</strong>ï¼ˆPlatform Policyï¼‰ï¼šAOSPæä¾›çš„åŸºç¡€ç­–ç•¥</li>
<li><strong>å‚å•†ç­–ç•¥</strong>ï¼ˆVendor Policyï¼‰ï¼šè®¾å¤‡åˆ¶é€ å•†æ·»åŠ çš„ç­–ç•¥</li>
<li><strong>ODMç­–ç•¥</strong>ï¼ˆODM Policyï¼‰ï¼šè®¾å¤‡å®šåˆ¶å•†çš„ç­–ç•¥</li>
</ol>
<h3 id="432">4.3.2 ç­–ç•¥åŠ è½½æµç¨‹</h3>
<p>Initè¿›ç¨‹è´Ÿè´£åœ¨å¯åŠ¨æ—©æœŸåŠ è½½SELinuxç­–ç•¥ï¼š</p>
<p><strong>First Stage Initä¸­çš„åŠ è½½</strong></p>
<div class="codehilite"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">æ£€æŸ¥å†…æ ¸æ˜¯å¦æ”¯æŒSELinux</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">ä»</span><span class="o">/</span><span class="kr">sys</span><span class="n">tem</span><span class="err">ã€</span><span class="o">/</span><span class="n">vendorç­‰åˆ†åŒºè¯»å–ç­–ç•¥æ–‡ä»¶</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">ç¼–è¯‘å¹¶åŠ è½½åˆ°å†…æ ¸</span>
<span class="mf">4.</span><span class="w"> </span><span class="n">è®¾ç½®enforcingæ¨¡å¼</span>
</code></pre></div>

<p><strong>å…³é”®å‡½æ•°è°ƒç”¨é“¾</strong></p>
<ul>
<li><code>SelinuxInitialize()</code> â†’ <code>LoadPolicy()</code> â†’ <code>security_load_policy()</code></li>
<li>ç­–ç•¥æ–‡ä»¶ä½ç½®ï¼š<code>/system/etc/selinux/</code>, <code>/vendor/etc/selinux/</code></li>
</ul>
<p><strong>ç­–ç•¥ç¼–è¯‘è¿‡ç¨‹</strong></p>
<ol>
<li>è¯»å–å¤šä¸ªCILï¼ˆCommon Intermediate Languageï¼‰æ–‡ä»¶</li>
<li>ä½¿ç”¨<code>libsepol</code>åˆå¹¶ç­–ç•¥</li>
<li>ç¼–è¯‘ä¸ºäºŒè¿›åˆ¶æ ¼å¼</li>
<li>é€šè¿‡<code>/sys/fs/selinux/load</code>åŠ è½½åˆ°å†…æ ¸</li>
</ol>
<h3 id="433">4.3.3 ä¸Šä¸‹æ–‡ç®¡ç†</h3>
<p>SELinuxä¸Šä¸‹æ–‡æ ¼å¼ï¼š<code>user:role:type:sensitivity[:categories]</code></p>
<p><strong>Initè¿›ç¨‹çš„ä¸Šä¸‹æ–‡è½¬æ¢</strong></p>
<ul>
<li>åˆå§‹ä¸Šä¸‹æ–‡ï¼š<code>u:r:kernel:s0</code></li>
<li>First Stageï¼š<code>u:r:init:s0</code></li>
<li>Second Stageï¼šæ ¹æ®æœåŠ¡å®šä¹‰åˆ‡æ¢</li>
</ul>
<p><strong>æ–‡ä»¶ä¸Šä¸‹æ–‡æ¢å¤</strong>
Initè¿›ç¨‹ä½¿ç”¨<code>restorecon</code>æ¢å¤æ–‡ä»¶çš„SELinuxæ ‡ç­¾ï¼š</p>
<ul>
<li><code>/file_contexts</code>å®šä¹‰æ–‡ä»¶æ ‡ç­¾è§„åˆ™</li>
<li>é€’å½’æ¢å¤å…³é”®ç›®å½•ï¼ˆ/dataã€/cacheç­‰ï¼‰</li>
<li>æ”¯æŒå¢é‡æ¢å¤ä¼˜åŒ–æ€§èƒ½</li>
</ul>
<h3 id="434">4.3.4 ä¸å…¶ä»–å®‰å…¨æœºåˆ¶å¯¹æ¯”</h3>
<p><strong>iOSæ²™ç®±</strong></p>
<ul>
<li>åŸºäºBSDçš„MACæ¡†æ¶</li>
<li>ä»¥Appä¸ºä¸­å¿ƒçš„éš”ç¦»æ¨¡å‹</li>
<li>æ›´ä¸¥æ ¼çš„è¿›ç¨‹é—´é€šä¿¡é™åˆ¶</li>
<li>æ— éœ€æ˜¾å¼ç­–ç•¥é…ç½®</li>
</ul>
<p><strong>é¸¿è’™å®‰å…¨æ¶æ„</strong></p>
<ul>
<li>åˆ†å¸ƒå¼å®‰å…¨èƒ½åŠ›è®¤è¯</li>
<li>åŸºäºæ ‡ç­¾çš„è®¿é—®æ§åˆ¶</li>
<li>è·¨è®¾å¤‡å®‰å…¨ç­–ç•¥åŒæ­¥</li>
<li>AIé©±åŠ¨çš„åŠ¨æ€æƒé™è°ƒæ•´</li>
</ul>
<p><strong>Linux AppArmor</strong></p>
<ul>
<li>è·¯å¾„åŸºç¡€çš„è®¿é—®æ§åˆ¶</li>
<li>æ›´ç®€å•çš„ç­–ç•¥è¯­æ³•</li>
<li>è¾ƒä½çš„æ€§èƒ½å¼€é”€</li>
<li>æ›´é€‚åˆæ¡Œé¢ç¯å¢ƒ</li>
</ul>
<h2 id="44">4.4 æ—©æœŸå¯åŠ¨ä¼˜åŒ–æŠ€æœ¯</h2>
<h3 id="441">4.4.1 å¹¶è¡ŒåŒ–å¯åŠ¨</h3>
<p>Androidé€šè¿‡å¤šç§æŠ€æœ¯å®ç°æœåŠ¡çš„å¹¶è¡Œå¯åŠ¨ï¼š</p>
<p><strong>å¼‚æ­¥æœåŠ¡å¯åŠ¨</strong></p>
<ul>
<li>ä½¿ç”¨<code>class_start</code>æ‰¹é‡å¯åŠ¨åŒç±»æœåŠ¡</li>
<li>éå…³é”®æœåŠ¡å»¶è¿Ÿåˆ°<code>late_init</code>é˜¶æ®µ</li>
<li>åˆ©ç”¨å¤šæ ¸CPUå¹¶è¡Œåˆå§‹åŒ–</li>
</ul>
<p><strong>ä¾èµ–ç®¡ç†ä¼˜åŒ–</strong></p>
<div class="codehilite"><pre><span></span><code>service critical_service /system/bin/critical
    class core
    priority -20

service normal_service /system/bin/normal
    class late_start
    after critical_service
</code></pre></div>

<h3 id="442">4.4.2 å…³é”®è·¯å¾„ä¼˜åŒ–</h3>
<p><strong>I/Oä¼˜åŒ–</strong></p>
<ul>
<li>é¢„è¯»å–ï¼ˆreadaheadï¼‰å…³é”®æ–‡ä»¶</li>
<li>åˆå¹¶å°æ–‡ä»¶è¯»å–è¯·æ±‚</li>
<li>ä½¿ç”¨<code>mmap</code>å‡å°‘å†…å­˜æ‹·è´</li>
</ul>
<p><strong>å†…å­˜ä¼˜åŒ–</strong></p>
<ul>
<li>å»¶è¿Ÿéå¿…è¦çš„å†…å­˜åˆ†é…</li>
<li>å…±äº«åªè¯»æ•°æ®æ®µ</li>
<li>ä¼˜åŒ–RCè„šæœ¬è§£æç¼“å­˜</li>
</ul>
<p><strong>CPUè°ƒåº¦ä¼˜åŒ–</strong></p>
<ul>
<li>å…³é”®æœåŠ¡ä½¿ç”¨å®æ—¶è°ƒåº¦ç­–ç•¥</li>
<li>CPUäº²å’Œæ€§è®¾ç½®</li>
<li>å¤§å°æ ¸è°ƒåº¦ä¼˜åŒ–</li>
</ul>
<h3 id="443">4.4.3 å‚å•†ä¼˜åŒ–æ¡ˆä¾‹</h3>
<p><strong>é«˜é€šQuick Boot</strong></p>
<ul>
<li>ä¿å­˜å†…å­˜å¿«ç…§åˆ°UFS/eMMC</li>
<li>è·³è¿‡éƒ¨åˆ†ç¡¬ä»¶åˆå§‹åŒ–</li>
<li>ç¼©çŸ­åˆ°2-3ç§’å†·å¯åŠ¨</li>
</ul>
<p><strong>è”å‘ç§‘Fast Boot</strong></p>
<ul>
<li>ç¡¬ä»¶çº§å¯åŠ¨åŠ é€Ÿ</li>
<li>å¹¶è¡ŒåŒ–å¤–è®¾åˆå§‹åŒ–</li>
<li>é¢„ç¼–è¯‘RCè„šæœ¬ç¼“å­˜</li>
</ul>
<p><strong>ä¸‰æ˜Ÿä¼˜åŒ–</strong></p>
<ul>
<li>è‡ªå®šä¹‰<code>samsung_init</code>é˜¶æ®µ</li>
<li>AIé¢„æµ‹æœåŠ¡å¯åŠ¨é¡ºåº</li>
<li>åŠ¨æ€è°ƒæ•´å¯åŠ¨ä¼˜å…ˆçº§</li>
</ul>
<h3 id="444">4.4.4 å¯åŠ¨æ—¶é—´åˆ†æå·¥å…·</h3>
<p><strong>bootchart</strong></p>
<ul>
<li>è®°å½•å¯åŠ¨è¿‡ç¨‹çš„ç³»ç»ŸçŠ¶æ€</li>
<li>ç”Ÿæˆå¯è§†åŒ–æ—¶é—´çº¿å›¾</li>
<li>è¯†åˆ«å¯åŠ¨ç“¶é¢ˆ</li>
</ul>
<p><strong>systrace</strong></p>
<ul>
<li>æ›´ç»†ç²’åº¦çš„æ€§èƒ½åˆ†æ</li>
<li>æ”¯æŒè‡ªå®šä¹‰è¿½è¸ªç‚¹</li>
<li>ä¸Chromeè¿½è¸ªå·¥å…·é›†æˆ</li>
</ul>
<p><strong>å‚å•†å·¥å…·</strong></p>
<ul>
<li>MIUIï¼š<code>miui_boottime_analyzer</code></li>
<li>ColorOSï¼š<code>oplus_boot_tracker</code></li>
<li>EMUIï¼š<code>hw_bootprof</code></li>
</ul>
<h2 id="_1">æœ¬ç« å°ç»“</h2>
<p>æœ¬ç« æ·±å…¥å‰–æäº†Android Initè¿›ç¨‹çš„æ ¸å¿ƒæœºåˆ¶ï¼š</p>
<ol>
<li><strong>Initè¿›ç¨‹æ¶æ„</strong>ï¼šä¸¤é˜¶æ®µå¯åŠ¨æ¨¡å‹ï¼Œäº‹ä»¶é©±åŠ¨çš„ä¸»å¾ªç¯ï¼Œä¸Linux/iOS/é¸¿è’™çš„è®¾è®¡å¯¹æ¯”</li>
<li><strong>RCè„šæœ¬ç³»ç»Ÿ</strong>ï¼šDSLè¯­æ³•è®¾è®¡ï¼Œè§¦å‘å™¨æœºåˆ¶ï¼Œè§£æå™¨å®ç°ï¼Œå‚å•†æ‰©å±•æ–¹æ¡ˆ</li>
<li><strong>å±æ€§æœåŠ¡</strong>ï¼šå…±äº«å†…å­˜å®ç°ï¼Œæƒé™æ§åˆ¶æ¨¡å‹ï¼Œå±æ€§åˆ†ç±»ä¸æŒä¹…åŒ–</li>
<li><strong>SELinuxé›†æˆ</strong>ï¼šç­–ç•¥åŠ è½½æµç¨‹ï¼Œä¸Šä¸‹æ–‡ç®¡ç†ï¼Œä¸å…¶ä»–MACæœºåˆ¶å¯¹æ¯”</li>
<li><strong>å¯åŠ¨ä¼˜åŒ–</strong>ï¼šå¹¶è¡ŒåŒ–æŠ€æœ¯ï¼ŒI/O/å†…å­˜/CPUä¼˜åŒ–ï¼Œå‚å•†å®šåˆ¶æ–¹æ¡ˆï¼Œæ€§èƒ½åˆ†æå·¥å…·</li>
</ol>
<p>å…³é”®è¦ç‚¹ï¼š</p>
<ul>
<li>Initè¿›ç¨‹çš„äº‹ä»¶é©±åŠ¨æ¶æ„ä½¿å¾—Androidå¯åŠ¨æ›´åŠ çµæ´»å¯æ§</li>
<li>RCè„šæœ¬çš„è§¦å‘å™¨æœºåˆ¶æ”¯æŒå¤æ‚çš„å¯åŠ¨ä¾èµ–ç®¡ç†</li>
<li>å±æ€§ç³»ç»Ÿæä¾›äº†è½»é‡çº§çš„è·¨è¿›ç¨‹é…ç½®å…±äº«</li>
<li>SELinuxçš„æ—©æœŸåŠ è½½ç¡®ä¿äº†ç³»ç»Ÿå®‰å…¨æ€§</li>
<li>å„å‚å•†é€šè¿‡æ·±åº¦ä¼˜åŒ–å°†å¯åŠ¨æ—¶é—´å‹ç¼©åˆ°ç§’çº§</li>
</ul>
<h2 id="_2">ç»ƒä¹ é¢˜</h2>
<h3 id="_3">åŸºç¡€é¢˜</h3>
<ol>
<li><strong>Initè¿›ç¨‹çš„PIDä¸ºä»€ä¹ˆå¿…é¡»æ˜¯1ï¼Ÿ</strong></li>
</ol>
<details>
<summary>æç¤ºï¼šè€ƒè™‘å­¤å„¿è¿›ç¨‹çš„å¤„ç†æœºåˆ¶</summary>
<p>ç­”æ¡ˆï¼šåœ¨Unix/Linuxç³»ç»Ÿä¸­ï¼ŒPID 1çš„è¿›ç¨‹æœ‰ç‰¹æ®ŠèŒè´£ï¼š</p>
<ul>
<li>æˆä¸ºæ‰€æœ‰å­¤å„¿è¿›ç¨‹çš„çˆ¶è¿›ç¨‹</li>
<li>è´Ÿè´£å›æ”¶åƒµå°¸è¿›ç¨‹</li>
<li>ç³»ç»Ÿå…³æœºæ—¶æœ€åè¢«ç»ˆæ­¢</li>
<li>å†…æ ¸ä¼šç¡®ä¿PID 1è¿›ç¨‹ä¸ä¼šæ„å¤–é€€å‡º</li>
</ul>
</details>
<ol start="2">
<li><strong>è§£é‡ŠAndroidå±æ€§çš„å‘½åè§„åˆ™å’Œè®¿é—®æƒé™æœºåˆ¶</strong></li>
</ol>
<details>
<summary>æç¤ºï¼šå…³æ³¨å±æ€§å‰ç¼€çš„å«ä¹‰</summary>
<p>ç­”æ¡ˆï¼š</p>
<ul>
<li><code>ro.*</code>ï¼šåªè¯»å±æ€§ï¼Œå¯åŠ¨æ—¶è®¾ç½®åä¸å¯ä¿®æ”¹</li>
<li><code>persist.*</code>ï¼šæŒä¹…åŒ–åˆ°<code>/data/property</code>ï¼Œé‡å¯ä¿ç•™</li>
<li><code>sys.*</code>ï¼šç³»ç»Ÿæ§åˆ¶å±æ€§ï¼Œé€šå¸¸è§¦å‘ç³»ç»Ÿè¡Œä¸º</li>
<li><code>debug.*</code>ï¼šè°ƒè¯•å±æ€§ï¼Œç”Ÿäº§ç‰ˆæœ¬å¯èƒ½è¢«å¿½ç•¥</li>
<li>è®¿é—®æƒé™é€šè¿‡SELinuxå’ŒUID/GIDæ§åˆ¶</li>
<li>å±æ€§è®¾ç½®éœ€è¦é€šè¿‡property_serviceéªŒè¯</li>
</ul>
</details>
<ol start="3">
<li><strong>RCè„šæœ¬ä¸­çš„<code>class</code>å’Œ<code>disabled</code>é€‰é¡¹æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ</strong></li>
</ol>
<details>
<summary>æç¤ºï¼šè€ƒè™‘æœåŠ¡çš„æ‰¹é‡ç®¡ç†å’ŒæŒ‰éœ€å¯åŠ¨</summary>
<p>ç­”æ¡ˆï¼š</p>
<ul>
<li><code>class</code>ï¼šå°†æœåŠ¡åˆ†ç»„ï¼Œå¯é€šè¿‡<code>class_start</code>/<code>class_stop</code>æ‰¹é‡æ§åˆ¶</li>
<li><code>disabled</code>ï¼šæœåŠ¡ä¸ä¼šè‡ªåŠ¨å¯åŠ¨ï¼Œéœ€è¦æ˜¾å¼<code>start</code>å‘½ä»¤æˆ–å±æ€§è§¦å‘</li>
<li>ç»“åˆä½¿ç”¨å¯å®ç°åˆ†é˜¶æ®µå¯åŠ¨å’Œæ¡ä»¶å¯åŠ¨</li>
<li>å¸¸è§classï¼šcoreã€halã€late_startç­‰</li>
</ul>
</details>
<ol start="4">
<li><strong>First Stage Initä¸ºä»€ä¹ˆè¦ä»¥æœ€å°åŒ–æ–¹å¼å®ç°ï¼Ÿ</strong></li>
</ol>
<details>
<summary>æç¤ºï¼šè€ƒè™‘å®‰å…¨æ€§å’Œå¯é æ€§</summary>
<p>ç­”æ¡ˆï¼š</p>
<ul>
<li>SELinuxå°šæœªåŠ è½½ï¼Œç³»ç»Ÿå¤„äºä¸å®‰å…¨çŠ¶æ€</li>
<li>æ–‡ä»¶ç³»ç»Ÿæœªå®Œå…¨å°±ç»ªï¼ŒåŠŸèƒ½å—é™</li>
<li>å‡å°‘æ”»å‡»é¢ï¼Œé¿å…å®‰å…¨æ¼æ´</li>
<li>ç¡®ä¿å…³é”®åˆå§‹åŒ–æ­¥éª¤çš„å¯é æ€§</li>
<li>å¤±è´¥åç³»ç»Ÿæ— æ³•æ¢å¤ï¼Œå¿…é¡»æå…¶ç¨³å®š</li>
</ul>
</details>
<h3 id="_4">æŒ‘æˆ˜é¢˜</h3>
<ol start="5">
<li><strong>è®¾è®¡ä¸€ä¸ªRCè„šæœ¬å®ç°ä»¥ä¸‹éœ€æ±‚ï¼šå½“æ£€æµ‹åˆ°è°ƒè¯•ç‰ˆæœ¬æ—¶è‡ªåŠ¨å¯åŠ¨æ€§èƒ½åˆ†ææœåŠ¡ï¼Œä½†åœ¨ç”¨æˆ·ç‰ˆæœ¬ä¸­ç¦ç”¨</strong></li>
</ol>
<details>
<summary>æç¤ºï¼šä½¿ç”¨å±æ€§è§¦å‘å™¨å’Œæ¡ä»¶åˆ¤æ–­</summary>
<p>ç­”æ¡ˆï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="nx">service</span><span class="w"> </span><span class="nx">perf_daemon</span><span class="w"> </span><span class="o">/</span><span class="nx">system</span><span class="o">/</span><span class="nx">bin</span><span class="o">/</span><span class="nx">perfmond</span>
<span class="w">    </span><span class="kd">class</span><span class="w"> </span><span class="nx">late_start</span>
<span class="w">    </span><span class="nx">disabled</span>
<span class="w">    </span><span class="nx">user</span><span class="w"> </span><span class="nx">system</span>
<span class="w">    </span><span class="nx">group</span><span class="w"> </span><span class="nx">system</span>

<span class="nx">on</span><span class="w"> </span><span class="nx">property</span><span class="p">:</span><span class="nx">ro</span><span class="p">.</span><span class="nx">debuggable</span><span class="p">=</span><span class="mi">1</span>
<span class="w">    </span><span class="nx">start</span><span class="w"> </span><span class="nx">perf_daemon</span>

<span class="nx">on</span><span class="w"> </span><span class="nx">property</span><span class="p">:</span><span class="nx">ro</span><span class="p">.</span><span class="nx">build</span><span class="p">.</span><span class="k">type</span><span class="p">=</span><span class="nx">user</span>
<span class="w">    </span><span class="nx">stop</span><span class="w"> </span><span class="nx">perf_daemon</span>
</code></pre></div>

</details>
<ol start="6">
<li><strong>åˆ†æä»¥ä¸‹åœºæ™¯ï¼šæŸä¸ªå…³é”®æœåŠ¡åå¤å´©æºƒé‡å¯ï¼ŒInitè¿›ç¨‹ä¼šå¦‚ä½•å¤„ç†ï¼Ÿå¦‚ä½•ä¼˜åŒ–ï¼Ÿ</strong></li>
</ol>
<details>
<summary>æç¤ºï¼šè€ƒè™‘æœåŠ¡é‡å¯ç­–ç•¥å’Œé€€é¿æœºåˆ¶</summary>
<p>ç­”æ¡ˆï¼š
Initè¿›ç¨‹çš„å¤„ç†ï¼š</p>
<ul>
<li>é»˜è®¤ç«‹å³é‡å¯å´©æºƒçš„æœåŠ¡</li>
<li>ä½¿ç”¨<code>restart_period</code>é™åˆ¶é‡å¯é¢‘ç‡</li>
<li>è®°å½•é‡å¯æ¬¡æ•°åˆ°å±æ€§<code>init.svc.&lt;name&gt;.restarts</code></li>
<li>å¯èƒ½è§¦å‘<code>on service-exited</code>åŠ¨ä½œ</li>
</ul>
<p>ä¼˜åŒ–æ–¹æ¡ˆï¼š</p>
<ul>
<li>è®¾ç½®<code>restart_period</code>å’Œ<code>timeout_period</code></li>
<li>ä½¿ç”¨<code>critical</code>æ ‡è®°è§¦å‘ç³»ç»Ÿé‡å¯</li>
<li>æ·»åŠ <code>onrestart</code>æ‰§è¡Œæ¸…ç†æ“ä½œ</li>
<li>å®ç°æŒ‡æ•°é€€é¿ç®—æ³•å»¶è¿Ÿé‡å¯</li>
<li>æ·»åŠ çœ‹é—¨ç‹—ç›‘æ§æœåŠ¡å¥åº·çŠ¶æ€</li>
</ul>
</details>
<ol start="7">
<li><strong>æ¯”è¾ƒAndroidçš„propertyæœºåˆ¶ä¸Windowsæ³¨å†Œè¡¨ã€iOSçš„NSUserDefaultsï¼Œåˆ†æå„è‡ªä¼˜åŠ£</strong></li>
</ol>
<details>
<summary>æç¤ºï¼šä»æ€§èƒ½ã€å®‰å…¨æ€§ã€ä½¿ç”¨ä¾¿åˆ©æ€§ç­‰è§’åº¦åˆ†æ</summary>
<p>ç­”æ¡ˆï¼š
Android Propertyï¼š</p>
<ul>
<li>ä¼˜ç‚¹ï¼šå†…å­˜æ˜ å°„é«˜æ€§èƒ½ï¼Œè§¦å‘å™¨æœºåˆ¶çµæ´»ï¼Œæƒé™æ§åˆ¶ç»†ç²’åº¦</li>
<li>ç¼ºç‚¹ï¼šå€¼ç±»å‹å•ä¸€ï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼Œå¤§å°é™åˆ¶ï¼ˆ92å­—èŠ‚ï¼‰ï¼Œæ— äº‹åŠ¡æ”¯æŒ</li>
</ul>
<p>Windowsæ³¨å†Œè¡¨ï¼š</p>
<ul>
<li>ä¼˜ç‚¹ï¼šå±‚æ¬¡ç»“æ„æ¸…æ™°ï¼Œæ”¯æŒå¤šç§æ•°æ®ç±»å‹ï¼Œæœ‰äº‹åŠ¡æ”¯æŒ</li>
<li>ç¼ºç‚¹ï¼šæ€§èƒ½å¼€é”€å¤§ï¼Œå®¹æ˜“æ±¡æŸ“ï¼Œæƒé™ç®¡ç†å¤æ‚</li>
</ul>
<p>iOS NSUserDefaultsï¼š</p>
<ul>
<li>ä¼˜ç‚¹ï¼šç±»å‹å®‰å…¨ï¼Œä¸åº”ç”¨ç”Ÿå‘½å‘¨æœŸé›†æˆï¼Œè‡ªåŠ¨åŒæ­¥iCloud</li>
<li>ç¼ºç‚¹ï¼šä»…é™åº”ç”¨å†…ä½¿ç”¨ï¼Œæ— ç³»ç»Ÿçº§é…ç½®ï¼Œå¤§æ•°æ®æ€§èƒ½å·®</li>
</ul>
<p>ä½¿ç”¨åœºæ™¯ï¼š</p>
<ul>
<li>Androidé€‚åˆç³»ç»Ÿé…ç½®å’Œè·¨è¿›ç¨‹é€šä¿¡</li>
<li>Windowsé€‚åˆå¤æ‚é…ç½®ç®¡ç†</li>
<li>iOSé€‚åˆåº”ç”¨åå¥½è®¾ç½®</li>
</ul>
</details>
<ol start="8">
<li><strong>è®¾è®¡ä¸€ä¸ªå¯åŠ¨æ—¶é—´ä¼˜åŒ–æ–¹æ¡ˆï¼Œå°†ç³»ç»Ÿå¯åŠ¨æ—¶é—´ä»10ç§’ä¼˜åŒ–åˆ°5ç§’</strong></li>
</ol>
<details>
<summary>æç¤ºï¼šåˆ†æå¯åŠ¨ç“¶é¢ˆï¼Œè€ƒè™‘å¹¶è¡ŒåŒ–å’Œå»¶è¿ŸåŠ è½½</summary>
<p>ç­”æ¡ˆï¼š
åˆ†æé˜¶æ®µï¼š</p>
<ol>
<li>ä½¿ç”¨bootchartè¯†åˆ«è€—æ—¶æœåŠ¡</li>
<li>åˆ†æI/Oç­‰å¾…å’ŒCPUç©ºé—²æ—¶é—´</li>
<li>æ£€æŸ¥æœåŠ¡ä¾èµ–å…³ç³»</li>
</ol>
<p>ä¼˜åŒ–ç­–ç•¥ï¼š</p>
<ol>
<li>
<p><strong>å¹¶è¡ŒåŒ–</strong>ï¼š
   - ç‹¬ç«‹æœåŠ¡æ”¹ä¸ºä¸åŒclasså¹¶è¡Œå¯åŠ¨
   - ç¡¬ä»¶åˆå§‹åŒ–å¹¶è¡ŒåŒ–ï¼ˆå¦‚Wi-Fiå’Œè“ç‰™ï¼‰</p>
</li>
<li>
<p><strong>å»¶è¿ŸåŠ è½½</strong>ï¼š
   - éå…³é”®æœåŠ¡å»¶è¿Ÿåˆ°å¼€æœºåŠ¨ç”»å
   - æŒ‰éœ€å¯åŠ¨å¾ˆå°‘ä½¿ç”¨çš„æœåŠ¡</p>
</li>
<li>
<p><strong>I/Oä¼˜åŒ–</strong>ï¼š
   - é¢„è¯»å–å¸¸ç”¨æ–‡ä»¶åˆ°å†…å­˜
   - åˆå¹¶å°æ–‡ä»¶å‡å°‘å¯»é“
   - ä½¿ç”¨squashfsç­‰å‹ç¼©æ–‡ä»¶ç³»ç»Ÿ</p>
</li>
<li>
<p><strong>CPUä¼˜åŒ–</strong>ï¼š
   - å¯åŠ¨æ—¶é”å®šæœ€é«˜é¢‘ç‡
   - å…³é”®æœåŠ¡ç»‘å®šå¤§æ ¸
   - ä¼˜åŒ–ç¼–è¯‘å‚æ•°å‡å°‘åˆå§‹åŒ–å¼€é”€</p>
</li>
<li>
<p><strong>å‚å•†å®šåˆ¶</strong>ï¼š
   - å®ç°suspend-to-diskå¿«é€Ÿæ¢å¤
   - ç¡¬ä»¶çº§å¯åŠ¨åŠ é€Ÿï¼ˆbootloaderä¼˜åŒ–ï¼‰
   - AIé¢„æµ‹ç”¨æˆ·å¸¸ç”¨æœåŠ¡ä¼˜å…ˆåŠ è½½</p>
</li>
</ol>
</details>
<h2 id="gotchas">å¸¸è§é™·é˜±ä¸é”™è¯¯ (Gotchas)</h2>
<ol>
<li>
<p><strong>RCè„šæœ¬è¯­æ³•é”™è¯¯</strong>
   - é”™è¯¯ï¼šä½¿ç”¨Tabç¼©è¿›ï¼ˆå¿…é¡»ç”¨ç©ºæ ¼ï¼‰
   - é”™è¯¯ï¼šå‘½ä»¤å‚æ•°åŒ…å«æœªè½¬ä¹‰çš„ç‰¹æ®Šå­—ç¬¦
   - é”™è¯¯ï¼šserviceåç§°åŒ…å«ç‚¹å·æˆ–æ–œæ </p>
</li>
<li>
<p><strong>å±æ€§è®¾ç½®å¤±è´¥</strong>
   - åŸå› ï¼šSELinuxæ‹’ç»è®¿é—®
   - åŸå› ï¼šå±æ€§åè¶…è¿‡31å­—ç¬¦é™åˆ¶
   - åŸå› ï¼šå±æ€§å€¼è¶…è¿‡91å­—ç¬¦é™åˆ¶</p>
</li>
<li>
<p><strong>æœåŠ¡å¯åŠ¨å¤±è´¥</strong>
   - å¿˜è®°è®¾ç½®æ­£ç¡®çš„æ–‡ä»¶æƒé™å’ŒSELinuxæ ‡ç­¾
   - ä¾èµ–çš„èµ„æºæœªå°±ç»ªï¼ˆå¦‚/dataæœªæŒ‚è½½ï¼‰
   - ç”¨æˆ·/ç»„ä¸å­˜åœ¨æˆ–æƒé™ä¸è¶³</p>
</li>
<li>
<p><strong>SELinuxç›¸å…³</strong>
   - åœ¨permissiveæ¨¡å¼ä¸‹æµ‹è¯•æ­£å¸¸ï¼Œenforcingæ¨¡å¼å¤±è´¥
   - å¿˜è®°æ›´æ–°file_contextså¯¼è‡´æ ‡ç­¾é”™è¯¯
   - åŸŸè½¬æ¢å¤±è´¥å¯¼è‡´æœåŠ¡è¿è¡Œåœ¨é”™è¯¯ä¸Šä¸‹æ–‡</p>
</li>
<li>
<p><strong>æ€§èƒ½é™·é˜±</strong>
   - åŒæ­¥ç­‰å¾…å¯¼è‡´å¯åŠ¨ä¸²è¡ŒåŒ–
   - è¿‡æ—©å¯åŠ¨å¤§é‡æœåŠ¡å¯¼è‡´èµ„æºç«äº‰
   - é¢‘ç¹çš„å±æ€§å˜åŒ–è§¦å‘è¿‡å¤šaction</p>
</li>
</ol>
<h2 id="_5">æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h2>
<h3 id="rc">RCè„šæœ¬è®¾è®¡</h3>
<ul>
<li>[ ] ä½¿ç”¨æœ‰æ„ä¹‰çš„serviceå’Œactionåç§°</li>
<li>[ ] åˆç†è®¾ç½®serviceçš„classåˆ†ç»„</li>
<li>[ ] å¿…è¦æ—¶ä½¿ç”¨disabled+è§¦å‘å™¨å¯åŠ¨</li>
<li>[ ] è®¾ç½®åˆé€‚çš„oom_score_adjustä¿æŠ¤å…³é”®æœåŠ¡</li>
<li>[ ] ä½¿ç”¨capabilitiesæ›¿ä»£rootæƒé™</li>
</ul>
<h3 id="_6">å±æ€§ä½¿ç”¨</h3>
<ul>
<li>[ ] éµå¾ªå‘½åè§„èŒƒï¼ˆå¦‚å‚å•†å±æ€§ä½¿ç”¨vendor.å‰ç¼€ï¼‰</li>
<li>[ ] æ•æ„Ÿä¿¡æ¯ä¸è¦å­˜å‚¨åœ¨å±æ€§ä¸­</li>
<li>[ ] ä½¿ç”¨persist.*ä¿å­˜éœ€è¦æŒä¹…åŒ–çš„é…ç½®</li>
<li>[ ] é¿å…é«˜é¢‘å±æ€§æ›´æ–°ï¼ˆè€ƒè™‘æ€§èƒ½å½±å“ï¼‰</li>
</ul>
<h3 id="selinux">SELinuxç­–ç•¥</h3>
<ul>
<li>[ ] æœ€å°æƒé™åŸåˆ™ï¼Œé¿å…è¿‡åº¦æˆæƒ</li>
<li>[ ] ä½¿ç”¨neverallowè§„åˆ™é˜²æ­¢ç­–ç•¥è¿è§„</li>
<li>[ ] å®šæœŸå®¡è®¡auditæ—¥å¿—å‘ç°æ½œåœ¨é—®é¢˜</li>
<li>[ ] æµ‹è¯•enforcingæ¨¡å¼ä¸‹çš„å®Œæ•´åŠŸèƒ½</li>
</ul>
<h3 id="_7">å¯åŠ¨ä¼˜åŒ–</h3>
<ul>
<li>[ ] è¯†åˆ«å¹¶ä¼˜åŒ–å…³é”®è·¯å¾„ä¸Šçš„æœåŠ¡</li>
<li>[ ] å»¶è¿Ÿéå¿…è¦æœåŠ¡åˆ°ç³»ç»Ÿç©ºé—²æ—¶å¯åŠ¨</li>
<li>[ ] ä½¿ç”¨å·¥å…·é‡åŒ–ä¼˜åŒ–æ•ˆæœ</li>
<li>[ ] åœ¨ä¸åŒç¡¬ä»¶é…ç½®ä¸Šæµ‹è¯•å¯åŠ¨æ—¶é—´</li>
</ul>
<h3 id="_8">è°ƒè¯•æŠ€å·§</h3>
<ul>
<li>[ ] ä½¿ç”¨<code>getprop</code>å’Œ<code>setprop</code>è°ƒè¯•å±æ€§é—®é¢˜</li>
<li>[ ] æŸ¥çœ‹<code>/proc/1/</code>äº†è§£initè¿›ç¨‹çŠ¶æ€</li>
<li>[ ] ä½¿ç”¨<code>dmesg</code>æŸ¥çœ‹å†…æ ¸æ—¥å¿—ä¸­çš„SELinuxæ‹’ç»</li>
<li>[ ] ä¿å­˜bootchartæ•°æ®ç”¨äºæ€§èƒ½åˆ†æ</li>
</ul>
            </article>
            
            <nav class="page-nav"><a href="chapter3.html" class="nav-link prev">â† ç¬¬3ç« ï¼šç¡¬ä»¶æŠ½è±¡å±‚(HAL)</a><a href="chapter5.html" class="nav-link next">ç¬¬5ç« ï¼šZygoteä¸åº”ç”¨è¿›ç¨‹ç®¡ç† â†’</a></nav>
        </main>
    </div>
</body>
</html>