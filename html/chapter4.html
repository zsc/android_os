<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>第4章：Init进程与系统启动</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>目录</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="搜索..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Android OS 深度原理解析</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第1章：Android系统架构概览</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第2章：Linux内核层定制</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第3章：硬件抽象层(HAL)</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第4章：Init进程与系统启动</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第5章：Zygote与应用进程管理</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第6章：Android Runtime (ART)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第7章：Binder IPC机制深度剖析</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第8章：系统服务架构</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第9章：ContentProvider与数据共享</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第10章：Android图形系统架构</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第11章：音频系统架构</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第12章：相机与多媒体框架</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第13章：Android安全模型</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第14章：密钥管理与硬件安全</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第15章：漏洞案例分析</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第16章：Neural Networks API (NNAPI)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第17章：TensorFlow Lite集成</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第18章：ML Kit与设备端AI</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第19章：NPU/TPU硬件加速</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter20.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第20章：协处理器系统集成</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter21.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第21章：MIUI系统架构剖析</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter22.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第22章：ColorOS/EMUI技术分析</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter23.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第23章：厂商内核与驱动定制</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter24.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第24章：厂商AI能力对比</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter25.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第25章：OriginOS深度剖析</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter26.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第26章：Android虚拟化技术</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter27.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第27章：实时性与性能优化</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter28.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第28章：逆向工程与安全研究</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter29.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第29章：Android未来演进</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter30.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">附录A：调试工具与技巧</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter31.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">附录B：源码编译与定制</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter32.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第32章：参考资源</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">AndroidOS原理教程项目说明</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="README.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Android OS 深度原理解析</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="4init">第4章：Init进程与系统启动</h1>
<p>Init进程是Android系统中第一个用户空间进程，承担着整个系统的初始化重任。本章将深入剖析Init进程的实现原理，包括其启动流程、RC脚本解析、属性服务、SELinux策略加载等核心机制。通过与Linux传统init、iOS的launchd、鸿蒙OS的init对比，读者将全面理解Android独特的系统启动架构。</p>
<h2 id="41-init">4.1 Init进程源码分析</h2>
<h3 id="411-init">4.1.1 Init进程的诞生</h3>
<p>当Linux内核完成自身初始化后，会启动第一个用户空间进程——Init进程（PID=1）。Android的Init进程实现位于<code>system/core/init/</code>目录，其入口函数是<code>main()</code>。内核通过<code>run_init_process()</code>调用<code>/init</code>二进制文件，这是ramdisk中的第一个程序。</p>
<p><strong>内核到用户空间的转换</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">kernel_init</span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">run_init_process</span><span class="p">(</span><span class="s">&quot;/init&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">execve</span><span class="p">(</span><span class="s">&quot;/init&quot;</span><span class="p">)</span>
</code></pre></div>

<p>内核在<code>kernel_init()</code>函数中按以下顺序尝试启动init：</p>
<ol>
<li><code>ramdisk_execute_command</code>（通常是<code>/init</code>）</li>
<li><code>/sbin/init</code></li>
<li><code>/etc/init</code></li>
<li><code>/bin/init</code></li>
<li><code>/bin/sh</code>（紧急模式）</li>
</ol>
<p>Android将init放在ramdisk根目录，确保第一个被找到。内核传递的环境变量极其有限：</p>
<ul>
<li><code>HOME=/</code></li>
<li><code>TERM=linux</code></li>
<li><code>PATH=/sbin:/usr/sbin:/bin:/usr/bin</code></li>
</ul>
<p>Init进程的生命周期分为两个阶段：</p>
<p><strong>First Stage Init</strong>
First Stage Init在ramdisk环境中运行，使用静态链接的最小化二进制文件，主要任务是准备真正的根文件系统：</p>
<ul>
<li>挂载基础文件系统（/dev、/proc、/sys等）</li>
<li>使用<code>mount("tmpfs", "/dev", "tmpfs", MS_NOSUID, "mode=0755")</code></li>
<li>创建必要的子目录：/dev/pts、/dev/socket、/dev/dm-user</li>
<li>挂载<code>mount("devpts", "/dev/pts", "devpts", 0, NULL)</code>支持伪终端</li>
<li>挂载<code>mount("proc", "/proc", "proc", 0, "hidepid=2")</code>增强安全性</li>
<li>
<p>挂载<code>mount("sysfs", "/sys", "sysfs", 0, NULL)</code>导出内核对象</p>
</li>
<li>
<p>创建设备节点</p>
</li>
<li><code>/dev/null</code>、<code>/dev/zero</code>、<code>/dev/full</code>等基础设备</li>
<li><code>/dev/kmsg</code>用于内核日志（主设备号1，次设备号11）</li>
<li><code>/dev/random</code>、<code>/dev/urandom</code>用于随机数（主设备号1，次设备号8/9）</li>
<li><code>/dev/ptmx</code>伪终端主设备（主设备号5，次设备号2）</li>
<li>
<p>使用<code>mknod()</code>系统调用创建，设置权限0666或0600</p>
</li>
<li>
<p>初始化内核日志</p>
</li>
<li>通过<code>android::base::InitLogging()</code>设置日志系统</li>
<li>重定向stdout/stderr到<code>/dev/kmsg</code></li>
<li>设置日志级别和格式（时间戳、进程信息等）</li>
<li>
<p>配置klog过滤规则，避免日志风暴</p>
</li>
<li>
<p>挂载必要的块设备</p>
</li>
<li>解析设备树（device tree）获取分区信息</li>
<li>等待块设备就绪（通过uevent监听）</li>
<li>挂载system分区到<code>/system</code>（只读）</li>
<li>挂载vendor分区到<code>/vendor</code>（只读）</li>
<li>
<p>处理A/B分区的slot选择</p>
</li>
<li>
<p>加载SELinux策略（如果是强制模式）</p>
</li>
<li>调用<code>SelinuxInitialize()</code>加载编译后的策略</li>
<li>设置进程上下文为<code>u:r:init:s0</code></li>
<li>从<code>/system/etc/selinux/plat_sepolicy.cil</code>加载平台策略</li>
<li>合并<code>/vendor/etc/selinux/vendor_sepolicy.cil</code>厂商策略</li>
<li>
<p>通过<code>selinux_android_load_policy()</code>加载到内核</p>
</li>
<li>
<p>执行Second Stage Init</p>
</li>
<li>通过<code>execv("/system/bin/init", argv)</code>重新执行自身</li>
<li>传递<code>--second-stage</code>参数标识</li>
<li>保留必要的文件描述符（如<code>/dev/kmsg</code>）</li>
</ul>
<p><strong>Second Stage Init</strong>
Second Stage Init从真正的系统分区运行，拥有完整的库支持和更丰富的功能：</p>
<ul>
<li>初始化属性服务（Property Service）</li>
<li>创建属性共享内存区域（<code>/dev/__properties__</code>）</li>
<li>初始化属性区域头部，设置魔数和版本号</li>
<li>启动Unix域套接字监听属性设置请求（<code>/dev/socket/property_service</code>）</li>
<li>加载默认属性文件：<ul>
<li><code>/default.prop</code>（ramdisk中的属性）</li>
<li><code>/system/build.prop</code>（系统属性）</li>
<li><code>/vendor/build.prop</code>（厂商属性）</li>
<li><code>/product/build.prop</code>（产品属性）</li>
<li><code>/odm/build.prop</code>（ODM属性）</li>
</ul>
</li>
<li>
<p>设置属性区域的SELinux标签和访问权限</p>
</li>
<li>
<p>解析RC脚本</p>
</li>
<li>从以下目录按顺序加载RC文件：<ul>
<li><code>/init.rc</code>（主配置文件）</li>
<li><code>/system/etc/init/</code>（系统服务）</li>
<li><code>/vendor/etc/init/</code>（厂商服务）</li>
<li><code>/odm/etc/init/</code>（ODM服务）</li>
</ul>
</li>
<li>构建Action和Service的内部数据结构</li>
<li>验证语法正确性和权限要求</li>
<li>检查服务的可执行文件是否存在</li>
<li>
<p>预处理import语句，支持属性值替换</p>
</li>
<li>
<p>初始化子系统</p>
</li>
<li>启动ueventd处理设备事件（软链接到init）</li>
<li>启动watchdogd防止系统挂起（如果硬件支持）</li>
<li>创建控制消息处理器（<code>/dev/socket/init</code>）</li>
<li>
<p>注册信号处理器（SIGCHLD、SIGTERM等）</p>
</li>
<li>
<p>启动系统服务</p>
</li>
<li>根据class和触发器有序启动</li>
<li>设置进程的capabilities、优先级、cgroup等</li>
<li>配置OOM调整值保护关键服务</li>
<li>
<p>设置进程的namespace隔离（如果配置）</p>
</li>
<li>
<p>进入主事件循环</p>
</li>
<li>基于epoll的事件驱动模型</li>
<li>处理属性变化、子进程退出、控制消息等</li>
<li>执行pending的Action队列</li>
<li>监控服务健康状态，必要时重启</li>
</ul>
<p><strong>关键环境变量设置</strong></p>
<div class="codehilite"><pre><span></span><code>PATH=/system/bin:/system/xbin:/vendor/bin:/odm/bin
LD_LIBRARY_PATH=/system/lib64:/vendor/lib64:/odm/lib64
ANDROID_ROOT=/system
ANDROID_DATA=/data
ANDROID_STORAGE=/storage
ANDROID_RUNTIME_ROOT=/apex/com.android.runtime
ANDROID_TZDATA_ROOT=/apex/com.android.tzdata
ANDROID_ART_ROOT=/apex/com.android.art
BOOTCLASSPATH=/apex/com.android.runtime/javalib/core-oj.jar:...
</code></pre></div>

<h3 id="412">4.1.2 关键数据结构</h3>
<p>Init进程使用精心设计的数据结构管理系统启动，这些结构体现了Android对启动过程的细粒度控制：</p>
<p><strong>Action（动作）</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">Action</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Command</span><span class="o">&gt;</span><span class="w"> </span><span class="n">commands</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">property_triggers</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">event_trigger</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">oneshot</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">trigger_order</span><span class="p">;</span><span class="w">  </span><span class="c1">// 触发优先级</span>

<span class="w">    </span><span class="c1">// 执行状态管理</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">current_command</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">ExecuteOneCommand</span><span class="p">();</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">CheckPropertyTriggers</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 触发器管理</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">required_property_contexts</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">TriggersEqual</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Action</span><span class="o">&amp;</span><span class="w"> </span><span class="n">other</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 执行控制</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">time_point</span><span class="w"> </span><span class="n">last_command_time</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="o">&gt;</span><span class="w"> </span><span class="n">command_timeout</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Action的关键特性：</p>
<ul>
<li><strong>触发器类型</strong>：事件触发器（如<code>boot</code>）或属性触发器（如<code>property:sys.boot_completed=1</code>）</li>
<li><strong>命令队列</strong>：支持异步执行，每次循环只执行一个命令，避免阻塞</li>
<li><strong>优先级控制</strong>：相同触发器的Action按解析顺序执行</li>
<li><strong>一次性执行</strong>：<code>oneshot</code>标记的Action只执行一次</li>
</ul>
<p><strong>Service（服务）</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">Service</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span><span class="w">  </span><span class="c1">// SVC_RUNNING, SVC_DISABLED, SVC_RESTARTING等</span>
<span class="w">    </span><span class="kt">pid_t</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Option</span><span class="o">&gt;</span><span class="w"> </span><span class="n">options</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 服务控制</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">crash_count</span><span class="p">;</span>
<span class="w">    </span><span class="kt">time_t</span><span class="w"> </span><span class="n">time_started</span><span class="p">;</span>
<span class="w">    </span><span class="kt">time_t</span><span class="w"> </span><span class="n">time_crashed</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span><span class="w"> </span><span class="n">restart_period</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="n">s</span><span class="p">;</span><span class="w">  </span><span class="c1">// 重启间隔</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span><span class="o">&gt;</span><span class="w"> </span><span class="n">timeout_period</span><span class="p">;</span><span class="w">  </span><span class="c1">// 启动超时</span>

<span class="w">    </span><span class="c1">// 进程管理</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">console</span><span class="p">;</span><span class="w">  </span><span class="c1">// 控制台设备</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sigstop</span><span class="p">;</span><span class="w">  </span><span class="c1">// 启动后是否暂停</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">rlimit</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">rlimits</span><span class="p">;</span><span class="w">  </span><span class="c1">// 资源限制</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">writepid_files</span><span class="p">;</span><span class="w">  </span><span class="c1">// PID文件路径</span>

<span class="w">    </span><span class="c1">// 安全上下文</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">seclabel</span><span class="p">;</span><span class="w">  </span><span class="c1">// SELinux标签</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uid_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">supp_gids</span><span class="p">;</span><span class="w">  </span><span class="c1">// 补充组ID</span>
<span class="w">    </span><span class="n">CapSet</span><span class="w"> </span><span class="n">capabilities</span><span class="p">;</span><span class="w">  </span><span class="c1">// Linux capabilities</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">updatable</span><span class="p">;</span><span class="w">  </span><span class="c1">// APEX更新</span>

<span class="w">    </span><span class="c1">// 命名空间隔离</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">namespace_flags</span><span class="p">;</span><span class="w">  </span><span class="c1">// CLONE_NEWPID, CLONE_NEWNET等</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">namespaces_to_enter</span><span class="p">;</span><span class="w">  </span><span class="c1">// 进入已存在的namespace</span>

<span class="w">    </span><span class="c1">// cgroup和调度</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cgroup_paths</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">oom_score_adjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1000</span><span class="p">;</span><span class="w">  </span><span class="c1">// OOM killer调整值</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">// nice值</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_param</span><span class="w"> </span><span class="n">scheduling_param</span><span class="p">;</span><span class="w">  </span><span class="c1">// 实时调度参数</span>

<span class="w">    </span><span class="c1">// 服务依赖</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">before_services</span><span class="p">;</span><span class="w">  </span><span class="c1">// 必须在这些服务前启动</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">after_services</span><span class="p">;</span><span class="w">   </span><span class="c1">// 必须在这些服务后启动</span>

<span class="w">    </span><span class="c1">// 关键服务处理</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_critical</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w">  </span><span class="c1">// 崩溃是否触发重启</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">critical_services_to_restart</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Service的高级特性：</p>
<ul>
<li><strong>生命周期管理</strong>：自动重启、崩溃计数、退避算法</li>
<li><strong>资源隔离</strong>：支持Linux namespace、cgroup、capabilities</li>
<li><strong>依赖关系</strong>：服务间的启动顺序依赖</li>
<li><strong>更新支持</strong>：与APEX模块系统集成</li>
</ul>
<p><strong>Property（属性）</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// 属性存储结构</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">prop_info</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">atomic_uint_least32_t</span><span class="w"> </span><span class="n">serial</span><span class="p">;</span><span class="w">  </span><span class="c1">// 版本号，用于检测变化</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">value</span><span class="p">[</span><span class="n">PROP_VALUE_MAX</span><span class="p">];</span><span class="w">   </span><span class="c1">// 属性值（92字节）</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="n">PROP_NAME_MAX</span><span class="p">];</span><span class="w">     </span><span class="c1">// 属性名（32字节）</span>
<span class="p">};</span>

<span class="c1">// 属性区域管理</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">prop_area</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">bytes_used</span><span class="p">;</span>
<span class="w">    </span><span class="kt">atomic_uint_least32_t</span><span class="w"> </span><span class="n">serial</span><span class="p">;</span><span class="w">  </span><span class="c1">// 全局版本号</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">magic</span><span class="p">;</span><span class="w">  </span><span class="c1">// 0x504f5250 (&#39;PROP&#39;)</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">version</span><span class="p">;</span><span class="w">  </span><span class="c1">// 当前版本号</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">reserved</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w">  </span><span class="c1">// 实际属性数据</span>
<span class="p">};</span>

<span class="c1">// 属性节点（Trie树结构）</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">prop_bt</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">namelen</span><span class="p">;</span><span class="w">  </span><span class="c1">// 名称长度</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">proplen</span><span class="p">;</span><span class="w">  </span><span class="c1">// 属性数量</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">children</span><span class="p">;</span><span class="w">  </span><span class="c1">// 子节点偏移</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">props</span><span class="p">;</span><span class="w">  </span><span class="c1">// 属性列表偏移</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w">  </span><span class="c1">// 节点名称</span>
<span class="p">};</span>

<span class="c1">// 属性上下文映射</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">prop_context</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">name_prefix</span><span class="p">;</span><span class="w">  </span><span class="c1">// 属性前缀</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">context</span><span class="p">;</span><span class="w">  </span><span class="c1">// SELinux上下文</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">exact_match</span><span class="p">;</span><span class="w">  </span><span class="c1">// 是否精确匹配</span>
<span class="p">};</span>
</code></pre></div>

<p>系统属性的高级特性：</p>
<ul>
<li><strong>共享内存实现</strong>：通过<code>mmap</code>映射到所有进程，零拷贝访问</li>
<li><strong>Trie树索引</strong>：支持前缀查询和通配符匹配</li>
<li><strong>版本控制</strong>：通过<code>serial</code>字段检测属性变化，避免轮询</li>
<li><strong>分区存储</strong>：不同前缀的属性存储在独立的内存区域</li>
<li><strong>访问控制</strong>：结合SELinux和UID权限进行细粒度控制</li>
</ul>
<p><strong>命令管理器（CommandManager）</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BuiltinFunctionMap</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">BuiltinFunction</span><span class="o">&gt;</span><span class="w"> </span><span class="n">functions_</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 注册的内置命令</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">RegisterBuiltinFunctions</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 文件系统操作</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;chmod&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_chmod</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;chown&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_chown</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;copy&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_copy</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;mkdir&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_mkdir</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;mount&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_mount</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;umount&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_umount</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;symlink&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_symlink</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;rm&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_rm</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;rmdir&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_rmdir</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;write&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_write</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 服务控制</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;class_start&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_class_start</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;class_stop&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_class_stop</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;class_reset&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_class_reset</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;start&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_start</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;stop&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_stop</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;restart&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_restart</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;enable&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_enable</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 属性操作</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;setprop&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_setprop</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;getprop&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_getprop</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;wait_for_prop&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_wait_for_prop</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 进程执行</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;exec&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_exec</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;exec_start&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_exec_start</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;exec_background&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_exec_background</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 触发器管理</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;trigger&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_trigger</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 系统控制</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;bootchart&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_bootchart</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;init_user0&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_init_user0</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;installkey&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_installkey</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;load_persist_props&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_load_persist_props</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 网络配置</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;hostname&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_hostname</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;domainname&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_domainname</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;ifup&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_ifup</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 安全相关</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;restorecon&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_restorecon</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;restorecon_recursive&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_restorecon_recursive</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;setrlimit&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_setrlimit</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;swapon_all&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_swapon_all</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 日志和调试</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;loglevel&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_loglevel</span><span class="p">);</span>
<span class="w">        </span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;mark_post_data&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">do_mark_post_data</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 命令执行包装</span>
<span class="w">    </span><span class="n">Result</span><span class="o">&lt;</span><span class="n">Success</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Execute</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span>
<span class="w">                           </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">functions_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">functions_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Error</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Unknown command: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p>命令系统的设计特点：</p>
<ul>
<li><strong>模块化设计</strong>：每个命令是独立的函数，易于扩展</li>
<li><strong>错误处理</strong>：使用<code>Result&lt;T&gt;</code>类型安全地返回错误</li>
<li><strong>参数验证</strong>：每个命令函数负责验证自己的参数</li>
<li><strong>异步支持</strong>：<code>exec_background</code>等命令支持非阻塞执行</li>
</ul>
<h3 id="413">4.1.3 事件循环机制</h3>
<p>Init进程的主循环采用高效的epoll机制，这是Android系统响应性的基础。与传统的select/poll相比，epoll在大量文件描述符场景下性能更优：</p>
<p><strong>事件源类型</strong>
Init进程监听的事件源包括：</p>
<ul>
<li>属性设置请求（通过Unix域套接字<code>/dev/socket/property_service</code>）</li>
<li>子进程退出信号（通过signalfd将SIGCHLD转换为文件描述符事件）</li>
<li>控制命令（通过<code>/dev/socket/init</code>接收如<code>ctl.start</code>等命令）</li>
<li>内核消息（通过netlink套接字接收uevent等）</li>
<li>看门狗定时器（防止init进程挂起）</li>
<li>keychord事件（组合键触发特殊动作）</li>
</ul>
<p><strong>Epoll架构实现</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Epoll</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">epoll_fd_</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">handlers_</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">Open</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 创建epoll实例，EPOLL_CLOEXEC防止fd泄露到子进程</span>
<span class="w">        </span><span class="n">epoll_fd_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">epoll_create1</span><span class="p">(</span><span class="n">EPOLL_CLOEXEC</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">epoll_fd_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">PLOG</span><span class="p">(</span><span class="n">FATAL</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;epoll_create1 failed&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 注册信号处理（使用signalfd）</span>
<span class="w">        </span><span class="kt">sigset_t</span><span class="w"> </span><span class="n">mask</span><span class="p">;</span>
<span class="w">        </span><span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">);</span>
<span class="w">        </span><span class="n">sigaddset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">SIGCHLD</span><span class="p">);</span>
<span class="w">        </span><span class="n">sigaddset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">SIGTERM</span><span class="p">);</span>
<span class="w">        </span><span class="n">signal_fd_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">signalfd</span><span class="p">(</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">SFD_CLOEXEC</span><span class="p">);</span>
<span class="w">        </span><span class="n">RegisterHandler</span><span class="p">(</span><span class="n">signal_fd_</span><span class="p">,</span><span class="w"> </span><span class="n">HandleSignals</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 注册属性服务</span>
<span class="w">        </span><span class="n">property_fd_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreatePropertySocket</span><span class="p">();</span>
<span class="w">        </span><span class="n">RegisterHandler</span><span class="p">(</span><span class="n">property_fd_</span><span class="p">,</span><span class="w"> </span><span class="n">HandlePropertySet</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 注册控制消息</span>
<span class="w">        </span><span class="n">init_fd_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateInitSocket</span><span class="p">();</span>
<span class="w">        </span><span class="n">RegisterHandler</span><span class="p">(</span><span class="n">init_fd_</span><span class="p">,</span><span class="w"> </span><span class="n">HandleInitSocket</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 注册keychord（组合键）</span>
<span class="w">        </span><span class="n">keychord_fd_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OpenKeychordDevice</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">keychord_fd_</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">RegisterHandler</span><span class="p">(</span><span class="n">keychord_fd_</span><span class="p">,</span><span class="w"> </span><span class="n">HandleKeychord</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">RegisterHandler</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="n">handler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">epoll_event</span><span class="w"> </span><span class="n">ev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">        </span><span class="n">ev</span><span class="p">.</span><span class="n">events</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EPOLLIN</span><span class="p">;</span><span class="w">  </span><span class="c1">// 监听可读事件</span>
<span class="w">        </span><span class="n">ev</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">epoll_ctl</span><span class="p">(</span><span class="n">epoll_fd_</span><span class="p">,</span><span class="w"> </span><span class="n">EPOLL_CTL_ADD</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ev</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">PLOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Failed to add fd &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; to epoll&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">handlers_</span><span class="p">[</span><span class="n">fd</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">handler</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">Wait</span><span class="p">(</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="o">&gt;</span><span class="w"> </span><span class="n">timeout</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">epoll_event</span><span class="w"> </span><span class="n">events</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">timeout_ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timeout</span><span class="p">.</span><span class="n">has_value</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">timeout_ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timeout</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">nr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">epoll_wait</span><span class="p">(</span><span class="n">epoll_fd_</span><span class="p">,</span><span class="w"> </span><span class="n">events</span><span class="p">,</span><span class="w"> </span>
<span class="w">                           </span><span class="n">arraysize</span><span class="p">(</span><span class="n">events</span><span class="p">),</span><span class="w"> </span><span class="n">timeout_ms</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">PLOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;epoll_wait failed&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">nullopt</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nr</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">handlers_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">handlers_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">nullopt</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>主循环实现</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ... 初始化代码 ...</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 1. 执行待处理的Actions</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ActionQueue</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ActionQueue</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
<span class="w">            </span><span class="n">action</span><span class="o">-&gt;</span><span class="n">ExecuteOneCommand</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">action</span><span class="o">-&gt;</span><span class="n">IsCompleted</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">ActionQueue</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 2. 检查需要重启的服务</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ServiceList</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">service</span><span class="p">.</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SVC_RESTARTING</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CurrentTime</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">service</span><span class="p">.</span><span class="n">time_crashed</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                    </span><span class="n">service</span><span class="p">.</span><span class="n">restart_period</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">service</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 3. 计算超时时间</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w">  </span><span class="c1">// 默认无限等待</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ActionQueue</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">// 有待处理命令，立即返回</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">HasRestartingServices</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CalculateRestartTimeout</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 4. 等待事件</span>
<span class="w">        </span><span class="n">epoll_event</span><span class="w"> </span><span class="n">events</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">nr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">epoll_wait</span><span class="p">(</span><span class="n">epoll_fd</span><span class="p">,</span><span class="w"> </span><span class="n">events</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="n">timeout</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 5. 处理事件</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nr</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">handlers_</span><span class="p">[</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span><span class="p">];</span>
<span class="w">            </span><span class="n">handler</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>信号处理机制</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">HandleSignals</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">signalfd_siginfo</span><span class="w"> </span><span class="n">info</span><span class="p">;</span>
<span class="w">    </span><span class="n">read</span><span class="p">(</span><span class="n">signal_fd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">ssi_signo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">SIGCHLD</span><span class="p">:</span>
<span class="w">            </span><span class="n">ReapChildren</span><span class="p">();</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">SIGTERM</span><span class="p">:</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">SIGINT</span><span class="p">:</span>
<span class="w">            </span><span class="n">HandleShutdown</span><span class="p">();</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">SIGUSR1</span><span class="p">:</span>
<span class="w">            </span><span class="n">HandleBootchart</span><span class="p">();</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">ReapChildren</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<span class="w">        </span><span class="kt">pid_t</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">waitpid</span><span class="p">(</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">WNOHANG</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="n">Service</span><span class="o">*</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FindServiceByPid</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">service</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">service</span><span class="o">-&gt;</span><span class="n">Reap</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">service</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SVC_CRITICAL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 关键服务崩溃，可能触发重启</span>
<span class="w">                </span><span class="n">HandleCriticalCrash</span><span class="p">(</span><span class="n">service</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="414">4.1.4 与其他系统的对比</h3>
<p><strong>Linux传统init（SysV/systemd）</strong></p>
<p><em>SysV init特点：</em></p>
<ul>
<li>基于运行级别（0-6），每个级别对应不同的系统状态</li>
<li>使用Shell脚本（/etc/init.d/），串行执行</li>
<li>简单但启动速度慢，缺乏依赖管理</li>
<li>通过<code>update-rc.d</code>或<code>chkconfig</code>管理服务</li>
</ul>
<p><em>systemd特点：</em></p>
<ul>
<li>基于Unit文件（.service、.socket、.target等）</li>
<li>支持依赖关系（Requires、After、Before等）</li>
<li>并行启动服务，显著提升启动速度</li>
<li>Socket激活和D-Bus激活</li>
<li>内置日志系统（journald）</li>
<li>Cgroup集成，更好的资源管理</li>
</ul>
<p><em>Android init对比：</em></p>
<ul>
<li>更轻量级，专为嵌入式设备优化</li>
<li>RC脚本比systemd unit更简单</li>
<li>触发器机制更灵活，适合动态系统状态</li>
<li>深度集成Android特性（属性系统、SELinux）</li>
</ul>
<p><strong>iOS launchd</strong></p>
<p><em>架构特点：</em></p>
<ul>
<li>统一的进程管理器，替代了init、inetd、cron等</li>
<li>使用XML plist文件定义服务</li>
<li>支持多种启动条件（RunAtLoad、StartInterval、WatchPaths等）</li>
<li>XPC（跨进程通信）原生支持</li>
</ul>
<p><em>与Android init对比：</em></p>
<div class="codehilite"><pre><span></span><code>iOS<span class="w"> </span>launchd<span class="w"> </span>plist:
<span class="nt">&lt;dict&gt;</span>
<span class="w">    </span><span class="nt">&lt;key&gt;</span>Label<span class="nt">&lt;/key&gt;</span>
<span class="w">    </span><span class="nt">&lt;string&gt;</span>com.apple.service<span class="nt">&lt;/string&gt;</span>
<span class="w">    </span><span class="nt">&lt;key&gt;</span>ProgramArguments<span class="nt">&lt;/key&gt;</span>
<span class="w">    </span><span class="nt">&lt;array&gt;</span>
<span class="w">        </span><span class="nt">&lt;string&gt;</span>/usr/bin/service<span class="nt">&lt;/string&gt;</span>
<span class="w">    </span><span class="nt">&lt;/array&gt;</span>
<span class="w">    </span><span class="nt">&lt;key&gt;</span>RunAtLoad<span class="nt">&lt;/key&gt;</span>
<span class="w">    </span><span class="nt">&lt;true/&gt;</span>
<span class="nt">&lt;/dict&gt;</span>

Android<span class="w"> </span>RC:
service<span class="w"> </span>apple_service<span class="w"> </span>/system/bin/service
<span class="w">    </span>class<span class="w"> </span>core
<span class="w">    </span>user<span class="w"> </span>system
<span class="w">    </span>group<span class="w"> </span>system
</code></pre></div>

<p><em>权限模型差异：</em></p>
<ul>
<li>iOS：基于entitlements和沙箱profile</li>
<li>Android：基于Linux UID/GID和SELinux</li>
<li>iOS更封闭但更安全，Android更灵活</li>
</ul>
<p><strong>鸿蒙OS init</strong></p>
<p><em>分布式特性：</em></p>
<ul>
<li>服务可以跨设备启动和迁移</li>
<li>分布式软总线支持</li>
<li>能力（Ability）框架集成</li>
<li>支持原子化服务</li>
</ul>
<p><em>与Android对比：</em></p>
<ul>
<li>鸿蒙：<code>distributed_service</code>标签支持跨设备</li>
<li>Android：仅支持本地服务管理</li>
<li>鸿蒙：内置分布式安全认证</li>
<li>Android：需要额外实现跨设备通信</li>
</ul>
<p><em>配置文件对比：</em></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// 鸿蒙服务配置</span>
<span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;services&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">        </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;distributed_service&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/system/bin/d_service&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;distributed&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;capability&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;ohos.permission.DISTRIBUTED_DATA&quot;</span><span class="p">],</span>
<span class="w">        </span><span class="nt">&quot;devices&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;phone&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;tablet&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;tv&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="p">}]</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="42-rc">4.2 RC脚本与系统属性</h2>
<h3 id="421-rc">4.2.1 RC脚本语法</h3>
<p>Android RC（Run Commands）脚本采用自定义的领域特定语言（DSL），主要包含四种语句类型：</p>
<p><strong>Action定义</strong></p>
<div class="codehilite"><pre><span></span><code>on &lt;trigger&gt; [&amp;&amp; &lt;trigger&gt;]*
    &lt;command&gt;
    &lt;command&gt;
    ...
</code></pre></div>

<p><strong>完整的Action示例</strong></p>
<div class="codehilite"><pre><span></span><code>#<span class="w"> </span>早期初始化
on<span class="w"> </span>early-init
<span class="w">    </span>start<span class="w"> </span>ueventd
<span class="w">    </span>mkdir<span class="w"> </span>/mnt/vendor/persist<span class="w"> </span>0771<span class="w"> </span>root<span class="w"> </span>system

#<span class="w"> </span>属性触发器
on<span class="w"> </span>property:sys.boot_completed=1
<span class="w">    </span>setprop<span class="w"> </span>sys.runtime.firstboot.end<span class="w"> </span><span class="cp">${</span><span class="n">ro</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">firstboot</span><span class="o">.</span><span class="n">end</span><span class="cp">}</span>
<span class="w">    </span>exec_background<span class="w"> </span>-<span class="w"> </span>system<span class="w"> </span>system<span class="w"> </span>--<span class="w"> </span>/system/bin/bootstat<span class="w"> </span>--record_boot_complete

#<span class="w"> </span>多条件触发器
on<span class="w"> </span>property:vold.decrypt=trigger_restart_framework<span class="w"> </span><span class="err">&amp;&amp;</span><span class="w"> </span>property:ro.crypto.type=file
<span class="w">    </span>class_start<span class="w"> </span>main
<span class="w">    </span>class_start<span class="w"> </span>late_start
</code></pre></div>

<p><strong>Service定义</strong></p>
<div class="codehilite"><pre><span></span><code>service &lt;name&gt; &lt;pathname&gt; [ &lt;argument&gt; ]*
    &lt;option&gt;
    &lt;option&gt;
    ...
</code></pre></div>

<p><strong>完整的Service示例</strong></p>
<div class="codehilite"><pre><span></span><code><span class="gh">#</span> 基础服务示例
service servicemanager /system/bin/servicemanager
    class core animation
    user system
    group system readproc
    critical
    onrestart restart apexd
    onrestart restart audioserver
    onrestart restart gatekeeperd
    onrestart class_restart main
    writepid /dev/cpuset/system-background/tasks

<span class="gh">#</span> 厂商服务示例（小米）
service mi_thermald /system/bin/mi_thermald
    class main
    user system
    group system
    capabilities SYS_NICE NET_ADMIN
    socket mi_thermald stream 0660 system system
</code></pre></div>

<p><strong>Import语句</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># 静态导入</span>
<span class="kn">import</span> <span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="err">$</span><span class="p">{</span><span class="n">ro</span><span class="o">.</span><span class="n">hardware</span><span class="p">}</span><span class="o">.</span><span class="n">rc</span>
<span class="kn">import</span> <span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">/</span><span class="n">hw</span><span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="err">$</span><span class="p">{</span><span class="n">ro</span><span class="o">.</span><span class="n">hardware</span><span class="p">}</span><span class="o">.</span><span class="n">rc</span>
<span class="kn">import</span> <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">/</span><span class="n">hw</span><span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="err">$</span><span class="p">{</span><span class="n">ro</span><span class="o">.</span><span class="n">zygote</span><span class="p">}</span><span class="o">.</span><span class="n">rc</span>

<span class="c1"># 动态导入（基于属性）</span>
<span class="kn">import</span> <span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="n">recovery</span><span class="o">.</span><span class="err">$</span><span class="p">{</span><span class="n">ro</span><span class="o">.</span><span class="n">hardware</span><span class="p">}</span><span class="o">.</span><span class="n">rc</span>
</code></pre></div>

<p><strong>触发器类型详解</strong></p>
<p><em>启动阶段触发器：</em></p>
<ul>
<li><code>early-init</code>：最早的初始化阶段，SELinux尚未加载</li>
<li><code>init</code>：基础文件系统已挂载</li>
<li><code>late-init</code>：所有init.*触发器完成后</li>
<li><code>boot</code>：/data分区已挂载，加密状态确定</li>
<li><code>post-fs</code>：/system挂载后立即执行</li>
<li><code>post-fs-data</code>：/data挂载并解密后执行</li>
<li><code>zygote-start</code>：在启动zygote前执行</li>
<li><code>early-boot</code>：boot完成后的早期阶段</li>
<li><code>charger</code>：充电模式下的特殊触发器</li>
</ul>
<p><em>属性触发器：</em></p>
<div class="codehilite"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nx">精确匹配</span>
<span class="nx">on</span><span class="w"> </span><span class="nx">property</span><span class="p">:</span><span class="nx">persist</span><span class="p">.</span><span class="nx">sys</span><span class="p">.</span><span class="nx">language</span><span class="p">=</span><span class="nx">zh</span><span class="o">-</span><span class="nx">CN</span>
<span class="w">    </span><span class="nx">setprop</span><span class="w"> </span><span class="nx">persist</span><span class="p">.</span><span class="nx">sys</span><span class="p">.</span><span class="nx">locale</span><span class="w"> </span><span class="nx">zh</span><span class="o">-</span><span class="nx">CN</span>

<span class="err">#</span><span class="w"> </span><span class="nx">通配符匹配</span>
<span class="nx">on</span><span class="w"> </span><span class="nx">property</span><span class="p">:</span><span class="nx">sys</span><span class="p">.</span><span class="nx">boot_from_charger_mode</span><span class="p">=</span><span class="mi">1</span>
<span class="w">    </span><span class="nx">trigger</span><span class="w"> </span><span class="nx">late</span><span class="o">-</span><span class="nx">init</span>

<span class="err">#</span><span class="w"> </span><span class="nx">多属性组合</span>
<span class="nx">on</span><span class="w"> </span><span class="nx">property</span><span class="p">:</span><span class="nx">ro</span><span class="p">.</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">state</span><span class="p">=</span><span class="nx">encrypted</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">property</span><span class="p">:</span><span class="nx">ro</span><span class="p">.</span><span class="nx">crypto</span><span class="p">.</span><span class="k">type</span><span class="p">=</span><span class="nx">file</span>
<span class="w">    </span><span class="nx">start</span><span class="w"> </span><span class="nx">vold_decrypt</span>
</code></pre></div>

<p><em>自定义触发器：</em></p>
<div class="codehilite"><pre><span></span><code># 定义触发器
on enable-logging
    start logd
    start logd-reinit

# 触发自定义触发器
on boot
    trigger enable-logging
</code></pre></div>

<h3 id="422-rc">4.2.2 RC脚本解析器</h3>
<p>Init进程使用<code>ActionParser</code>、<code>ServiceParser</code>等类解析RC文件：</p>
<p><strong>解析器架构</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Parser</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">SectionParser</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">parsers_</span><span class="p">;</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">AddSectionParser</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span>
<span class="w">                         </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">SectionParser</span><span class="o">&gt;</span><span class="w"> </span><span class="n">parser</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">parsers_</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">parser</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">ParseData</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Tokenizer</span><span class="w"> </span><span class="n">tokenizer</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">tokenizer</span><span class="p">.</span><span class="n">HasMore</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">tokens</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokenizer</span><span class="p">.</span><span class="n">GetLine</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IsSectionStart</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">current_parser_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parsers_</span><span class="p">[</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">current_parser_</span><span class="o">-&gt;</span><span class="n">ParseLine</span><span class="p">(</span><span class="n">tokens</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>解析流程</strong></p>
<ol>
<li><strong>词法分析（Tokenizer）</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// 将文本分解为Token，处理引号、转义字符</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Tokenizer</span><span class="o">::</span><span class="n">GetLine</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 跳过空白和注释</span>
<span class="w">    </span><span class="n">SkipWhitespace</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;#&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">SkipToNextLine</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 解析token</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">IsEndOfLine</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current_</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;&quot;&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">tokens</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ParseQuotedString</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">tokens</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ParseWord</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<ol start="2">
<li><strong>语法分析（Parser）</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ActionParser</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">SectionParser</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">ParseSection</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// &quot;on&quot; &lt;trigger&gt; [&amp;&amp; &lt;trigger&gt;]*</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">Action</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&amp;&amp;&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
<span class="w">            </span><span class="n">action</span><span class="o">-&gt;</span><span class="n">AddTrigger</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">ParseLine</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 解析命令</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Command</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
<span class="w">        </span><span class="n">current_action_</span><span class="o">-&gt;</span><span class="n">AddCommand</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<ol start="3">
<li><strong>语义检查</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kt">bool</span><span class="w"> </span><span class="nf">Service::ParseLine</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">OptionParserMap</span><span class="w"> </span><span class="n">option_parsers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;class&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ParseClass</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ParseUser</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;group&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ParseGroup</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;capabilities&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ParseCapabilities</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;seclabel&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ParseSeclabel</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;oneshot&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ParseOneshot</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;disabled&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ParseDisabled</span><span class="p">},</span>
<span class="w">        </span><span class="c1">// ... 更多选项</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">parser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">option_parsers</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parser</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">option_parsers</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Error</span><span class="p">(</span><span class="s">&quot;Invalid option: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">parser</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<ol start="4">
<li><strong>变量替换和条件处理</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// 属性值替换</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="nf">ExpandProps</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">src</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ${property_name} -&gt; property_value</span>
<span class="w">    </span><span class="c1">// ${property_name:-default} -&gt; 带默认值</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">regex</span><span class="w"> </span><span class="n">prop_regex</span><span class="p">(</span><span class="sa">R</span><span class="s">&quot;</span><span class="dl">(</span><span class="s">\$\{([^}]+)\}</span><span class="dl">)</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">regex_replace</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">prop_regex</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="p">[](</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">smatch</span><span class="o">&amp;</span><span class="w"> </span><span class="n">match</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">GetProperty</span><span class="p">(</span><span class="n">match</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">str</span><span class="p">());</span>
<span class="w">        </span><span class="p">});</span>
<span class="p">}</span>

<span class="c1">// 条件导入</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="o">::</span><span class="n">base</span><span class="o">::</span><span class="n">GetBoolProperty</span><span class="p">(</span><span class="s">&quot;ro.debuggable&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ParseConfig</span><span class="p">(</span><span class="s">&quot;/system/etc/init/debug.rc&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>解析优化</strong></p>
<ul>
<li>预编译的二进制格式（.rcb文件）</li>
<li>缓存解析结果避免重复解析</li>
<li>并行解析多个RC文件</li>
<li>增量解析支持动态加载</li>
</ul>
<h3 id="423">4.2.3 系统属性服务</h3>
<p>Android的Property Service提供了一个全局的键值对存储系统：</p>
<p><strong>属性分类</strong></p>
<ul>
<li><code>ro.*</code>：只读属性，启动后不可修改</li>
<li><code>persist.*</code>：持久化属性，重启后保留</li>
<li><code>sys.*</code>：系统控制属性</li>
<li><code>debug.*</code>：调试属性</li>
</ul>
<p><strong>实现机制</strong></p>
<ol>
<li>属性存储在共享内存区域（<code>/dev/__properties__</code>）</li>
<li>通过Unix域套接字<code>/dev/socket/property_service</code>接收设置请求</li>
<li>Init进程验证权限后更新共享内存</li>
<li>通过<code>property_changed</code>触发器通知监听者</li>
</ol>
<p><strong>访问控制</strong></p>
<ul>
<li>SELinux上下文检查</li>
<li>UID/GID权限验证</li>
<li>属性前缀白名单</li>
</ul>
<h3 id="424">4.2.4 厂商定制扩展</h3>
<p>各厂商在RC脚本中添加了大量定制：</p>
<p><strong>小米MIUI</strong></p>
<ul>
<li>添加<code>on property:ro.miui.version</code>触发器</li>
<li>自定义<code>mi_thermald</code>温控服务</li>
<li>扩展<code>persist.sys.miui.*</code>属性族</li>
</ul>
<p><strong>OPPO ColorOS</strong></p>
<ul>
<li><code>oplus_init</code>阶段用于厂商服务初始化</li>
<li>自定义<code>oplusreserve</code>分区挂载</li>
<li>AI调度相关属性配置</li>
</ul>
<p><strong>华为EMUI</strong></p>
<ul>
<li><code>hw_init</code>触发器族</li>
<li>分布式能力相关服务配置</li>
<li>安全增强属性设置</li>
</ul>
<h2 id="43-selinux">4.3 SELinux策略加载</h2>
<h3 id="431-androidselinux">4.3.1 Android中的SELinux</h3>
<p>SELinux（Security-Enhanced Linux）为Android提供了强制访问控制（MAC）机制。与传统Linux发行版不同，Android对SELinux进行了深度定制：</p>
<p><strong>Android SELinux特点</strong></p>
<ul>
<li>精简的策略集，专注于应用隔离</li>
<li>与UID/GID权限模型协同工作</li>
<li>支持动态策略更新（部分场景）</li>
<li>厂商可扩展的策略框架</li>
</ul>
<p><strong>策略组成</strong></p>
<ol>
<li><strong>平台策略</strong>（Platform Policy）：AOSP提供的基础策略</li>
<li><strong>厂商策略</strong>（Vendor Policy）：设备制造商添加的策略</li>
<li><strong>ODM策略</strong>（ODM Policy）：设备定制商的策略</li>
</ol>
<h3 id="432">4.3.2 策略加载流程</h3>
<p>Init进程负责在启动早期加载SELinux策略：</p>
<p><strong>First Stage Init中的加载</strong></p>
<div class="codehilite"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">检查内核是否支持SELinux</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">从</span><span class="o">/</span><span class="kr">sys</span><span class="n">tem</span><span class="err">、</span><span class="o">/</span><span class="n">vendor等分区读取策略文件</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">编译并加载到内核</span>
<span class="mf">4.</span><span class="w"> </span><span class="n">设置enforcing模式</span>
</code></pre></div>

<p><strong>关键函数调用链</strong></p>
<ul>
<li><code>SelinuxInitialize()</code> → <code>LoadPolicy()</code> → <code>security_load_policy()</code></li>
<li>策略文件位置：<code>/system/etc/selinux/</code>, <code>/vendor/etc/selinux/</code></li>
</ul>
<p><strong>策略编译过程</strong></p>
<ol>
<li>读取多个CIL（Common Intermediate Language）文件</li>
<li>使用<code>libsepol</code>合并策略</li>
<li>编译为二进制格式</li>
<li>通过<code>/sys/fs/selinux/load</code>加载到内核</li>
</ol>
<h3 id="433">4.3.3 上下文管理</h3>
<p>SELinux上下文格式：<code>user:role:type:sensitivity[:categories]</code></p>
<p><strong>Init进程的上下文转换</strong></p>
<ul>
<li>初始上下文：<code>u:r:kernel:s0</code></li>
<li>First Stage：<code>u:r:init:s0</code></li>
<li>Second Stage：根据服务定义切换</li>
</ul>
<p><strong>文件上下文恢复</strong>
Init进程使用<code>restorecon</code>恢复文件的SELinux标签：</p>
<ul>
<li><code>/file_contexts</code>定义文件标签规则</li>
<li>递归恢复关键目录（/data、/cache等）</li>
<li>支持增量恢复优化性能</li>
</ul>
<h3 id="434">4.3.4 与其他安全机制对比</h3>
<p><strong>iOS沙箱</strong></p>
<ul>
<li>基于BSD的MAC框架</li>
<li>以App为中心的隔离模型</li>
<li>更严格的进程间通信限制</li>
<li>无需显式策略配置</li>
</ul>
<p><strong>鸿蒙安全架构</strong></p>
<ul>
<li>分布式安全能力认证</li>
<li>基于标签的访问控制</li>
<li>跨设备安全策略同步</li>
<li>AI驱动的动态权限调整</li>
</ul>
<p><strong>Linux AppArmor</strong></p>
<ul>
<li>路径基础的访问控制</li>
<li>更简单的策略语法</li>
<li>较低的性能开销</li>
<li>更适合桌面环境</li>
</ul>
<h2 id="44">4.4 早期启动优化技术</h2>
<h3 id="441">4.4.1 并行化启动</h3>
<p>Android通过多种技术实现服务的并行启动：</p>
<p><strong>异步服务启动</strong></p>
<ul>
<li>使用<code>class_start</code>批量启动同类服务</li>
<li>非关键服务延迟到<code>late_init</code>阶段</li>
<li>利用多核CPU并行初始化</li>
</ul>
<p><strong>依赖管理优化</strong></p>
<div class="codehilite"><pre><span></span><code>service critical_service /system/bin/critical
    class core
    priority -20

service normal_service /system/bin/normal
    class late_start
    after critical_service
</code></pre></div>

<h3 id="442">4.4.2 关键路径优化</h3>
<p><strong>I/O优化</strong></p>
<ul>
<li>预读取（readahead）关键文件</li>
<li>合并小文件读取请求</li>
<li>使用<code>mmap</code>减少内存拷贝</li>
</ul>
<p><strong>内存优化</strong></p>
<ul>
<li>延迟非必要的内存分配</li>
<li>共享只读数据段</li>
<li>优化RC脚本解析缓存</li>
</ul>
<p><strong>CPU调度优化</strong></p>
<ul>
<li>关键服务使用实时调度策略</li>
<li>CPU亲和性设置</li>
<li>大小核调度优化</li>
</ul>
<h3 id="443">4.4.3 厂商优化案例</h3>
<p><strong>高通Quick Boot</strong></p>
<ul>
<li>保存内存快照到UFS/eMMC</li>
<li>跳过部分硬件初始化</li>
<li>缩短到2-3秒冷启动</li>
</ul>
<p><strong>联发科Fast Boot</strong></p>
<ul>
<li>硬件级启动加速</li>
<li>并行化外设初始化</li>
<li>预编译RC脚本缓存</li>
</ul>
<p><strong>三星优化</strong></p>
<ul>
<li>自定义<code>samsung_init</code>阶段</li>
<li>AI预测服务启动顺序</li>
<li>动态调整启动优先级</li>
</ul>
<h3 id="444">4.4.4 启动时间分析工具</h3>
<p><strong>bootchart</strong></p>
<ul>
<li>记录启动过程的系统状态</li>
<li>生成可视化时间线图</li>
<li>识别启动瓶颈</li>
</ul>
<p><strong>systrace</strong></p>
<ul>
<li>更细粒度的性能分析</li>
<li>支持自定义追踪点</li>
<li>与Chrome追踪工具集成</li>
</ul>
<p><strong>厂商工具</strong></p>
<ul>
<li>MIUI：<code>miui_boottime_analyzer</code></li>
<li>ColorOS：<code>oplus_boot_tracker</code></li>
<li>EMUI：<code>hw_bootprof</code></li>
</ul>
<h2 id="_1">本章小结</h2>
<p>本章深入剖析了Android Init进程的核心机制：</p>
<ol>
<li><strong>Init进程架构</strong>：两阶段启动模型，事件驱动的主循环，与Linux/iOS/鸿蒙的设计对比</li>
<li><strong>RC脚本系统</strong>：DSL语法设计，触发器机制，解析器实现，厂商扩展方案</li>
<li><strong>属性服务</strong>：共享内存实现，权限控制模型，属性分类与持久化</li>
<li><strong>SELinux集成</strong>：策略加载流程，上下文管理，与其他MAC机制对比</li>
<li><strong>启动优化</strong>：并行化技术，I/O/内存/CPU优化，厂商定制方案，性能分析工具</li>
</ol>
<p>关键要点：</p>
<ul>
<li>Init进程的事件驱动架构使得Android启动更加灵活可控</li>
<li>RC脚本的触发器机制支持复杂的启动依赖管理</li>
<li>属性系统提供了轻量级的跨进程配置共享</li>
<li>SELinux的早期加载确保了系统安全性</li>
<li>各厂商通过深度优化将启动时间压缩到秒级</li>
</ul>
<h2 id="_2">练习题</h2>
<h3 id="_3">基础题</h3>
<ol>
<li><strong>Init进程的PID为什么必须是1？</strong></li>
</ol>
<details>
<summary>提示：考虑孤儿进程的处理机制</summary>
<p>答案：在Unix/Linux系统中，PID 1的进程有特殊职责：</p>
<ul>
<li>成为所有孤儿进程的父进程</li>
<li>负责回收僵尸进程</li>
<li>系统关机时最后被终止</li>
<li>内核会确保PID 1进程不会意外退出</li>
</ul>
</details>
<ol start="2">
<li><strong>解释Android属性的命名规则和访问权限机制</strong></li>
</ol>
<details>
<summary>提示：关注属性前缀的含义</summary>
<p>答案：</p>
<ul>
<li><code>ro.*</code>：只读属性，启动时设置后不可修改</li>
<li><code>persist.*</code>：持久化到<code>/data/property</code>，重启保留</li>
<li><code>sys.*</code>：系统控制属性，通常触发系统行为</li>
<li><code>debug.*</code>：调试属性，生产版本可能被忽略</li>
<li>访问权限通过SELinux和UID/GID控制</li>
<li>属性设置需要通过property_service验证</li>
</ul>
</details>
<ol start="3">
<li><strong>RC脚本中的<code>class</code>和<code>disabled</code>选项有什么作用？</strong></li>
</ol>
<details>
<summary>提示：考虑服务的批量管理和按需启动</summary>
<p>答案：</p>
<ul>
<li><code>class</code>：将服务分组，可通过<code>class_start</code>/<code>class_stop</code>批量控制</li>
<li><code>disabled</code>：服务不会自动启动，需要显式<code>start</code>命令或属性触发</li>
<li>结合使用可实现分阶段启动和条件启动</li>
<li>常见class：core、hal、late_start等</li>
</ul>
</details>
<ol start="4">
<li><strong>First Stage Init为什么要以最小化方式实现？</strong></li>
</ol>
<details>
<summary>提示：考虑安全性和可靠性</summary>
<p>答案：</p>
<ul>
<li>SELinux尚未加载，系统处于不安全状态</li>
<li>文件系统未完全就绪，功能受限</li>
<li>减少攻击面，避免安全漏洞</li>
<li>确保关键初始化步骤的可靠性</li>
<li>失败后系统无法恢复，必须极其稳定</li>
</ul>
</details>
<h3 id="_4">挑战题</h3>
<ol start="5">
<li><strong>设计一个RC脚本实现以下需求：当检测到调试版本时自动启动性能分析服务，但在用户版本中禁用</strong></li>
</ol>
<details>
<summary>提示：使用属性触发器和条件判断</summary>
<p>答案：</p>
<div class="codehilite"><pre><span></span><code><span class="nx">service</span><span class="w"> </span><span class="nx">perf_daemon</span><span class="w"> </span><span class="o">/</span><span class="nx">system</span><span class="o">/</span><span class="nx">bin</span><span class="o">/</span><span class="nx">perfmond</span>
<span class="w">    </span><span class="kd">class</span><span class="w"> </span><span class="nx">late_start</span>
<span class="w">    </span><span class="nx">disabled</span>
<span class="w">    </span><span class="nx">user</span><span class="w"> </span><span class="nx">system</span>
<span class="w">    </span><span class="nx">group</span><span class="w"> </span><span class="nx">system</span>

<span class="nx">on</span><span class="w"> </span><span class="nx">property</span><span class="p">:</span><span class="nx">ro</span><span class="p">.</span><span class="nx">debuggable</span><span class="p">=</span><span class="mi">1</span>
<span class="w">    </span><span class="nx">start</span><span class="w"> </span><span class="nx">perf_daemon</span>

<span class="nx">on</span><span class="w"> </span><span class="nx">property</span><span class="p">:</span><span class="nx">ro</span><span class="p">.</span><span class="nx">build</span><span class="p">.</span><span class="k">type</span><span class="p">=</span><span class="nx">user</span>
<span class="w">    </span><span class="nx">stop</span><span class="w"> </span><span class="nx">perf_daemon</span>
</code></pre></div>

</details>
<ol start="6">
<li><strong>分析以下场景：某个关键服务反复崩溃重启，Init进程会如何处理？如何优化？</strong></li>
</ol>
<details>
<summary>提示：考虑服务重启策略和退避机制</summary>
<p>答案：
Init进程的处理：</p>
<ul>
<li>默认立即重启崩溃的服务</li>
<li>使用<code>restart_period</code>限制重启频率</li>
<li>记录重启次数到属性<code>init.svc.&lt;name&gt;.restarts</code></li>
<li>可能触发<code>on service-exited</code>动作</li>
</ul>
<p>优化方案：</p>
<ul>
<li>设置<code>restart_period</code>和<code>timeout_period</code></li>
<li>使用<code>critical</code>标记触发系统重启</li>
<li>添加<code>onrestart</code>执行清理操作</li>
<li>实现指数退避算法延迟重启</li>
<li>添加看门狗监控服务健康状态</li>
</ul>
</details>
<ol start="7">
<li><strong>比较Android的property机制与Windows注册表、iOS的NSUserDefaults，分析各自优劣</strong></li>
</ol>
<details>
<summary>提示：从性能、安全性、使用便利性等角度分析</summary>
<p>答案：
Android Property：</p>
<ul>
<li>优点：内存映射高性能，触发器机制灵活，权限控制细粒度</li>
<li>缺点：值类型单一（字符串），大小限制（92字节），无事务支持</li>
</ul>
<p>Windows注册表：</p>
<ul>
<li>优点：层次结构清晰，支持多种数据类型，有事务支持</li>
<li>缺点：性能开销大，容易污染，权限管理复杂</li>
</ul>
<p>iOS NSUserDefaults：</p>
<ul>
<li>优点：类型安全，与应用生命周期集成，自动同步iCloud</li>
<li>缺点：仅限应用内使用，无系统级配置，大数据性能差</li>
</ul>
<p>使用场景：</p>
<ul>
<li>Android适合系统配置和跨进程通信</li>
<li>Windows适合复杂配置管理</li>
<li>iOS适合应用偏好设置</li>
</ul>
</details>
<ol start="8">
<li><strong>设计一个启动时间优化方案，将系统启动时间从10秒优化到5秒</strong></li>
</ol>
<details>
<summary>提示：分析启动瓶颈，考虑并行化和延迟加载</summary>
<p>答案：
分析阶段：</p>
<ol>
<li>使用bootchart识别耗时服务</li>
<li>分析I/O等待和CPU空闲时间</li>
<li>检查服务依赖关系</li>
</ol>
<p>优化策略：</p>
<ol>
<li>
<p><strong>并行化</strong>：
   - 独立服务改为不同class并行启动
   - 硬件初始化并行化（如Wi-Fi和蓝牙）</p>
</li>
<li>
<p><strong>延迟加载</strong>：
   - 非关键服务延迟到开机动画后
   - 按需启动很少使用的服务</p>
</li>
<li>
<p><strong>I/O优化</strong>：
   - 预读取常用文件到内存
   - 合并小文件减少寻道
   - 使用squashfs等压缩文件系统</p>
</li>
<li>
<p><strong>CPU优化</strong>：
   - 启动时锁定最高频率
   - 关键服务绑定大核
   - 优化编译参数减少初始化开销</p>
</li>
<li>
<p><strong>厂商定制</strong>：
   - 实现suspend-to-disk快速恢复
   - 硬件级启动加速（bootloader优化）
   - AI预测用户常用服务优先加载</p>
</li>
</ol>
</details>
<h2 id="gotchas">常见陷阱与错误 (Gotchas)</h2>
<ol>
<li>
<p><strong>RC脚本语法错误</strong>
   - 错误：使用Tab缩进（必须用空格）
   - 错误：命令参数包含未转义的特殊字符
   - 错误：service名称包含点号或斜杠</p>
</li>
<li>
<p><strong>属性设置失败</strong>
   - 原因：SELinux拒绝访问
   - 原因：属性名超过31字符限制
   - 原因：属性值超过91字符限制</p>
</li>
<li>
<p><strong>服务启动失败</strong>
   - 忘记设置正确的文件权限和SELinux标签
   - 依赖的资源未就绪（如/data未挂载）
   - 用户/组不存在或权限不足</p>
</li>
<li>
<p><strong>SELinux相关</strong>
   - 在permissive模式下测试正常，enforcing模式失败
   - 忘记更新file_contexts导致标签错误
   - 域转换失败导致服务运行在错误上下文</p>
</li>
<li>
<p><strong>性能陷阱</strong>
   - 同步等待导致启动串行化
   - 过早启动大量服务导致资源竞争
   - 频繁的属性变化触发过多action</p>
</li>
</ol>
<h2 id="_5">最佳实践检查清单</h2>
<h3 id="rc">RC脚本设计</h3>
<ul>
<li>[ ] 使用有意义的service和action名称</li>
<li>[ ] 合理设置service的class分组</li>
<li>[ ] 必要时使用disabled+触发器启动</li>
<li>[ ] 设置合适的oom_score_adjust保护关键服务</li>
<li>[ ] 使用capabilities替代root权限</li>
</ul>
<h3 id="_6">属性使用</h3>
<ul>
<li>[ ] 遵循命名规范（如厂商属性使用vendor.前缀）</li>
<li>[ ] 敏感信息不要存储在属性中</li>
<li>[ ] 使用persist.*保存需要持久化的配置</li>
<li>[ ] 避免高频属性更新（考虑性能影响）</li>
</ul>
<h3 id="selinux">SELinux策略</h3>
<ul>
<li>[ ] 最小权限原则，避免过度授权</li>
<li>[ ] 使用neverallow规则防止策略违规</li>
<li>[ ] 定期审计audit日志发现潜在问题</li>
<li>[ ] 测试enforcing模式下的完整功能</li>
</ul>
<h3 id="_7">启动优化</h3>
<ul>
<li>[ ] 识别并优化关键路径上的服务</li>
<li>[ ] 延迟非必要服务到系统空闲时启动</li>
<li>[ ] 使用工具量化优化效果</li>
<li>[ ] 在不同硬件配置上测试启动时间</li>
</ul>
<h3 id="_8">调试技巧</h3>
<ul>
<li>[ ] 使用<code>getprop</code>和<code>setprop</code>调试属性问题</li>
<li>[ ] 查看<code>/proc/1/</code>了解init进程状态</li>
<li>[ ] 使用<code>dmesg</code>查看内核日志中的SELinux拒绝</li>
<li>[ ] 保存bootchart数据用于性能分析</li>
</ul>
            </article>
            
            <nav class="page-nav"><a href="chapter3.html" class="nav-link prev">← 第3章：硬件抽象层(HAL)</a><a href="chapter5.html" class="nav-link next">第5章：Zygote与应用进程管理 →</a></nav>
        </main>
    </div>
</body>
</html>