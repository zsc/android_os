<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬12ç« ï¼šç›¸æœºä¸å¤šåª’ä½“æ¡†æ¶</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Android OS æ·±åº¦åŸç†è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬1ç« ï¼šAndroidç³»ç»Ÿæ¶æ„æ¦‚è§ˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬2ç« ï¼šLinuxå†…æ ¸å±‚å®šåˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬3ç« ï¼šç¡¬ä»¶æŠ½è±¡å±‚(HAL)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬4ç« ï¼šInitè¿›ç¨‹ä¸ç³»ç»Ÿå¯åŠ¨</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬5ç« ï¼šZygoteä¸åº”ç”¨è¿›ç¨‹ç®¡ç†</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬6ç« ï¼šAndroid Runtime (ART)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬7ç« ï¼šBinder IPCæœºåˆ¶æ·±åº¦å‰–æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬8ç« ï¼šç³»ç»ŸæœåŠ¡æ¶æ„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬9ç« ï¼šContentProviderä¸æ•°æ®å…±äº«</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬10ç« ï¼šAndroidå›¾å½¢ç³»ç»Ÿæ¶æ„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬11ç« ï¼šéŸ³é¢‘ç³»ç»Ÿæ¶æ„</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬12ç« ï¼šç›¸æœºä¸å¤šåª’ä½“æ¡†æ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬13ç« ï¼šAndroidå®‰å…¨æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬14ç« ï¼šå¯†é’¥ç®¡ç†ä¸ç¡¬ä»¶å®‰å…¨</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬15ç« ï¼šæ¼æ´æ¡ˆä¾‹åˆ†æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬16ç« ï¼šNeural Networks API (NNAPI)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬17ç« ï¼šTensorFlow Liteé›†æˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬18ç« ï¼šML Kitä¸è®¾å¤‡ç«¯AI</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬19ç« ï¼šNPU/TPUç¡¬ä»¶åŠ é€Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter20.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬20ç« ï¼šåå¤„ç†å™¨ç³»ç»Ÿé›†æˆ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter21.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬21ç« ï¼šMIUIç³»ç»Ÿæ¶æ„å‰–æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter22.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬22ç« ï¼šColorOS/EMUIæŠ€æœ¯åˆ†æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter23.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬23ç« ï¼šå‚å•†å†…æ ¸ä¸é©±åŠ¨å®šåˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter24.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬24ç« ï¼šå‚å•†AIèƒ½åŠ›å¯¹æ¯”</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter25.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬25ç« ï¼šOriginOSæ·±åº¦å‰–æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter26.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬26ç« ï¼šAndroidè™šæ‹ŸåŒ–æŠ€æœ¯</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter27.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬27ç« ï¼šå®æ—¶æ€§ä¸æ€§èƒ½ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter28.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬28ç« ï¼šé€†å‘å·¥ç¨‹ä¸å®‰å…¨ç ”ç©¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter29.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬29ç« ï¼šAndroidæœªæ¥æ¼”è¿›</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter30.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">é™„å½•Aï¼šè°ƒè¯•å·¥å…·ä¸æŠ€å·§</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter31.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">é™„å½•Bï¼šæºç ç¼–è¯‘ä¸å®šåˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter32.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬32ç« ï¼šå‚è€ƒèµ„æº</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">AndroidOSåŸç†æ•™ç¨‹é¡¹ç›®è¯´æ˜</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="README.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Android OS æ·±åº¦åŸç†è§£æ</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="12">ç¬¬12ç« ï¼šç›¸æœºä¸å¤šåª’ä½“æ¡†æ¶</h1>
<p>Androidçš„ç›¸æœºä¸å¤šåª’ä½“æ¡†æ¶æ˜¯ç³»ç»Ÿä¸­æœ€å¤æ‚çš„å­ç³»ç»Ÿä¹‹ä¸€ï¼Œæ¶‰åŠä»ç¡¬ä»¶æŠ½è±¡å±‚åˆ°åº”ç”¨å±‚çš„å®Œæ•´æ ˆå®ç°ã€‚æœ¬ç« å°†æ·±å…¥å‰–æCamera HALçš„æ¼”è¿›å†ç¨‹ã€MediaCodecçš„æ¶æ„è®¾è®¡ã€Stagefrightå¤šåª’ä½“æ¡†æ¶çš„å®ç°åŸç†ï¼Œå¹¶ä¸iOSçš„AVFoundationè¿›è¡ŒæŠ€æœ¯å¯¹æ¯”ã€‚é€šè¿‡æœ¬ç« å­¦ä¹ ï¼Œè¯»è€…å°†æŒæ¡Androidå¤šåª’ä½“å¤„ç†çš„æ ¸å¿ƒæœºåˆ¶ï¼Œç†è§£å¦‚ä½•å®ç°é«˜æ€§èƒ½çš„ç›¸æœºåº”ç”¨å’Œå¤šåª’ä½“å¤„ç†ã€‚</p>
<h2 id="_1">å­¦ä¹ ç›®æ ‡</h2>
<ol>
<li>ç†è§£Camera HALä»v1åˆ°v3çš„æ¶æ„æ¼”è¿›åŠå…¶è®¾è®¡è€ƒé‡</li>
<li>æŒæ¡MediaCodecä¸OpenMAX ILçš„é›†æˆæœºåˆ¶</li>
<li>æ·±å…¥ç†è§£Stagefrightæ¡†æ¶çš„ç»„ä»¶æ¶æ„å’Œæ•°æ®æµ</li>
<li>å¯¹æ¯”åˆ†æAndroidä¸iOSåœ¨å¤šåª’ä½“å¤„ç†ä¸Šçš„æŠ€æœ¯å·®å¼‚</li>
<li>æŒæ¡å¤šåª’ä½“æ¡†æ¶çš„æ€§èƒ½ä¼˜åŒ–å’Œè°ƒè¯•æŠ€å·§</li>
</ol>
<h2 id="_2">ç« èŠ‚å¤§çº²</h2>
<h3 id="121-camera-hal">12.1 Camera HALæ¼”è¿›</h3>
<ul>
<li>12.1.1 Camera HAL v1åˆ°v3çš„æ¶æ„å˜è¿</li>
<li>12.1.2 Camera2 APIä¸HAL3çš„å¯¹åº”å…³ç³»</li>
<li>12.1.3 Camera ProvideræœåŠ¡æ¶æ„</li>
<li>12.1.4 Multi-Cameraä¸é€»è¾‘ç›¸æœºæ”¯æŒ</li>
</ul>
<h3 id="122-mediacodecomx">12.2 MediaCodecä¸OMX</h3>
<ul>
<li>12.2.1 MediaCodecæ¶æ„è®¾è®¡</li>
<li>12.2.2 OpenMAX ILé›†æˆ</li>
<li>12.2.3 Codec2æ¡†æ¶æ¼”è¿›</li>
<li>12.2.4 ç¡¬ä»¶ç¼–è§£ç å™¨æ¥å…¥</li>
</ul>
<h3 id="123-stagefright">12.3 Stagefrightæ¶æ„</h3>
<ul>
<li>12.3.1 MediaExtractorä¸Parser</li>
<li>12.3.2 MediaCodecç®¡ç†æœºåˆ¶</li>
<li>12.3.3 AudioTrack/VideoTrackå¤„ç†</li>
<li>12.3.4 DRMé›†æˆä¸ä¿æŠ¤</li>
</ul>
<h3 id="124-ios-avfoundation">12.4 ä¸iOS AVFoundationå¯¹æ¯”</h3>
<ul>
<li>12.4.1 æ¶æ„è®¾è®¡å·®å¼‚</li>
<li>12.4.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥å¯¹æ¯”</li>
<li>12.4.3 APIæ˜“ç”¨æ€§åˆ†æ</li>
<li>12.4.4 ç”Ÿæ€ç³»ç»Ÿå·®å¼‚</li>
</ul>
<h3 id="125">12.5 æœ¬ç« å°ç»“</h3>
<h3 id="126">12.6 ç»ƒä¹ é¢˜</h3>
<h3 id="127">12.7 å¸¸è§é™·é˜±ä¸é”™è¯¯</h3>
<h3 id="128">12.8 æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h3>
<h2 id="121-camera-hal_1">12.1 Camera HALæ¼”è¿›</h2>
<h3 id="1211-camera-hal-v1v3">12.1.1 Camera HAL v1åˆ°v3çš„æ¶æ„å˜è¿</h3>
<p>Androidç›¸æœºç¡¬ä»¶æŠ½è±¡å±‚(HAL)ç»å†äº†ä¸‰ä¸ªä¸»è¦ç‰ˆæœ¬çš„æ¼”è¿›ï¼Œæ¯ä¸ªç‰ˆæœ¬éƒ½åæ˜ äº†ç§»åŠ¨æ‘„å½±æŠ€æœ¯çš„è¿›æ­¥å’Œåº”ç”¨éœ€æ±‚çš„å˜åŒ–ã€‚ä»ç®€å•çš„åŒæ­¥æ¥å£åˆ°å¤æ‚çš„å¼‚æ­¥æµå¤„ç†æ¶æ„ï¼Œè¿™ä¸€æ¼”è¿›è¿‡ç¨‹å±•ç°äº†Androidå¦‚ä½•é€‚åº”æ—¥ç›Šå¤æ‚çš„ç›¸æœºç¡¬ä»¶å’Œåº”ç”¨éœ€æ±‚ã€‚</p>
<p><strong>Camera HAL v1 (Legacy HAL)</strong></p>
<p>Camera HAL v1åœ¨Androidæ—©æœŸç‰ˆæœ¬ä¸­å¼•å…¥ï¼Œé‡‡ç”¨äº†ç®€å•ç›´è§‚çš„åŒæ­¥æ¥å£è®¾è®¡ã€‚è¿™ç§è®¾è®¡åœ¨å½“æ—¶æ»¡è¶³äº†åŸºæœ¬çš„ç›¸æœºåŠŸèƒ½éœ€æ±‚ï¼Œä½†éšç€æ™ºèƒ½æ‰‹æœºç›¸æœºæŠ€æœ¯çš„å¿«é€Ÿå‘å±•ï¼Œå…¶å±€é™æ€§é€æ¸æ˜¾ç°ã€‚</p>
<p>HAL v1çš„æ ¸å¿ƒç‰¹å¾ï¼š</p>
<ul>
<li>åŸºäº<code>camera_device_t</code>ç»“æ„ä½“çš„Cæ¥å£ï¼Œç®€å•ä½†ç¼ºä¹æ‰©å±•æ€§</li>
<li>å•ä¸€çš„é¢„è§ˆå’Œæ‹ç…§æ¨¡å¼ï¼Œæ— æ³•åŒæ—¶å¤„ç†å¤šç§ç”¨é€”çš„å›¾åƒæµ</li>
<li>é€šè¿‡å›è°ƒå‡½æ•°<code>camera_data_callback</code>ä¼ é€’å›¾åƒæ•°æ®ï¼Œé‡‡ç”¨æ¨é€æ¨¡å‹</li>
<li>å‚æ•°è®¾ç½®ä½¿ç”¨å­—ç¬¦ä¸²é”®å€¼å¯¹(é€šè¿‡<code>setParameters()</code>å’Œ<code>getParameters()</code>)ï¼Œç¼ºä¹ç±»å‹å®‰å…¨</li>
<li>ä¸æ”¯æŒå¹¶å‘è®¿é—®å¤šä¸ªç›¸æœºï¼Œé™åˆ¶äº†åŒæ‘„ç­‰é«˜çº§åŠŸèƒ½</li>
<li>åŒæ­¥æ“ä½œæ¨¡å‹ï¼ŒæŸäº›æ“ä½œ(å¦‚è‡ªåŠ¨å¯¹ç„¦)ä¼šé˜»å¡è°ƒç”¨çº¿ç¨‹</li>
</ul>
<p>HAL v1çš„æ ¸å¿ƒæ¥å£å‡½æ•°åŒ…æ‹¬ï¼š</p>
<ul>
<li><code>camera_module_t::get_camera_info()</code> - è·å–ç›¸æœºé™æ€ä¿¡æ¯</li>
<li><code>camera_device_t::start_preview()</code> - å¯åŠ¨é¢„è§ˆæµ</li>
<li><code>camera_device_t::take_picture()</code> - è§¦å‘æ‹ç…§</li>
<li><code>camera_device_t::set_callbacks()</code> - è®¾ç½®æ•°æ®å›è°ƒ</li>
<li><code>camera_device_t::auto_focus()</code> - è§¦å‘è‡ªåŠ¨å¯¹ç„¦</li>
<li><code>camera_device_t::cancel_auto_focus()</code> - å–æ¶ˆå¯¹ç„¦æ“ä½œ</li>
</ul>
<p>å‚æ•°ç®¡ç†çš„å±€é™æ€§åœ¨HAL v1ä¸­å°¤ä¸ºçªå‡ºã€‚æ‰€æœ‰å‚æ•°éƒ½é€šè¿‡å­—ç¬¦ä¸²ä¼ é€’ï¼Œå¦‚è®¾ç½®é¢„è§ˆå°ºå¯¸éœ€è¦è°ƒç”¨<code>setParameters("preview-size=1920x1080")</code>ï¼Œè¿™ç§æ–¹å¼å®¹æ˜“å‡ºé”™ä¸”æ€§èƒ½è¾ƒå·®ã€‚</p>
<p><strong>Camera HAL v2çš„è¿‡æ¸¡</strong></p>
<p>HAL v2ä½œä¸ºè¿‡æ¸¡ç‰ˆæœ¬ï¼Œè¯•å›¾è§£å†³v1çš„ä¸€äº›é—®é¢˜ï¼Œä½†å¹¶æœªå¾—åˆ°å¹¿æ³›é‡‡ç”¨ã€‚å®ƒå¼•å…¥äº†ä¸€äº›é‡è¦æ¦‚å¿µï¼Œä¸ºv3çš„è®¾è®¡å¥ å®šäº†åŸºç¡€ï¼š</p>
<ul>
<li>å…ƒæ•°æ®(metadata)ç³»ç»Ÿçš„é›å½¢</li>
<li>æµ(stream)æ¦‚å¿µçš„åˆæ­¥å¼•å…¥</li>
<li>æ›´ç»†ç²’åº¦çš„æ§åˆ¶æ¥å£</li>
</ul>
<p><strong>Camera HAL v3çš„é©æ–°</strong></p>
<p>HAL v3åœ¨Android 5.0(Lollipop)ä¸­å¼•å…¥ï¼Œä»£è¡¨äº†ç›¸æœºæ¶æ„çš„æ ¹æœ¬æ€§å˜é©ã€‚å®ƒé‡‡ç”¨äº†å…¨æ–°çš„è®¾è®¡ç†å¿µï¼Œå°†ç›¸æœºæŠ½è±¡ä¸ºä¸€ä¸ªå¯é…ç½®çš„å›¾åƒå¤„ç†ç®¡é“ã€‚</p>
<ol>
<li><strong>Request/Resultæ¨¡å‹çš„æ·±å…¥è§£æ</strong>ï¼š</li>
</ol>
<p>HAL v3çš„æ ¸å¿ƒæ˜¯è¯·æ±‚/ç»“æœæ¨¡å‹ï¼Œè¿™ç§è®¾è®¡å…è®¸åº”ç”¨ç¨‹åºç²¾ç¡®æ§åˆ¶æ¯ä¸€å¸§çš„æ‹æ‘„å‚æ•°ï¼š</p>
<ul>
<li>æ¯ä¸ªcapture requestæ˜¯ä¸€ä¸ªå®Œæ•´çš„æ‹æ‘„æŒ‡ä»¤ï¼ŒåŒ…å«æ‰€æœ‰æ§åˆ¶å‚æ•°</li>
<li>å¼‚æ­¥å¤„ç†æ¨¡å‹å…è®¸pipelineå¹¶è¡Œå¤„ç†å¤šä¸ªè¯·æ±‚</li>
<li>Resultä¸ä»…åŒ…å«å›¾åƒæ•°æ®ï¼Œè¿˜åŒ…å«å®é™…ä½¿ç”¨çš„å‚æ•°å’Œç»Ÿè®¡ä¿¡æ¯</li>
<li>æ”¯æŒrequesté˜Ÿåˆ—ï¼Œå®ç°æµç•…çš„å‚æ•°åˆ‡æ¢</li>
</ul>
<p>Requestçš„ç”Ÿå‘½å‘¨æœŸï¼š</p>
<div class="codehilite"><pre><span></span><code>Application â†’ Framework â†’ HAL â†’ ISP Hardware
     â†“           â†“          â†“         â†“
CaptureRequest â†’ Request â†’ Process â†’ Capture
     â†‘           â†‘          â†‘         â†‘
CaptureResult â† Result â† Statistics â† Sensor
</code></pre></div>

<ol start="2">
<li><strong>Streamé…ç½®çš„çµæ´»æ€§</strong>ï¼š</li>
</ol>
<p>HAL v3çš„æµæœºåˆ¶æ”¯æŒå¤æ‚çš„å¤šè¾“å‡ºåœºæ™¯ï¼š</p>
<ul>
<li>æ”¯æŒå¤šè¾¾8ä¸ªå¹¶å‘è¾“å‡ºæµ(å…·ä½“æ•°é‡å–å†³äºç¡¬ä»¶èƒ½åŠ›)</li>
<li>æ¯ä¸ªæµå¯ä»¥æœ‰ä¸åŒçš„åˆ†è¾¨ç‡ã€æ ¼å¼å’Œç”¨é€”</li>
<li>é€šè¿‡<code>camera3_stream_t</code>ç»“æ„æè¿°æµå±æ€§ï¼š<ul>
<li>format: è¾“å‡ºæ ¼å¼(YUV_420_888, JPEG, RAWç­‰)</li>
<li>width/height: åˆ†è¾¨ç‡</li>
<li>usage: ç”¨é€”æ ‡å¿—(é¢„è§ˆã€å½•åƒã€é™æ€æ‹æ‘„ç­‰)</li>
<li>max_buffers: æœ€å¤§ç¼“å†²åŒºæ•°é‡</li>
</ul>
</li>
</ul>
<p>å…¸å‹çš„æµé…ç½®ç»„åˆï¼š</p>
<ul>
<li>é¢„è§ˆ(1080p YUV) + æ‹ç…§(4K JPEG) + å½•åƒ(1080p YUV)</li>
<li>é¢„è§ˆ(720p YUV) + æ·±åº¦å›¾(VGA Depth16) + æ‹ç…§(4K JPEG)</li>
<li>é«˜é€Ÿå½•åƒï¼šå•ä¸€æµä½†é«˜å¸§ç‡(1080p@240fps)</li>
</ul>
<ol start="3">
<li><strong>3Aç®—æ³•çš„ç²¾ç¡®æ§åˆ¶</strong>ï¼š</li>
</ol>
<p>HAL v3å°†3A(è‡ªåŠ¨å¯¹ç„¦AFã€è‡ªåŠ¨æ›å…‰AEã€è‡ªåŠ¨ç™½å¹³è¡¡AWB)æ§åˆ¶æå‡åˆ°æ–°çš„å±‚æ¬¡ï¼š</p>
<ul>
<li>ç‹¬ç«‹çš„æ§åˆ¶æ¨¡å¼ï¼šæ¯ä¸ª3Aç»„ä»¶å¯ä»¥ç‹¬ç«‹è®¾ç½®ä¸ºè‡ªåŠ¨ã€æ‰‹åŠ¨æˆ–åŠè‡ªåŠ¨</li>
<li>ç²¾ç¡®çš„çŠ¶æ€æœºï¼šæ¯ä¸ª3Aç»„ä»¶éƒ½æœ‰æ˜ç¡®å®šä¹‰çš„çŠ¶æ€è½¬æ¢</li>
<li>åŒºåŸŸæ§åˆ¶ï¼šæ”¯æŒè®¾ç½®æµ‹å…‰åŒºåŸŸã€å¯¹ç„¦åŒºåŸŸç­‰</li>
<li>é”å®šæœºåˆ¶ï¼šå¯ä»¥é”å®šå½“å‰çš„3Aè®¾ç½®</li>
</ul>
<p>3AçŠ¶æ€æœºç¤ºä¾‹(ä»¥AFä¸ºä¾‹)ï¼š</p>
<div class="codehilite"><pre><span></span><code>INACTIVE â†’ PASSIVE_SCAN â†’ PASSIVE_FOCUSED/PASSIVE_UNFOCUSED
   â†“                              â†“
ACTIVE_SCAN â†’ FOCUSED_LOCKED/NOT_FOCUSED_LOCKED
</code></pre></div>

<ol start="4">
<li><strong>å…ƒæ•°æ®ç³»ç»Ÿçš„å¼ºå¤§åŠŸèƒ½</strong>ï¼š</li>
</ol>
<p>HAL v3å¼•å…¥äº†ç»“æ„åŒ–çš„å…ƒæ•°æ®ç³»ç»Ÿï¼Œæ›¿ä»£äº†v1çš„å­—ç¬¦ä¸²å‚æ•°ï¼š</p>
<ul>
<li>ç±»å‹å®‰å…¨ï¼šæ¯ä¸ªå‚æ•°éƒ½æœ‰æ˜ç¡®çš„æ•°æ®ç±»å‹</li>
<li>åˆ†ç»„ç®¡ç†ï¼šå‚æ•°æŒ‰åŠŸèƒ½åˆ†ç»„(å¦‚android.control.<em>, android.lens.</em>ç­‰)</li>
<li>åŠ¨æ€æŸ¥è¯¢ï¼šå¯ä»¥æŸ¥è¯¢ç¡¬ä»¶æ”¯æŒçš„å‚æ•°èŒƒå›´</li>
<li>é«˜æ•ˆä¼ è¾“ï¼šä½¿ç”¨ç´§å‡‘çš„äºŒè¿›åˆ¶æ ¼å¼</li>
</ul>
<p>é‡è¦çš„å…ƒæ•°æ®ç±»åˆ«ï¼š</p>
<ul>
<li>android.control.*: 3Aå’Œæ•´ä½“æ§åˆ¶</li>
<li>android.sensor.*: ä¼ æ„Ÿå™¨ç›¸å…³å‚æ•°</li>
<li>android.lens.*: é•œå¤´æ§åˆ¶(å¯¹ç„¦è·ç¦»ã€å…‰åœˆç­‰)</li>
<li>android.flash.*: é—ªå…‰ç¯æ§åˆ¶</li>
<li>android.statistics.*: ç»Ÿè®¡ä¿¡æ¯(ç›´æ–¹å›¾ã€äººè„¸æ£€æµ‹ç­‰)</li>
</ul>
<p><strong>HALç‰ˆæœ¬æ¼”è¿›çš„æ€§èƒ½å½±å“</strong></p>
<p>ä»v1åˆ°v3çš„æ¼”è¿›å¸¦æ¥äº†æ˜¾è‘—çš„æ€§èƒ½æå‡ï¼š</p>
<ul>
<li>é›¶æ‹·è´ä¼˜åŒ–ï¼šv3æ”¯æŒç›´æ¥å°†bufferä¼ é€’ç»™åº”ç”¨ï¼Œé¿å…å†…å­˜æ‹·è´</li>
<li>å¹¶è¡Œå¤„ç†ï¼špipelineè®¾è®¡å…è®¸ISPå¹¶è¡Œå¤„ç†å¤šå¸§</li>
<li>é™ä½å»¶è¿Ÿï¼šå¼‚æ­¥æ¨¡å‹å‡å°‘äº†é˜»å¡ç­‰å¾…æ—¶é—´</li>
<li>æ›´å¥½çš„èµ„æºåˆ©ç”¨ï¼šç²¾ç¡®çš„æµé…ç½®é¿å…äº†èµ„æºæµªè´¹</li>
</ul>
<p>æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”ï¼š</p>
<ul>
<li>æ‹ç…§å»¶è¿Ÿï¼šv1çº¦800ms â†’ v3çº¦200ms</li>
<li>å¯åŠ¨æ—¶é—´ï¼šv1çº¦1000ms â†’ v3çº¦400ms</li>
<li>å¸§ç‡ç¨³å®šæ€§ï¼šv3é€šè¿‡pipelineå®ç°æ›´ç¨³å®šçš„å¸§ç‡</li>
<li>åŠŸè€—ä¼˜åŒ–ï¼šv3çš„ç²¾ç¡®æ§åˆ¶å‡å°‘äº†ä¸å¿…è¦çš„å¤„ç†</li>
</ul>
<h3 id="1212-camera2-apihal3">12.1.2 Camera2 APIä¸HAL3çš„å¯¹åº”å…³ç³»</h3>
<p>Camera2 APIæ˜¯Android 5.0å¼•å…¥çš„æ–°ç›¸æœºæ¡†æ¶APIï¼Œä¸“é—¨è®¾è®¡ç”¨äºå……åˆ†å‘æŒ¥HAL3çš„èƒ½åŠ›ã€‚å®ƒä»¬ä¹‹é—´çš„ç´§å¯†é…åˆä½“ç°äº†Androidç›¸æœºæ¶æ„çš„åˆ†å±‚è®¾è®¡ç†å¿µï¼Œæ¯ä¸€å±‚éƒ½æœ‰æ˜ç¡®çš„èŒè´£å’Œæ¥å£ã€‚</p>
<p><strong>å®Œæ•´çš„æ¶æ„å±‚æ¬¡æ˜ å°„</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="nl">åº”ç”¨å±‚</span><span class="p">:</span><span class="w"> </span><span class="n">Camera2</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="p">(</span><span class="n">android</span><span class="p">.</span><span class="n">hardware</span><span class="p">.</span><span class="n">camera2</span><span class="p">)</span>
<span class="w">         </span><span class="err">â”œâ”€</span><span class="w"> </span><span class="n">CameraManager</span><span class="w"> </span><span class="p">(</span><span class="n">è®¾å¤‡æšä¸¾å’Œè®¿é—®</span><span class="p">)</span>
<span class="w">         </span><span class="err">â”œâ”€</span><span class="w"> </span><span class="n">CameraDevice</span><span class="w"> </span><span class="p">(</span><span class="n">ç›¸æœºæ§åˆ¶æ¥å£</span><span class="p">)</span>
<span class="w">         </span><span class="err">â”œâ”€</span><span class="w"> </span><span class="n">CameraCaptureSession</span><span class="w"> </span><span class="p">(</span><span class="n">ä¼šè¯ç®¡ç†</span><span class="p">)</span>
<span class="w">         </span><span class="err">â””â”€</span><span class="w"> </span><span class="n">CaptureRequest</span><span class="o">/</span><span class="n">Result</span><span class="w"> </span><span class="p">(</span><span class="n">è¯·æ±‚</span><span class="o">/</span><span class="n">ç»“æœ</span><span class="p">)</span>
<span class="w">            </span><span class="err">â†“</span><span class="w"> </span><span class="p">[</span><span class="n">Binder</span><span class="w"> </span><span class="n">IPC</span><span class="p">]</span>
<span class="nl">æ¡†æ¶å±‚</span><span class="p">:</span><span class="w"> </span><span class="n">CameraService</span><span class="w"> </span><span class="p">(</span><span class="n">system_serverè¿›ç¨‹</span><span class="p">)</span>
<span class="w">         </span><span class="err">â”œâ”€</span><span class="w"> </span><span class="n">CameraDeviceClient</span><span class="w"> </span><span class="p">(</span><span class="n">å®¢æˆ·ç«¯ä»£ç†</span><span class="p">)</span>
<span class="w">         </span><span class="err">â”œâ”€</span><span class="w"> </span><span class="n">Camera3Device</span><span class="w"> </span><span class="p">(</span><span class="n">HAL3é€‚é…å™¨</span><span class="p">)</span>
<span class="w">         </span><span class="err">â””â”€</span><span class="w"> </span><span class="n">StreamingProcessor</span><span class="w"> </span><span class="p">(</span><span class="n">æµå¤„ç†å™¨</span><span class="p">)</span>
<span class="w">            </span><span class="err">â†“</span><span class="w"> </span><span class="p">[</span><span class="n">HIDL</span><span class="o">/</span><span class="n">AIDL</span><span class="p">]</span>
<span class="nl">HALå±‚</span><span class="p">:</span><span class="w"> </span><span class="n">Camera</span><span class="w"> </span><span class="n">HAL3</span><span class="w"> </span><span class="n">Interface</span>
<span class="w">         </span><span class="err">â”œâ”€</span><span class="w"> </span><span class="n">ICameraProvider</span><span class="w"> </span><span class="p">(</span><span class="n">è®¾å¤‡ç®¡ç†</span><span class="p">)</span>
<span class="w">         </span><span class="err">â”œâ”€</span><span class="w"> </span><span class="n">ICameraDevice3</span><span class="w"> </span><span class="p">(</span><span class="n">è®¾å¤‡æ¥å£</span><span class="p">)</span>
<span class="w">         </span><span class="err">â””â”€</span><span class="w"> </span><span class="n">camera3_device_ops</span><span class="w"> </span><span class="p">(</span><span class="n">æ“ä½œæ¥å£</span><span class="p">)</span>
<span class="w">            </span><span class="err">â†“</span><span class="w"> </span><span class="p">[</span><span class="n">å†…æ ¸æ¥å£</span><span class="p">]</span>
<span class="nl">é©±åŠ¨å±‚</span><span class="p">:</span><span class="w"> </span><span class="n">V4L2</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">Proprietary</span><span class="w"> </span><span class="n">Driver</span>
<span class="w">         </span><span class="err">â”œâ”€</span><span class="w"> </span><span class="n">Sensor</span><span class="w"> </span><span class="n">Driver</span><span class="w"> </span><span class="p">(</span><span class="n">ä¼ æ„Ÿå™¨æ§åˆ¶</span><span class="p">)</span>
<span class="w">         </span><span class="err">â”œâ”€</span><span class="w"> </span><span class="n">ISP</span><span class="w"> </span><span class="n">Driver</span><span class="w"> </span><span class="p">(</span><span class="n">å›¾åƒå¤„ç†å™¨</span><span class="p">)</span>
<span class="w">         </span><span class="err">â””â”€</span><span class="w"> </span><span class="n">Flash</span><span class="o">/</span><span class="n">Lens</span><span class="w"> </span><span class="n">Driver</span><span class="w"> </span><span class="p">(</span><span class="n">å¤–è®¾æ§åˆ¶</span><span class="p">)</span>
</code></pre></div>

<p><strong>æ ¸å¿ƒç»„ä»¶çš„è¯¦ç»†å¯¹åº”å…³ç³»</strong>ï¼š</p>
<ol>
<li><strong>è®¾å¤‡ç®¡ç†å±‚çš„æ˜ å°„</strong>ï¼š</li>
</ol>
<p>Camera2 APIçš„<code>CameraManager</code>ä¸HALå±‚çš„provideræœºåˆ¶å¯¹åº”ï¼š</p>
<ul>
<li><code>CameraManager.getCameraIdList()</code> â†’ <code>ICameraProvider.getCameraIdList()</code></li>
<li><code>CameraManager.openCamera()</code> â†’ <code>ICameraDevice.open()</code></li>
<li><code>CameraManager.registerAvailabilityCallback()</code> â†’ Providerçƒ­æ’æ‹”é€šçŸ¥</li>
</ul>
<p>è®¾å¤‡ç‰¹æ€§æŸ¥è¯¢é“¾è·¯ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">CameraCharacteristics</span><span class="w"> </span><span class="p">(</span><span class="n">Java</span><span class="p">)</span><span class="w"> </span>
<span class="w">     </span><span class="err">â†“</span><span class="w"> </span><span class="p">[</span><span class="err">åºåˆ—åŒ–</span><span class="p">]</span>
<span class="n">camera_metadata_t</span><span class="w"> </span><span class="p">(</span><span class="n">Native</span><span class="p">)</span>
<span class="w">     </span><span class="err">â†“</span><span class="w"> </span><span class="p">[</span><span class="err">è§£æ</span><span class="p">]</span>
<span class="err">é™æ€å…ƒæ•°æ®</span><span class="w"> </span><span class="p">(</span><span class="n">HALæä¾›</span><span class="p">)</span>
</code></pre></div>

<ol start="2">
<li><strong>ä¼šè¯ç®¡ç†çš„å¤æ‚æ˜ å°„</strong>ï¼š</li>
</ol>
<p><code>CameraCaptureSession</code>æ˜¯Camera2 APIçš„æ ¸å¿ƒæŠ½è±¡ï¼Œå®ƒå°è£…äº†HAL3çš„æµé…ç½®ï¼š</p>
<p>åˆ›å»ºä¼šè¯çš„æµç¨‹ï¼š</p>
<ul>
<li>åº”ç”¨è°ƒç”¨<code>CameraDevice.createCaptureSession(surfaces)</code></li>
<li>Frameworkå°†Surfaceè½¬æ¢ä¸º<code>camera3_stream_t</code>é…ç½®</li>
<li>è°ƒç”¨HALçš„<code>configure_streams()</code>æ¥å£</li>
<li>HALè¿”å›æ”¯æŒçš„æµé…ç½®</li>
<li>Frameworkåˆ›å»º<code>CameraCaptureSession</code>å¯¹è±¡</li>
</ul>
<p>å…³é”®æ•°æ®ç»“æ„æ˜ å°„ï¼š</p>
<ul>
<li><code>OutputConfiguration</code> â†’ <code>camera3_stream_configuration</code></li>
<li><code>Surface</code> â†’ <code>ANativeWindow</code> â†’ <code>buffer_handle_t</code></li>
<li>æµçš„usage flagsé€šè¿‡<code>GraphicBuffer</code>ä¼ é€’</li>
</ul>
<ol start="3">
<li><strong>è¯·æ±‚/ç»“æœæ¨¡å‹çš„ç²¾ç¡®å¯¹åº”</strong>ï¼š</li>
</ol>
<p>è¿™æ˜¯Camera2ä¸HAL3äº¤äº’çš„æ ¸å¿ƒæœºåˆ¶ï¼š</p>
<p><strong>CaptureRequestè½¬æ¢æµç¨‹</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">CaptureRequest</span><span class="w"> </span><span class="p">(</span><span class="n">Javaå¯¹è±¡</span><span class="p">)</span>
<span class="w">     </span><span class="err">â†“</span><span class="w"> </span><span class="err">åºåˆ—åŒ–</span>
<span class="n">CameraMetadata</span><span class="w"> </span><span class="p">(</span><span class="n">Parcelable</span><span class="p">)</span>
<span class="w">     </span><span class="err">â†“</span><span class="w"> </span><span class="n">Binderä¼ è¾“</span>
<span class="n">camera_metadata_t</span><span class="w"> </span><span class="p">(</span><span class="n">Nativeç»“æ„</span><span class="p">)</span>
<span class="w">     </span><span class="err">â†“</span><span class="w"> </span><span class="err">æ‰“åŒ…</span>
<span class="n">camera3_capture_request_t</span><span class="err">ï¼š</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">uint32_t</span><span class="w"> </span><span class="n">frame_number</span><span class="p">;</span><span class="w">        </span><span class="c1">// å¸§ç¼–å·</span>
<span class="w">    </span><span class="n">camera_metadata_t</span><span class="w"> </span><span class="o">*</span><span class="n">settings</span><span class="p">;</span><span class="w">  </span><span class="c1">// æ§åˆ¶å‚æ•°</span>
<span class="w">    </span><span class="n">camera3_stream_buffer_t</span><span class="w"> </span><span class="o">*</span><span class="n">output_buffers</span><span class="p">;</span><span class="w"> </span><span class="c1">// è¾“å‡ºç¼“å†²åŒº</span>
<span class="w">    </span><span class="n">uint32_t</span><span class="w"> </span><span class="n">num_output_buffers</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>CaptureResultæ„å»ºæµç¨‹</strong>ï¼š
   <code>camera3_capture_result_t (HALè¿”å›)
        â†“ è§£æ
   CameraMetadata + Buffers
        â†“ å›è°ƒ
   CameraCaptureSession.CaptureCallback
        â†“ åˆ†å‘
   onCaptureCompleted(CaptureResult)</code></p>
<ol start="4">
<li><strong>ç¼“å†²åŒºç®¡ç†çš„é«˜æ•ˆæ˜ å°„</strong>ï¼š</li>
</ol>
<p>Camera2ä½¿ç”¨SurfaceæŠ½è±¡ï¼Œåœ¨HALå±‚å¯¹åº”å…·ä½“çš„å›¾å½¢ç¼“å†²åŒºï¼š</p>
<ul>
<li>
<p><strong>Surfaceç±»å‹ä¸ç”¨é€”</strong>ï¼š</p>
<ul>
<li>SurfaceView/TextureView â†’ é¢„è§ˆæ˜¾ç¤º</li>
<li>MediaRecorder/MediaCodec â†’ è§†é¢‘å½•åˆ¶</li>
<li>ImageReader â†’ åº”ç”¨å¤„ç†(å¦‚æ‹ç…§)</li>
<li>RenderScript Allocation â†’ è®¡ç®—å¤„ç†</li>
</ul>
</li>
<li>
<p><strong>ç¼“å†²åŒºæµè½¬æœºåˆ¶</strong>ï¼š</p>
</li>
</ul>
<div class="codehilite"><pre><span></span><code>Application Surface
     â†“ dequeueBuffer()
BufferQueue (ç©ºé—²ç¼“å†²åŒº)
     â†“ 
HALå¡«å……æ•°æ®
     â†“ queueBuffer()
Applicationå¤„ç†/æ˜¾ç¤º
</code></pre></div>

<ul>
<li><strong>é›¶æ‹·è´ä¼˜åŒ–</strong>ï¼š<ul>
<li>ä½¿ç”¨<code>GraphicBuffer</code>å…±äº«å†…å­˜</li>
<li>é€šè¿‡fd(æ–‡ä»¶æè¿°ç¬¦)ä¼ é€’</li>
<li>GPU/ISPç›´æ¥è®¿é—®åŒä¸€å—å†…å­˜</li>
</ul>
</li>
</ul>
<ol start="5">
<li><strong>é”™è¯¯å¤„ç†æœºåˆ¶çš„æ˜ å°„</strong>ï¼š</li>
</ol>
<p>Camera2 APIçš„é”™è¯¯å›è°ƒä¸HAL3çš„é”™è¯¯ç±»å‹å¯¹åº”ï¼š</p>
<ul>
<li>
<p><code>CameraDevice.StateCallback.onError(ERROR_CAMERA_DEVICE)</code> 
     â† <code>CAMERA3_MSG_ERROR_DEVICE</code></p>
</li>
<li>
<p><code>CaptureFailure</code> 
     â† <code>CAMERA3_MSG_ERROR_REQUEST/RESULT/BUFFER</code></p>
</li>
<li>
<p>ä¼šè¯é”™è¯¯è‡ªåŠ¨è§¦å‘<code>onConfigureFailed()</code></p>
</li>
</ul>
<p><strong>å…ƒæ•°æ®ç³»ç»Ÿçš„è¯¦ç»†æ˜ å°„</strong>ï¼š</p>
<p>Camera2 APIçš„å‚æ•°ç³»ç»Ÿç›´æ¥æ˜ å°„åˆ°HAL3çš„å…ƒæ•°æ®ï¼š</p>
<ol>
<li><strong>æ§åˆ¶å‚æ•°æ˜ å°„ç¤ºä¾‹</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// Camera2 APIå±‚</span>
<span class="n">requestBuilder</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">CaptureRequest</span><span class="p">.</span><span class="na">CONTROL_AF_MODE</span><span class="p">,</span><span class="w"> </span>
<span class="w">                  </span><span class="n">CaptureRequest</span><span class="p">.</span><span class="na">CONTROL_AF_MODE_CONTINUOUS_PICTURE</span><span class="p">);</span>

<span class="c1">// æ˜ å°„åˆ°HAL3å…ƒæ•°æ®</span>
<span class="n">uint8_t</span><span class="w"> </span><span class="n">afMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ANDROID_CONTROL_AF_MODE_CONTINUOUS_PICTURE</span><span class="p">;</span>
<span class="n">camera_metadata_entry_t</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="na">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ANDROID_CONTROL_AF_MODE</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TYPE_BYTE</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="na">data</span><span class="p">.</span><span class="na">u8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">afMode</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="p">};</span>
</code></pre></div>

<ol start="2">
<li>
<p><strong>æ‰¹é‡å‚æ•°ä¼˜åŒ–</strong>ï¼š
   - Camera2æ”¯æŒ<code>CaptureRequest.Builder</code>æ¨¡å¼
   - åº•å±‚ä½¿ç”¨<code>camera_metadata_t</code>çš„å†…å­˜æ± 
   - é¿å…é¢‘ç¹çš„å†…å­˜åˆ†é…</p>
</li>
<li>
<p><strong>Vendoræ‰©å±•æ”¯æŒ</strong>ï¼š
   - Camera2é¢„ç•™äº†vendor tagç©ºé—´
   - é€šè¿‡<code>CameraCharacteristics.getAvailableCaptureRequestKeys()</code>æŸ¥è¯¢
   - HALé€šè¿‡<code>vendor_tag_ops</code>æ³¨å†Œè‡ªå®šä¹‰æ ‡ç­¾</p>
</li>
</ol>
<p><strong>æ€§èƒ½å…³é”®è·¯å¾„ä¼˜åŒ–</strong>ï¼š</p>
<ol>
<li>
<p><strong>è¯·æ±‚æ‰¹å¤„ç†</strong>ï¼š
   - <code>captureBurst()</code>å…è®¸ä¸€æ¬¡æäº¤å¤šä¸ªè¯·æ±‚
   - HALå±‚é€šè¿‡<code>process_capture_request()</code>æ‰¹é‡å¤„ç†
   - å‡å°‘è·¨è¿›ç¨‹è°ƒç”¨å¼€é”€</p>
</li>
<li>
<p><strong>å¼‚æ­¥å›è°ƒä¼˜åŒ–</strong>ï¼š
   - ä½¿ç”¨<code>Handler</code>æŒ‡å®šå›è°ƒçº¿ç¨‹
   - é¿å…é˜»å¡ä¸»çº¿ç¨‹
   - HALç»“æœé€šè¿‡<code>notify()</code>å¼‚æ­¥è¿”å›</p>
</li>
<li>
<p><strong>å†…å­˜ç®¡ç†ä¼˜åŒ–</strong>ï¼š
   - é¢„åˆ†é…ç¼“å†²åŒºæ± 
   - é‡ç”¨CaptureRequestå¯¹è±¡
   - å»¶è¿ŸSurfaceåˆ›å»º</p>
</li>
</ol>
<h3 id="1213-camera-provider">12.1.3 Camera ProvideræœåŠ¡æ¶æ„</h3>
<p>Android 8.0å¼•å…¥çš„Trebleæ¶æ„ä»æ ¹æœ¬ä¸Šæ”¹å˜äº†Camera HALçš„éƒ¨ç½²æ–¹å¼ã€‚é€šè¿‡å°†HALå®ç°ç§»è‡³ç‹¬ç«‹è¿›ç¨‹ï¼ŒTrebleä¸ä»…æå‡äº†ç³»ç»Ÿçš„æ¨¡å—åŒ–ç¨‹åº¦ï¼Œè¿˜ä½¿å¾—å‚å•†å¯ä»¥ç‹¬ç«‹æ›´æ–°ç›¸æœºé©±åŠ¨è€Œæ— éœ€ä¿®æ”¹frameworkã€‚</p>
<p><strong>Trebleæ¶æ„çš„è®¾è®¡ç›®æ ‡ä¸å®ç°</strong>ï¼š</p>
<ol>
<li>
<p><strong>è¿›ç¨‹éš”ç¦»çš„ä¼˜åŠ¿</strong>ï¼š
   - Frameworkä¸HALè¿è¡Œåœ¨ä¸åŒè¿›ç¨‹ï¼Œæé«˜ç¨³å®šæ€§
   - HALå´©æºƒä¸ä¼šå½±å“æ•´ä¸ªç³»ç»Ÿ
   - æ”¯æŒSELinuxåŸŸéš”ç¦»ï¼Œå¢å¼ºå®‰å…¨æ€§
   - ä¾¿äºç‹¬ç«‹è°ƒè¯•å’Œæ›´æ–°</p>
</li>
<li>
<p><strong>Camera Providerè¿›ç¨‹æ¨¡å‹è¯¦è§£</strong>ï¼š</p>
</li>
</ol>
<p>è¿›ç¨‹æ¶æ„ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">system_server</span><span class="w"> </span><span class="p">(</span><span class="n">Framework</span><span class="p">)</span>
<span class="w">     </span><span class="err">â†“</span><span class="w"> </span><span class="p">[</span><span class="n">HIDL</span><span class="o">/</span><span class="n">AIDL</span><span class="w"> </span><span class="n">IPC</span><span class="p">]</span>
<span class="n">android</span><span class="p">.</span><span class="n">hardware</span><span class="p">.</span><span class="n">camera</span><span class="p">.</span><span class="n">provider</span><span class="mf">@2.</span><span class="n">x</span><span class="o">-</span><span class="n">service</span><span class="w"> </span><span class="p">(</span><span class="n">ç‹¬ç«‹è¿›ç¨‹</span><span class="p">)</span>
<span class="w">     </span><span class="err">â”œâ”€</span><span class="w"> </span><span class="n">Providerå®ç°</span><span class="w"> </span><span class="p">(</span><span class="n">è®¾å¤‡æšä¸¾å’Œç®¡ç†</span><span class="p">)</span>
<span class="w">     </span><span class="err">â”œâ”€</span><span class="w"> </span><span class="n">Deviceå®ç°</span><span class="w"> </span><span class="p">(</span><span class="n">å…·ä½“ç›¸æœºæ§åˆ¶</span><span class="p">)</span>
<span class="w">     </span><span class="err">â””â”€</span><span class="w"> </span><span class="n">HALæ¨¡å—åŠ è½½</span><span class="w"> </span><span class="p">(</span><span class="n">dlopen</span><span class="w"> </span><span class="n">camera</span><span class="w"> </span><span class="n">HAL</span><span class="w"> </span><span class="p">.</span><span class="n">so</span><span class="p">)</span>
</code></pre></div>

<p>å¯åŠ¨æµç¨‹ï¼š</p>
<ul>
<li>init.rcé…ç½®ProvideræœåŠ¡å¯åŠ¨</li>
<li>Providerè¿›ç¨‹åŠ è½½å‚å•†HALå®ç°(.soæ–‡ä»¶)</li>
<li>å‘hwservicemanageræ³¨å†ŒHIDLæœåŠ¡</li>
<li>CameraServiceé€šè¿‡hwservicemanagerå‘ç°Provider</li>
</ul>
<ol start="3">
<li><strong>HIDLæ¥å£è®¾è®¡çš„ç²¾å¦™ä¹‹å¤„</strong>ï¼š</li>
</ol>
<p>HIDL (HAL Interface Definition Language) æä¾›äº†ç¨³å®šçš„ABIï¼š</p>
<ul>
<li>ç‰ˆæœ¬åŒ–æ¥å£ï¼šæ”¯æŒå¤šç‰ˆæœ¬å…±å­˜</li>
<li>è‡ªåŠ¨ç”Ÿæˆmarshallingä»£ç </li>
<li>æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥è°ƒç”¨</li>
<li>é«˜æ•ˆçš„å…±äº«å†…å­˜ä¼ è¾“æœºåˆ¶</li>
</ul>
<p><strong>æ ¸å¿ƒæ¥å£çš„æ·±å…¥åˆ†æ</strong>ï¼š</p>
<ol>
<li><strong>ICameraProvideræ¥å£çš„å®Œæ•´å®ç°</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">interface</span><span class="w"> </span><span class="n">ICameraProvider</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// è·å–Providerçš„HALç‰ˆæœ¬ç±»å‹</span>
<span class="w">    </span><span class="n">getVendorTags</span><span class="p">()</span><span class="w"> </span><span class="n">generates</span><span class="w"> </span><span class="p">(</span><span class="n">Status</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">vec</span><span class="o">&lt;</span><span class="n">VendorTagSection</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sections</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// æšä¸¾æ‰€æœ‰å¯ç”¨çš„ç›¸æœºè®¾å¤‡</span>
<span class="w">    </span><span class="n">getCameraIdList</span><span class="p">()</span><span class="w"> </span><span class="n">generates</span><span class="w"> </span><span class="p">(</span><span class="n">Status</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">vec</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cameraDeviceNames</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// è·å–ç‰¹å®šç‰ˆæœ¬çš„è®¾å¤‡æ¥å£</span>
<span class="w">    </span><span class="n">getCameraDeviceInterface_V3_x</span><span class="p">(</span><span class="n">string</span><span class="w"> </span><span class="n">cameraDeviceName</span><span class="p">)</span><span class="w"> </span>
<span class="w">        </span><span class="n">generates</span><span class="w"> </span><span class="p">(</span><span class="n">Status</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">ICameraDevice</span><span class="w"> </span><span class="n">device</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// æŸ¥è¯¢è®¾å¤‡æ˜¯å¦æ”¯æŒç‰¹å®šçš„HALç‰ˆæœ¬</span>
<span class="w">    </span><span class="n">isSetTorchModeSupported</span><span class="p">()</span><span class="w"> </span><span class="n">generates</span><span class="w"> </span><span class="p">(</span><span class="n">Status</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">support</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// æ§åˆ¶é—ªå…‰ç¯(æ‰‹ç”µç­’æ¨¡å¼)</span>
<span class="w">    </span><span class="n">setTorchMode</span><span class="p">(</span><span class="n">string</span><span class="w"> </span><span class="n">cameraDeviceName</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">enabled</span><span class="p">)</span><span class="w"> </span>
<span class="w">        </span><span class="n">generates</span><span class="w"> </span><span class="p">(</span><span class="n">Status</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// é€šçŸ¥ç³»ç»ŸçŠ¶æ€å˜åŒ–(å¦‚æŠ˜å å±çŠ¶æ€)</span>
<span class="w">    </span><span class="n">notifyDeviceStateChange</span><span class="p">(</span><span class="n">bitfield</span><span class="o">&lt;</span><span class="n">DeviceState</span><span class="o">&gt;</span><span class="w"> </span><span class="n">newState</span><span class="p">)</span><span class="w"> </span>
<span class="w">        </span><span class="n">generates</span><span class="w"> </span><span class="p">(</span><span class="n">Status</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>å…³é”®æ–¹æ³•çš„å®ç°ç»†èŠ‚ï¼š</p>
<ul>
<li><code>getCameraIdList()</code>: éå†HALæ¨¡å—ï¼Œè¿”å›æ‰€æœ‰ç›¸æœºID</li>
<li><code>getVendorTags()</code>: è¿”å›å‚å•†è‡ªå®šä¹‰çš„å…ƒæ•°æ®æ ‡ç­¾</li>
<li><code>notifyDeviceStateChange()</code>: å¤„ç†è®¾å¤‡å½¢æ€å˜åŒ–(å¦‚æŠ˜å /å±•å¼€)</li>
</ul>
<ol start="2">
<li><strong>ICameraDeviceæ¥å£çš„æ¶æ„è®¾è®¡</strong>ï¼š</li>
</ol>
<p>è®¾å¤‡æ¥å£å°è£…äº†HAL3çš„æ‰€æœ‰æ“ä½œï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">interface</span><span class="w"> </span><span class="n">ICameraDevice</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// è·å–è®¾å¤‡èµ„æºæä¾›è€…æ¥å£</span>
<span class="w">    </span><span class="n">getResourceCost</span><span class="p">()</span><span class="w"> </span><span class="n">generates</span><span class="w"> </span><span class="p">(</span><span class="n">Status</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">CameraResourceCost</span><span class="w"> </span><span class="n">resourceCost</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// è·å–ç›¸æœºé™æ€ç‰¹æ€§</span>
<span class="w">    </span><span class="n">getCameraCharacteristics</span><span class="p">()</span><span class="w"> </span><span class="n">generates</span><span class="w"> </span><span class="p">(</span><span class="n">Status</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">CameraMetadata</span><span class="w"> </span><span class="n">cameraCharacteristics</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// è®¾ç½®è¿æ¥å›è°ƒ</span>
<span class="w">    </span><span class="n">setTorchMode</span><span class="p">(</span><span class="n">TorchMode</span><span class="w"> </span><span class="n">mode</span><span class="p">)</span><span class="w"> </span><span class="n">generates</span><span class="w"> </span><span class="p">(</span><span class="n">Status</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// æ‰“å¼€ç›¸æœºä¼šè¯</span>
<span class="w">    </span><span class="n">open</span><span class="p">(</span><span class="n">ICameraDeviceCallback</span><span class="w"> </span><span class="n">callback</span><span class="p">)</span><span class="w"> </span><span class="n">generates</span><span class="w"> </span><span class="p">(</span><span class="n">Status</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">ICameraDeviceSession</span><span class="w"> </span><span class="n">session</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// å¯¼å‡ºbufferç”¨äºè·¨è¿›ç¨‹å…±äº«</span>
<span class="w">    </span><span class="n">dumpState</span><span class="p">(</span><span class="n">handle</span><span class="w"> </span><span class="n">fd</span><span class="p">)</span><span class="w"> </span><span class="n">generates</span><span class="w"> </span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<p>ä¼šè¯ç®¡ç†çš„å¤æ‚æ€§ï¼š</p>
<ul>
<li>æ¯ä¸ªopen()è°ƒç”¨åˆ›å»ºæ–°çš„Session</li>
<li>Sessionå°è£…äº†HAL3çš„configure/processæ¥å£</li>
<li>é€šè¿‡callbackå®ç°å¼‚æ­¥ç»“æœè¿”å›</li>
</ul>
<ol start="3">
<li><strong>çƒ­æ’æ‹”æœºåˆ¶çš„å®Œæ•´å®ç°</strong>ï¼š</li>
</ol>
<p>çƒ­æ’æ‹”æ”¯æŒå¯¹USBç›¸æœºç­‰å¤–éƒ¨è®¾å¤‡è‡³å…³é‡è¦ï¼š</p>
<p><strong>æ£€æµ‹æœºåˆ¶</strong>ï¼š</p>
<ul>
<li>ç›‘å¬udev/netlinkäº‹ä»¶(Linux)</li>
<li>è§£æUSBè®¾å¤‡æè¿°ç¬¦</li>
<li>éªŒè¯UVC(USB Video Class)å…¼å®¹æ€§</li>
</ul>
<p><strong>é€šçŸ¥æµç¨‹</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">USBè®¾å¤‡æ’å…¥</span>
<span class="w">     </span><span class="err">â†“</span>
<span class="err">å†…æ ¸æ£€æµ‹å¹¶åˆ›å»º</span><span class="n">V4L2è®¾å¤‡èŠ‚ç‚¹</span>
<span class="w">     </span><span class="err">â†“</span>
<span class="n">Providerè¿›ç¨‹æ”¶åˆ°uevent</span>
<span class="w">     </span><span class="err">â†“</span>
<span class="err">æšä¸¾æ–°è®¾å¤‡èƒ½åŠ›</span>
<span class="w">     </span><span class="err">â†“</span>
<span class="err">è°ƒç”¨</span><span class="n">ICameraProviderCallback</span><span class="err">::</span><span class="n">cameraDeviceStatusChange</span><span class="p">()</span>
<span class="w">     </span><span class="err">â†“</span>
<span class="n">CameraServiceæ›´æ–°è®¾å¤‡åˆ—è¡¨</span>
<span class="w">     </span><span class="err">â†“</span>
<span class="err">é€šçŸ¥åº”ç”¨å±‚</span><span class="p">(</span><span class="n">CameraManager</span><span class="o">.</span><span class="n">AvailabilityCallback</span><span class="p">)</span>
</code></pre></div>

<p><strong>åŠ¨æ€IDåˆ†é…ç­–ç•¥</strong>ï¼š</p>
<ul>
<li>å†…ç½®ç›¸æœºï¼šå›ºå®šID (0, 1, 2...)</li>
<li>å¤–éƒ¨ç›¸æœºï¼šåŠ¨æ€ID (100, 101...)</li>
<li>IDæŒä¹…åŒ–ï¼šé€šè¿‡è®¾å¤‡åºåˆ—å·æ˜ å°„</li>
</ul>
<p><strong>Providerå®ç°çš„æ€§èƒ½ä¼˜åŒ–</strong>ï¼š</p>
<ol>
<li>
<p><strong>å¯åŠ¨æ—¶é—´ä¼˜åŒ–</strong>ï¼š
   - å»¶è¿ŸåŠ è½½ï¼šåªåœ¨éœ€è¦æ—¶åŠ è½½å…·ä½“HALæ¨¡å—
   - å¹¶è¡Œåˆå§‹åŒ–ï¼šå¤šç›¸æœºå¹¶å‘åˆå§‹åŒ–
   - ç¼“å­˜æœºåˆ¶ï¼šç¼“å­˜é™æ€characteristics</p>
</li>
<li>
<p><strong>å†…å­˜ä½¿ç”¨ä¼˜åŒ–</strong>ï¼š
   - å…±äº«å†…å­˜æ± ï¼šå¤šä¸ªè®¾å¤‡å…±äº«bufferæ± 
   - æŒ‰éœ€åˆ†é…ï¼šæ ¹æ®æµé…ç½®åŠ¨æ€åˆ†é…å†…å­˜
   - å†…å­˜å‹åŠ›å“åº”ï¼šä½å†…å­˜æ—¶ä¸»åŠ¨é‡Šæ”¾ç¼“å­˜</p>
</li>
<li>
<p><strong>è·¨è¿›ç¨‹é€šä¿¡ä¼˜åŒ–</strong>ï¼š
   - FMQ (Fast Message Queue)ï¼šé«˜é¢‘æ§åˆ¶æ¶ˆæ¯
   - å…±äº«å†…å­˜ï¼šå›¾åƒæ•°æ®é›¶æ‹·è´ä¼ è¾“
   - æ‰¹é‡æ“ä½œï¼šå‡å°‘IPCå¾€è¿”æ¬¡æ•°</p>
</li>
</ol>
<p><strong>å®‰å…¨æ€§è€ƒè™‘</strong>ï¼š</p>
<ol>
<li><strong>SELinuxç­–ç•¥</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nx">camera</span><span class="w"> </span><span class="nx">provideråŸŸå®šä¹‰</span>
<span class="k">type</span><span class="w"> </span><span class="nx">hal_camera_default</span><span class="p">,</span><span class="w"> </span><span class="nx">domain</span><span class="p">;</span>
<span class="nx">hal_server_domain</span><span class="p">(</span><span class="nx">hal_camera_default</span><span class="p">,</span><span class="w"> </span><span class="nx">hal_camera</span><span class="p">)</span>

<span class="err">#</span><span class="w"> </span><span class="nx">å…è®¸è®¿é—®ç›¸æœºè®¾å¤‡èŠ‚ç‚¹</span>
<span class="nx">allow</span><span class="w"> </span><span class="nx">hal_camera_default</span><span class="w"> </span><span class="nx">camera_device</span><span class="p">:</span><span class="nx">chr_file</span><span class="w"> </span><span class="nx">rw_file_perms</span><span class="p">;</span>

<span class="err">#</span><span class="w"> </span><span class="nx">å…è®¸è®¿é—®å›¾å½¢ç¼“å†²åŒº</span>
<span class="nx">allow</span><span class="w"> </span><span class="nx">hal_camera_default</span><span class="w"> </span><span class="nx">gpu_device</span><span class="p">:</span><span class="nx">chr_file</span><span class="w"> </span><span class="nx">rw_file_perms</span><span class="p">;</span>
</code></pre></div>

<ol start="2">
<li>
<p><strong>æƒé™éªŒè¯</strong>ï¼š
   - ProvideréªŒè¯è°ƒç”¨è€…èº«ä»½
   - æ£€æŸ¥ç›¸æœºæƒé™(android.permission.CAMERA)
   - é˜²æ­¢æœªæˆæƒçš„ç›´æ¥HALè®¿é—®</p>
</li>
<li>
<p><strong>èµ„æºé™åˆ¶</strong>ï¼š
   - é™åˆ¶åŒæ—¶æ‰“å¼€çš„ç›¸æœºæ•°é‡
   - å†…å­˜ä½¿ç”¨é…é¢
   - CPUä½¿ç”¨ç‡ç›‘æ§</p>
</li>
</ol>
<p><strong>è°ƒè¯•å’Œè¯Šæ–­å·¥å…·</strong>ï¼š</p>
<ol>
<li><strong>dumpsysæ”¯æŒ</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code>adb<span class="w"> </span>shell<span class="w"> </span>dumpsys<span class="w"> </span>media.camera
<span class="c1"># æ˜¾ç¤ºProviderçŠ¶æ€ã€è®¾å¤‡åˆ—è¡¨ã€æ´»åŠ¨ä¼šè¯ç­‰</span>
</code></pre></div>

<ol start="2">
<li>
<p><strong>æ—¥å¿—ç³»ç»Ÿ</strong>ï¼š
   - ALOGV/D/I/W/Eåˆ†çº§æ—¥å¿—
   - ä¸“ç”¨æ—¥å¿—æ ‡ç­¾ï¼šCameraProvider, Camera3-Device
   - æ€§èƒ½è¿½è¸ªç‚¹ï¼šATRACEæ ‡è®°</p>
</li>
<li>
<p><strong>æµ‹è¯•æ¡†æ¶</strong>ï¼š
   - VTS (Vendor Test Suite)æµ‹è¯•
   - CTSéªŒè¯å…¼å®¹æ€§
   - æ¨¡æ‹ŸProviderç”¨äºæµ‹è¯•</p>
</li>
</ol>
<h3 id="1214-multi-camera">12.1.4 Multi-Cameraä¸é€»è¾‘ç›¸æœºæ”¯æŒ</h3>
<p>Android På¼•å…¥äº†å¤šç›¸æœºAPIï¼Œæ”¯æŒåŒæ—¶è®¿é—®å¤šä¸ªç‰©ç†ç›¸æœºï¼š</p>
<p><strong>ç‰©ç†ç›¸æœºIDæœºåˆ¶</strong>ï¼š</p>
<ul>
<li>é€»è¾‘ç›¸æœºIDæ˜ å°„åˆ°å¤šä¸ªç‰©ç†ç›¸æœºID</li>
<li>é€šè¿‡<code>getPhysicalCameraIds()</code>è·å–ç‰©ç†ç›¸æœºåˆ—è¡¨</li>
<li>æ¯ä¸ªç‰©ç†ç›¸æœºæœ‰ç‹¬ç«‹çš„characteristics</li>
</ul>
<p><strong>åŒæ­¥æœºåˆ¶</strong>ï¼š</p>
<ul>
<li>ç¡¬ä»¶çº§åŒæ­¥ï¼šé€šè¿‡æ—¶é—´æˆ³å¯¹é½</li>
<li>è½¯ä»¶çº§åŒæ­¥ï¼šCameraServiceåè°ƒå¤šä¸ªHALè°ƒç”¨</li>
<li>æ”¯æŒè®¾ç½®per-physical cameraçš„å‚æ•°</li>
</ul>
<p><strong>å…¸å‹åº”ç”¨åœºæ™¯</strong>ï¼š</p>
<ol>
<li>
<p><strong>åŒæ‘„åƒå¤´æ™¯æ·±</strong>ï¼š
   - ä¸»ç›¸æœº + æ·±åº¦ç›¸æœºç»„åˆ
   - å®æ—¶æ™¯æ·±è®¡ç®—å’ŒèƒŒæ™¯è™šåŒ–</p>
</li>
<li>
<p><strong>å¹¿è§’ + é•¿ç„¦åˆ‡æ¢</strong>ï¼š
   - æ— ç¼å˜ç„¦ä½“éªŒ
   - åŸºäºç„¦è·è‡ªåŠ¨é€‰æ‹©ç‰©ç†ç›¸æœº</p>
</li>
<li>
<p><strong>å¤šç›¸æœºèåˆ</strong>ï¼š
   - HDR+åœºæ™¯ï¼šå¤šå¸§èåˆ
   - å¤œæ™¯æ¨¡å¼ï¼šé•¿æ›å…‰å †æ ˆ</p>
</li>
</ol>
<p><strong>å®ç°è€ƒé‡</strong>ï¼š</p>
<ul>
<li>ç¼“å†²åŒºç®¡ç†ï¼šé¿å…å†…å­˜è¿‡åº¦æ¶ˆè€—</li>
<li>åŠŸè€—ä¼˜åŒ–ï¼šæ™ºèƒ½å¼€å…³ç‰©ç†ç›¸æœº</li>
<li>ISPèµ„æºè°ƒåº¦ï¼šç¡¬ä»¶èµ„æºç«äº‰å¤„ç†</li>
</ul>
<h2 id="122-mediacodecomx_1">12.2 MediaCodecä¸OMX</h2>
<h3 id="1221-mediacodec">12.2.1 MediaCodecæ¶æ„è®¾è®¡</h3>
<p>MediaCodecæ˜¯Androidå¤šåª’ä½“æ¡†æ¶çš„æ ¸å¿ƒç»„ä»¶ï¼Œæä¾›äº†è®¿é—®åº•å±‚ç¼–è§£ç å™¨çš„é«˜çº§APIã€‚å…¶æ¶æ„è®¾è®¡ä½“ç°äº†çµæ´»æ€§å’Œæ€§èƒ½çš„å¹³è¡¡ã€‚</p>
<p><strong>æ ¸å¿ƒè®¾è®¡åŸåˆ™</strong>ï¼š</p>
<ol>
<li>
<p><strong>çŠ¶æ€æœºæ¨¡å‹</strong>ï¼š
   - Uninitialized â†’ Configured â†’ Executing â†’ Released
   - é€šè¿‡æ˜ç¡®çš„çŠ¶æ€è½¬æ¢ä¿è¯æ“ä½œçš„æœ‰æ•ˆæ€§
   - å¼‚æ­¥å’ŒåŒæ­¥ä¸¤ç§æ“ä½œæ¨¡å¼</p>
</li>
<li>
<p><strong>ç¼“å†²åŒºç®¡ç†</strong>ï¼š
   - Input/Output Bufferé˜Ÿåˆ—æœºåˆ¶
   - é€šè¿‡<code>dequeueInputBuffer()</code>å’Œ<code>dequeueOutputBuffer()</code>ç®¡ç†
   - æ”¯æŒSurfaceç›´æ¥æ¸²æŸ“(Surfaceæ¨¡å¼)</p>
</li>
<li>
<p><strong>æ•°æ®æµæ¨¡å‹</strong>ï¼š</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">Input</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="p">[</span><span class="n">Input</span><span class="w"> </span><span class="n">Buffer</span><span class="p">]</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Codec</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="p">[</span><span class="n">Output</span><span class="w"> </span><span class="n">Buffer</span><span class="p">]</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Output</span><span class="w"> </span><span class="n">Data</span>
<span class="w">                                 </span><span class="err">â†“</span>
<span class="w">                           </span><span class="p">[</span><span class="n">Surface</span><span class="w"> </span><span class="n">Rendering</span><span class="p">]</span>
</code></pre></div>

<p><strong>å…³é”®APIæ¥å£</strong>ï¼š</p>
<ul>
<li><code>configure()</code> - é…ç½®ç¼–è§£ç å™¨å‚æ•°</li>
<li><code>start()</code> - å¯åŠ¨ç¼–è§£ç å™¨</li>
<li><code>queueInputBuffer()</code> - æäº¤è¾“å…¥æ•°æ®</li>
<li><code>releaseOutputBuffer()</code> - é‡Šæ”¾è¾“å‡ºç¼“å†²åŒº</li>
</ul>
<h3 id="1222-openmax-il">12.2.2 OpenMAX ILé›†æˆ</h3>
<p>OpenMAX IL (Integration Layer) æ˜¯Khronoså®šä¹‰çš„å¤šåª’ä½“ç»„ä»¶æ ‡å‡†æ¥å£ï¼ŒAndroidé€šè¿‡OMXå®ç°ç¡¬ä»¶ç¼–è§£ç å™¨çš„æŠ½è±¡ã€‚</p>
<p><strong>OMXç»„ä»¶æ¶æ„</strong>ï¼š</p>
<ol>
<li>
<p><strong>OMX Core</strong>ï¼š
   - ç»„ä»¶æšä¸¾å’ŒåŠ è½½: <code>OMX_GetHandle()</code>
   - ç»„ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†
   - é€šè¿‡<code>libstagefright_omx</code>å®ç°</p>
</li>
<li>
<p><strong>OMX Component</strong>ï¼š
   - æ ‡å‡†åŒ–çš„ç»„ä»¶æ¥å£: <code>OMX_COMPONENTTYPE</code>
   - Portæ¦‚å¿µï¼šè¾“å…¥è¾“å‡ºæ•°æ®é€šé“
   - å‚æ•°å’Œé…ç½®æ¥å£ï¼š<code>OMX_SetParameter()</code>, <code>OMX_SetConfig()</code></p>
</li>
<li>
<p><strong>Bufferåˆ†é…æœºåˆ¶</strong>ï¼š
   - UseBufferæ¨¡å¼ï¼šä½¿ç”¨å®¢æˆ·ç«¯åˆ†é…çš„ç¼“å†²åŒº
   - AllocateBufferæ¨¡å¼ï¼šç»„ä»¶å†…éƒ¨åˆ†é…
   - UseAndroidNativeBufferï¼šæ”¯æŒGraphicBuffer</p>
</li>
</ol>
<p><strong>Android OMXæ‰©å±•</strong>ï¼š</p>
<ul>
<li><code>OMX.google.*</code> - Googleè½¯ä»¶ç¼–è§£ç å™¨</li>
<li><code>OMX.qcom.*</code> - é«˜é€šç¡¬ä»¶ç¼–è§£ç å™¨</li>
<li>å‚å•†ç‰¹å®šæ‰©å±•ï¼šå¦‚<code>OMX_IndexParamAndroidAdaptivePlayback</code></li>
</ul>
<h3 id="1223-codec2">12.2.3 Codec2æ¡†æ¶æ¼”è¿›</h3>
<p>Android På¼•å…¥Codec2æ¡†æ¶ï¼Œæ—¨åœ¨æ›¿ä»£è€åŒ–çš„OMXï¼Œæä¾›æ›´ç°ä»£çš„ç¼–è§£ç å™¨æ¥å£ã€‚</p>
<p><strong>Codec2ä¼˜åŠ¿</strong>ï¼š</p>
<ol>
<li>
<p><strong>ç®€åŒ–çš„æ¥å£è®¾è®¡</strong>ï¼š
   - åŸºäºC++çš„ç±»å‹å®‰å…¨æ¥å£
   - å‚æ•°ç³»ç»Ÿæ›´åŠ çµæ´»ï¼š<code>C2Param</code>ä½“ç³»
   - å‡å°‘çŠ¶æ€å¤æ‚åº¦</p>
</li>
<li>
<p><strong>æ”¹è¿›çš„ç¼“å†²åŒºç®¡ç†</strong>ï¼š
   - C2Bufferç»Ÿä¸€ç¼“å†²åŒºæŠ½è±¡
   - æ”¯æŒæ›´å¤æ‚çš„å†…å­˜ç±»å‹(å¦‚secure buffer)
   - Zero-copyä¼˜åŒ–</p>
</li>
<li>
<p><strong>ç»„ä»¶å‘ç°æœºåˆ¶</strong>ï¼š
   - é€šè¿‡<code>C2ComponentStore</code>ç®¡ç†
   - æ”¯æŒåŠ¨æ€åŠ è½½å’Œä¼˜å…ˆçº§ç®¡ç†
   - æ›´å¥½çš„vendorç»„ä»¶é›†æˆ</p>
</li>
</ol>
<p><strong>è¿ç§»ç­–ç•¥</strong>ï¼š</p>
<ul>
<li><code>Codec2Client</code>ä½œä¸ºå®¢æˆ·ç«¯æ¥å£</li>
<li><code>C2OMXNode</code>æä¾›OMXå…¼å®¹å±‚</li>
<li>æ¸è¿›å¼è¿ç§»ï¼šæ–°ç»„ä»¶ç”¨Codec2ï¼Œæ—§ç»„ä»¶ä¿æŒOMX</li>
</ul>
<h3 id="1224">12.2.4 ç¡¬ä»¶ç¼–è§£ç å™¨æ¥å…¥</h3>
<p>ç¡¬ä»¶ç¼–è§£ç å™¨çš„é›†æˆæ¶‰åŠå¤šä¸ªå±‚æ¬¡çš„ä¼˜åŒ–å’Œé€‚é…ï¼š</p>
<p><strong>å¹³å°ç‰¹å®šä¼˜åŒ–</strong>ï¼š</p>
<ol>
<li>
<p><strong>é«˜é€šå¹³å°(Venus/Vidc)</strong>ï¼š
   - ä¸“ç”¨çš„è§†é¢‘æ ¸å¿ƒï¼šVenuså­ç³»ç»Ÿ
   - SMEMå…±äº«å†…å­˜æœºåˆ¶
   - ä½åŠŸè€—æ¨¡å¼æ”¯æŒ</p>
</li>
<li>
<p><strong>è”å‘ç§‘å¹³å°(MDP/VDEC)</strong>ï¼š
   - ç¡¬ä»¶MDP(Media Data Path)é›†æˆ
   - æ”¯æŒHEIFç­‰æ–°æ ¼å¼
   - AIè¾…åŠ©ç¼–ç ä¼˜åŒ–</p>
</li>
<li>
<p><strong>æµ·æ€/ä¸‰æ˜Ÿå¹³å°</strong>ï¼š
   - è‡ªç ”ç¼–è§£ç IP
   - ä¸ISP/GPUç´§å¯†é›†æˆ
   - ä¸“æœ‰æ ¼å¼æ”¯æŒ</p>
</li>
</ol>
<p><strong>æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯</strong>ï¼š</p>
<ol>
<li>
<p><strong>æ‰¹å¤„ç†æ¨¡å¼(Batch Mode)</strong>ï¼š
   - å‡å°‘å†…æ ¸æ€åˆ‡æ¢å¼€é”€
   - æé«˜ååé‡</p>
</li>
<li>
<p><strong>ä½å»¶è¿Ÿæ¨¡å¼</strong>ï¼š
   - å®æ—¶é€šä¿¡åœºæ™¯ä¼˜åŒ–
   - å¸§å†…é¢„æµ‹å¿«é€Ÿè·¯å¾„</p>
</li>
<li>
<p><strong>åŠŸè€—ä¼˜åŒ–</strong>ï¼š
   - DVFS(Dynamic Voltage and Frequency Scaling)
   - å¤šæ ¸è°ƒåº¦ç­–ç•¥
   - ç¡¬ä»¶ä¼‘çœ ç®¡ç†</p>
</li>
</ol>
<p><strong>å®‰å…¨è§†é¢‘è·¯å¾„(SVP)</strong>ï¼š</p>
<ul>
<li>TrustZoneé›†æˆ</li>
<li>Secure Bufferåˆ†é…</li>
<li>DRMä¿æŠ¤å†…å®¹å¤„ç†</li>
<li>HDCPè¾“å‡ºä¿æŠ¤</li>
</ul>
<h2 id="123-stagefright_1">12.3 Stagefrightæ¶æ„</h2>
<h3 id="1231-mediaextractorparser">12.3.1 MediaExtractorä¸Parser</h3>
<p>Stagefrightæ˜¯Androidçš„å¤šåª’ä½“æ’­æ”¾å¼•æ“ï¼Œå…¶æ¨¡å—åŒ–è®¾è®¡æ”¯æŒå¤šç§å®¹å™¨æ ¼å¼å’Œç¼–è§£ç å™¨ã€‚MediaExtractoræ˜¯è§£æåª’ä½“æ–‡ä»¶çš„æ ¸å¿ƒç»„ä»¶ã€‚</p>
<p><strong>MediaExtractoræ¶æ„</strong>ï¼š</p>
<ol>
<li>
<p><strong>Snifferæœºåˆ¶</strong>ï¼š
   - é€šè¿‡<code>DataSource</code>è¯»å–æ–‡ä»¶å¤´
   - è°ƒç”¨å„ä¸ªExtractorçš„<code>sniff()</code>å‡½æ•°è¯†åˆ«æ ¼å¼
   - åŸºäºç½®ä¿¡åº¦é€‰æ‹©åˆé€‚çš„Extractor</p>
</li>
<li>
<p><strong>æ”¯æŒçš„å®¹å™¨æ ¼å¼</strong>ï¼š
   - MP4/3GP: <code>MPEG4Extractor</code>
   - MKV/WebM: <code>MatroskaExtractor</code>
   - MP3: <code>MP3Extractor</code>
   - FLAC: <code>FLACExtractor</code>
   - å¯é€šè¿‡æ’ä»¶æ‰©å±•æ–°æ ¼å¼</p>
</li>
<li>
<p><strong>Trackç®¡ç†</strong>ï¼š
   - <code>getTrackCount()</code> - è·å–è½¨é“æ•°
   - <code>getTrackFormat()</code> - è·å–è½¨é“å…ƒæ•°æ®
   - <code>selectTrack()</code> - é€‰æ‹©è¦è§£ç çš„è½¨é“
   - <code>readSampleData()</code> - è¯»å–æ ·æœ¬æ•°æ®</p>
</li>
</ol>
<p><strong>Parserå®ç°ç»†èŠ‚</strong>ï¼š</p>
<ul>
<li>å¢é‡è§£æï¼šæ”¯æŒç½‘ç»œæµåª’ä½“</li>
<li>ç´¢å¼•æ„å»ºï¼šå¿«é€Ÿseekæ”¯æŒ</li>
<li>å…ƒæ•°æ®æå–ï¼šID3ã€Vorbis Commentç­‰</li>
<li>é”™è¯¯æ¢å¤ï¼šå¤„ç†æŸåçš„åª’ä½“æ–‡ä»¶</li>
</ul>
<h3 id="1232-mediacodec">12.3.2 MediaCodecç®¡ç†æœºåˆ¶</h3>
<p>Stagefrighté€šè¿‡MediaCodecç®¡ç†ç¼–è§£ç å™¨çš„ç”Ÿå‘½å‘¨æœŸå’Œèµ„æºåˆ†é…ï¼š</p>
<p><strong>Codecé€‰æ‹©ç­–ç•¥</strong>ï¼š</p>
<ol>
<li>
<p><strong>åª’ä½“ç¼–è§£ç å™¨åˆ—è¡¨</strong>ï¼š
   - <code>/system/etc/media_codecs.xml</code>å®šä¹‰å¯ç”¨ç¼–è§£ç å™¨
   - æ€§èƒ½ç­‰çº§å£°æ˜ï¼š<code>MediaCodecInfo.CodecCapabilities</code>
   - ç¡¬ä»¶ä¼˜å…ˆåŸåˆ™</p>
</li>
<li>
<p><strong>åŠ¨æ€èƒ½åŠ›æŸ¥è¯¢</strong>ï¼š</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code>ç¼–è§£ç å™¨èƒ½åŠ›åŒ…æ‹¬ï¼š

- æ”¯æŒçš„åˆ†è¾¨ç‡èŒƒå›´
- å¸§ç‡é™åˆ¶
- æ¯”ç‰¹ç‡èŒƒå›´
- Profile/Levelæ”¯æŒ
</code></pre></div>

<ol start="3">
<li><strong>èµ„æºç®¡ç†å™¨(ResourceManager)</strong>ï¼š
   - è·Ÿè¸ªç¼–è§£ç å™¨ä½¿ç”¨æƒ…å†µ
   - åŸºäºä¼˜å…ˆçº§çš„èµ„æºåˆ†é…
   - å¤„ç†èµ„æºç«äº‰å’Œå›æ”¶</li>
</ol>
<p><strong>ç¼“å†²åŒºæµè½¬ä¼˜åŒ–</strong>ï¼š</p>
<ul>
<li>BufferQueueé›†æˆï¼šç›´æ¥æ¸²æŸ“è·¯å¾„</li>
<li>GraphicBufferå…±äº«ï¼šå‡å°‘æ‹·è´</li>
<li>æ—¶é—´æˆ³ä¼ é€’ï¼šéŸ³è§†é¢‘åŒæ­¥</li>
</ul>
<h3 id="1233-audiotrackvideotrack">12.3.3 AudioTrack/VideoTrackå¤„ç†</h3>
<p>Stagefrightä¸­éŸ³è§†é¢‘è½¨é“çš„å¤„ç†æ¶‰åŠè§£ç ã€æ¸²æŸ“å’ŒåŒæ­¥ï¼š</p>
<p><strong>AudioTrackå¤„ç†æµç¨‹</strong>ï¼š</p>
<ol>
<li><strong>éŸ³é¢‘è§£ç é“¾è·¯</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code>MediaExtractor â†’ AudioSource â†’ MediaCodec â†’ AudioSink
                                    â†“
                               AudioTrack â†’ AudioFlinger
</code></pre></div>

<ol start="2">
<li>
<p><strong>é‡é‡‡æ ·å’Œæ··éŸ³</strong>ï¼š
   - <code>AudioResampler</code>å¤„ç†é‡‡æ ·ç‡è½¬æ¢
   - æ”¯æŒå¤šé€šé“ä¸‹æ··åˆ°ç«‹ä½“å£°
   - éŸ³é‡è°ƒèŠ‚å’Œæ·¡å…¥æ·¡å‡º</p>
</li>
<li>
<p><strong>ä½å»¶è¿Ÿä¼˜åŒ–</strong>ï¼š
   - FastTrackæœºåˆ¶
   - ç›´æ¥HALè·¯å¾„
   - å‡å°‘ç¼“å†²åŒºå¤§å°</p>
</li>
</ol>
<p><strong>VideoTrackæ¸²æŸ“ç®¡é“</strong>ï¼š</p>
<ol>
<li>
<p><strong>Surfaceæ¸²æŸ“è·¯å¾„</strong>ï¼š
   - MediaCodec â†’ Surface â†’ SurfaceFlinger
   - ç¡¬ä»¶åˆæˆä¼˜åŒ–
   - HDRå…ƒæ•°æ®ä¼ é€’</p>
</li>
<li>
<p><strong>è‰²å½©ç©ºé—´è½¬æ¢</strong>ï¼š
   - YUVåˆ°RGBè½¬æ¢
   - HDRåˆ°SDRæ˜ å°„
   - å‚å•†ç‰¹å®šä¼˜åŒ–</p>
</li>
<li>
<p><strong>å¸§ç‡æ§åˆ¶</strong>ï¼š
   - VSyncåŒæ­¥æœºåˆ¶
   - ä¸¢å¸§ç­–ç•¥
   - è‡ªé€‚åº”åˆ·æ–°ç‡</p>
</li>
</ol>
<h3 id="1234-drm">12.3.4 DRMé›†æˆä¸ä¿æŠ¤</h3>
<p>Stagefrighté›†æˆäº†å¤šç§DRM(Digital Rights Management)ç³»ç»Ÿï¼š</p>
<p><strong>DRMæ¡†æ¶æ¶æ„</strong>ï¼š</p>
<ol>
<li>
<p><strong>MediaDrm API</strong>ï¼š
   - æä¾›DRMä¼šè¯ç®¡ç†
   - è®¸å¯è¯è·å–å’Œå­˜å‚¨
   - æ”¯æŒWidevineã€PlayReadyç­‰</p>
</li>
<li>
<p><strong>åŠ å¯†åª’ä½“æ‰©å±•(EME)</strong>ï¼š
   - <code>MediaCrypto</code>å¯¹è±¡å…³è”
   - å®‰å…¨è§£ç å™¨è·¯å¾„
   - è¾“å‡ºä¿æŠ¤ç­–ç•¥</p>
</li>
<li>
<p><strong>å¯†é’¥ç®¡ç†</strong>ï¼š
   - å¯†é’¥è¯·æ±‚/å“åº”æœºåˆ¶
   - ç¦»çº¿è®¸å¯è¯æ”¯æŒ
   - å¯†é’¥è½®æ¢å¤„ç†</p>
</li>
</ol>
<p><strong>å®‰å…¨æ’­æ”¾å®ç°</strong>ï¼š</p>
<ol>
<li>
<p><strong>Secure Decoder</strong>ï¼š
   - TEEä¸­çš„è§£ç å™¨å®ä¾‹
   - åŠ å¯†è¾“å…¥ç¼“å†²åŒº
   - å®‰å…¨è¾“å‡ºè·¯å¾„</p>
</li>
<li>
<p><strong>HDCPé›†æˆ</strong>ï¼š
   - Displayçº§åˆ«çš„å†…å®¹ä¿æŠ¤
   - ç‰ˆæœ¬åå•†(HDCP 1.x/2.x)
   - é™çº§ç­–ç•¥</p>
</li>
<li>
<p><strong>é˜²æˆªå±æœºåˆ¶</strong>ï¼š
   - Surfaceæ ‡è®°ä¸ºsecure
   - GPUæ¸²æŸ“é™åˆ¶
   - æˆªå±APIè¿”å›é»‘å±</p>
</li>
</ol>
<p><strong>å¸¸è§DRMç³»ç»Ÿå¯¹æ¯”</strong>ï¼š</p>
<ul>
<li><strong>Widevine</strong>ï¼šGoogleå®˜æ–¹ï¼ŒL1/L2/L3å®‰å…¨çº§åˆ«</li>
<li><strong>PlayReady</strong>ï¼šå¾®è½¯æ–¹æ¡ˆï¼ŒWindowsç”Ÿæ€å…¼å®¹</li>
<li><strong>China DRM</strong>ï¼šå›½å†…è§†é¢‘å¹³å°é‡‡ç”¨</li>
<li><strong>Marlin</strong>ï¼šæ—¥æœ¬å¸‚åœºæ–¹æ¡ˆ</li>
</ul>
<h2 id="124-ios-avfoundation_1">12.4 ä¸iOS AVFoundationå¯¹æ¯”</h2>
<h3 id="1241">12.4.1 æ¶æ„è®¾è®¡å·®å¼‚</h3>
<p>Androidå’ŒiOSåœ¨å¤šåª’ä½“æ¡†æ¶è®¾è®¡ä¸Šä½“ç°äº†ä¸åŒçš„ç†å¿µå’Œä¼˜åŒ–ç›®æ ‡ï¼š</p>
<p><strong>åˆ†å±‚æ¶æ„å¯¹æ¯”</strong>ï¼š</p>
<p>Androidå¤šåª’ä½“æ ˆï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="err">åº”ç”¨å±‚</span><span class="o">:</span><span class="w"> </span><span class="n">MediaPlayer</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">Camera2</span><span class="w"> </span><span class="n">API</span>
<span class="w">  </span><span class="err">â†“</span>
<span class="err">æ¡†æ¶å±‚</span><span class="o">:</span><span class="w"> </span><span class="n">MediaCodec</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">Stagefright</span>
<span class="w">  </span><span class="err">â†“</span>
<span class="n">HALå±‚</span><span class="o">:</span><span class="w"> </span><span class="n">OMX</span><span class="w"> </span><span class="sr">/ Codec2 /</span><span class="w"> </span><span class="n">Camera</span><span class="w"> </span><span class="n">HAL</span>
<span class="w">  </span><span class="err">â†“</span>
<span class="err">å†…æ ¸å±‚</span><span class="o">:</span><span class="w"> </span><span class="n">V4L2</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="err">å‚å•†é©±åŠ¨</span>
</code></pre></div>

<p>iOS AVFoundationæ ˆï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="err">åº”ç”¨å±‚</span><span class="o">:</span><span class="w"> </span><span class="n">AVFoundation</span><span class="w"> </span><span class="n">Framework</span>
<span class="w">  </span><span class="err">â†“</span>
<span class="err">æ ¸å¿ƒå±‚</span><span class="o">:</span><span class="w"> </span><span class="n">Core</span><span class="w"> </span><span class="n">Media</span><span class="w"> </span><span class="sr">/ Core Video /</span><span class="w"> </span><span class="n">Core</span><span class="w"> </span><span class="n">Audio</span>
<span class="w">  </span><span class="err">â†“</span>
<span class="err">é©±åŠ¨å±‚</span><span class="o">:</span><span class="w"> </span><span class="n">IOKit</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">Metal</span><span class="w"> </span><span class="n">Performance</span><span class="w"> </span><span class="n">Shaders</span>
<span class="w">  </span><span class="err">â†“</span>
<span class="err">å†…æ ¸å±‚</span><span class="o">:</span><span class="w"> </span><span class="n">Darwinå†…æ ¸é©±åŠ¨</span>
</code></pre></div>

<p><strong>è®¾è®¡ç†å¿µå·®å¼‚</strong>ï¼š</p>
<ol>
<li>
<p><strong>APIç»Ÿä¸€æ€§</strong>ï¼š
   - iOS: AVFoundationæä¾›ç»Ÿä¸€çš„éŸ³è§†é¢‘å¤„ç†æ¥å£
   - Android: åˆ†æ•£çš„API(MediaPlayerã€MediaCodecã€Camera2ç­‰)</p>
</li>
<li>
<p><strong>ç¡¬ä»¶æŠ½è±¡</strong>ï¼š
   - iOS: ç´§å¯†çš„è½¯ç¡¬ä»¶é›†æˆï¼Œç›´æ¥ä¼˜åŒ–ç‰¹å®šç¡¬ä»¶
   - Android: é€šç”¨HALå±‚ï¼Œéœ€è¦é€‚é…å¤šç§ç¡¬ä»¶å¹³å°</p>
</li>
<li>
<p><strong>è¿›ç¨‹æ¨¡å‹</strong>ï¼š
   - iOS: å•ä¸€è¿›ç¨‹å†…å¤„ç†ï¼Œå‡å°‘IPCå¼€é”€
   - Android: è·¨è¿›ç¨‹æ¶æ„(MediaServer)ï¼Œæ›´å¥½çš„éš”ç¦»æ€§</p>
</li>
</ol>
<h3 id="1242">12.4.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥å¯¹æ¯”</h3>
<p>ä¸¤ä¸ªå¹³å°åœ¨æ€§èƒ½ä¼˜åŒ–ä¸Šé‡‡å–äº†ä¸åŒçš„ç­–ç•¥ï¼š</p>
<p><strong>iOSä¼˜åŒ–ç‰¹ç‚¹</strong>ï¼š</p>
<ol>
<li>
<p><strong>Metalé›†æˆ</strong>ï¼š
   - ç›´æ¥ä½¿ç”¨Metalè¿›è¡Œè§†é¢‘å¤„ç†
   - GPUåŠ é€Ÿçš„æ»¤é•œå’Œç‰¹æ•ˆ
   - ç»Ÿä¸€çš„æ¸²æŸ“ç®¡é“</p>
</li>
<li>
<p><strong>å†…å­˜ç®¡ç†</strong>ï¼š
   - IOSurfaceé›¶æ‹·è´æœºåˆ¶
   - ç»Ÿä¸€çš„å†…å­˜æ± ç®¡ç†
   - è‡ªåŠ¨å†…å­˜å‹ç¼©</p>
</li>
<li>
<p><strong>èƒ½æ•ˆä¼˜åŒ–</strong>ï¼š
   - åå¤„ç†å™¨å¸è½½(å¦‚Neural Engine)
   - ç²¾ç¡®çš„åŠŸè€—é¢„ç®—
   - è‡ªé€‚åº”è´¨é‡è°ƒæ•´</p>
</li>
</ol>
<p><strong>Androidä¼˜åŒ–æŒ‘æˆ˜ä¸æ–¹æ¡ˆ</strong>ï¼š</p>
<ol>
<li>
<p><strong>ç¢ç‰‡åŒ–åº”å¯¹</strong>ï¼š
   - CTSæµ‹è¯•ä¿è¯åŸºç¡€å…¼å®¹æ€§
   - Vendoræ‰©å±•æœºåˆ¶
   - åŠ¨æ€æ€§èƒ½è°ƒæ•´</p>
</li>
<li>
<p><strong>å†…å­˜ä¼˜åŒ–</strong>ï¼š
   - ION/DMA-BUFå…±äº«æœºåˆ¶
   - GraphicBufferè·¨è¿›ç¨‹å…±äº«
   - ä½å†…å­˜è®¾å¤‡ä¼˜åŒ–(Go Edition)</p>
</li>
<li>
<p><strong>è°ƒåº¦ä¼˜åŒ–</strong>ï¼š
   - å¤§å°æ ¸è°ƒåº¦ç­–ç•¥
   - thermal throttlingå¤„ç†
   - åå°é™åˆ¶æœºåˆ¶</p>
</li>
</ol>
<h3 id="1243-api">12.4.3 APIæ˜“ç”¨æ€§åˆ†æ</h3>
<p><strong>iOS AVFoundationä¼˜åŠ¿</strong>ï¼š</p>
<ol>
<li>
<p><strong>ä¸€è‡´çš„å¯¹è±¡æ¨¡å‹</strong>ï¼š
   - AVAssetç»Ÿä¸€è¡¨ç¤ºåª’ä½“èµ„æº
   - AVPlayerå¤„ç†æ‰€æœ‰æ’­æ”¾éœ€æ±‚
   - AVCaptureSessionç»Ÿä¸€ç›¸æœºæ¥å£</p>
</li>
<li>
<p><strong>Swifté›†æˆ</strong>ï¼š
   - ç°ä»£åŒ–çš„APIè®¾è®¡
   - å¼ºç±»å‹å’Œå¯é€‰å€¼
   - Combineæ¡†æ¶é›†æˆ</p>
</li>
<li>
<p><strong>æ–‡æ¡£å’Œå·¥å…·</strong>ï¼š
   - å®Œå–„çš„å®˜æ–¹æ–‡æ¡£
   - Instrumentsæ€§èƒ½åˆ†æ
   - å¯è§†åŒ–çš„è°ƒè¯•å·¥å…·</p>
</li>
</ol>
<p><strong>Androidå¤šåª’ä½“APIç‰¹ç‚¹</strong>ï¼š</p>
<ol>
<li>
<p><strong>çµæ´»æ€§</strong>ï¼š
   - å¤šå±‚æ¬¡APIé€‰æ‹©(ä»MediaPlayeråˆ°MediaCodec)
   - æ”¯æŒè‡ªå®šä¹‰ç»„ä»¶
   - å¼€æºå®ç°å¯å‚è€ƒ</p>
</li>
<li>
<p><strong>å…¼å®¹æ€§è€ƒè™‘</strong>ï¼š
   - æ”¯æŒæ—§ç‰ˆæœ¬API
   - å¤šç§å®ç°è·¯å¾„
   - Jetpack CameraXç®€åŒ–ä½¿ç”¨</p>
</li>
<li>
<p><strong>è°ƒè¯•æ”¯æŒ</strong>ï¼š
   - dumpsys media.*
   - Systraceæ€§èƒ½è¿½è¸ª
   - å¼€æºä»£ç å¯è°ƒè¯•</p>
</li>
</ol>
<h3 id="1244">12.4.4 ç”Ÿæ€ç³»ç»Ÿå·®å¼‚</h3>
<p><strong>ç¼–è§£ç å™¨æ”¯æŒ</strong>ï¼š</p>
<ul>
<li>iOS: æœ‰é™ä½†ä¼˜åŒ–çš„ç¼–è§£ç å™¨é›†(HEVC/HEIFåŸç”Ÿæ”¯æŒ)</li>
<li>Android: å¹¿æ³›çš„ç¼–è§£ç å™¨æ”¯æŒï¼Œä½†è´¨é‡å‚å·®ä¸é½</li>
</ul>
<p><strong>DRMç”Ÿæ€</strong>ï¼š</p>
<ul>
<li>iOS: FairPlay Streamingç»Ÿä¸€æ–¹æ¡ˆ</li>
<li>Android: å¤šç§DRMç³»ç»Ÿå¹¶å­˜(Widevineä¸ºä¸»)</li>
</ul>
<p><strong>å¼€å‘è€…ç”Ÿæ€</strong>ï¼š</p>
<ol>
<li>
<p><strong>iOSç‰¹ç‚¹</strong>ï¼š
   - å°é—­ä½†ä¸€è‡´çš„å¼€å‘ä½“éªŒ
   - ä¸¥æ ¼çš„App Storeå®¡æ ¸
   - ä»˜è´¹åº”ç”¨ç”Ÿæ€æˆç†Ÿ</p>
</li>
<li>
<p><strong>Androidç‰¹ç‚¹</strong>ï¼š
   - å¼€æ”¾çš„ç”Ÿæ€ç³»ç»Ÿ
   - å¤šæ¸ é“åˆ†å‘
   - å¼€æºé¡¹ç›®ä¸°å¯Œ</p>
</li>
</ol>
<p><strong>æ€§èƒ½åŸºå‡†å¯¹æ¯”</strong>ï¼š</p>
<ul>
<li>4Kè§†é¢‘è§£ç ï¼šiOSé€šå¸¸åŠŸè€—æ›´ä½</li>
<li>ç›¸æœºå¯åŠ¨é€Ÿåº¦ï¼šiOSæ›´å¿«(~200ms vs ~400ms)</li>
<li>å¤šè·¯è§†é¢‘å¤„ç†ï¼šAndroidæ›´çµæ´»</li>
<li>AIå¤„ç†é›†æˆï¼šiOS Neural Engine vs Android NNAPI</li>
</ul>
<h2 id="125_1">12.5 æœ¬ç« å°ç»“</h2>
<p>æœ¬ç« æ·±å…¥æ¢è®¨äº†Androidç›¸æœºä¸å¤šåª’ä½“æ¡†æ¶çš„æ ¸å¿ƒæ¶æ„å’Œå®ç°åŸç†ï¼š</p>
<ol>
<li>
<p><strong>Camera HALæ¼”è¿›</strong>ï¼šä»ç®€å•çš„v1åŒæ­¥æ¥å£åˆ°åŸºäºæµçš„v3æ¶æ„ï¼Œå®ç°äº†æ›´çµæ´»çš„å›¾åƒå¤„ç†ç®¡é“ã€‚Trebleæ¶æ„å¼•å…¥çš„Provideræ¨¡å‹è¿›ä¸€æ­¥æå‡äº†æ¨¡å—åŒ–ç¨‹åº¦ã€‚</p>
</li>
<li>
<p><strong>MediaCodecæ¶æ„</strong>ï¼šé€šè¿‡çŠ¶æ€æœºæ¨¡å‹å’Œç¼“å†²åŒºé˜Ÿåˆ—æœºåˆ¶ï¼Œæä¾›äº†é«˜æ•ˆçš„ç¼–è§£ç å™¨è®¿é—®ã€‚ä»OMXåˆ°Codec2çš„æ¼”è¿›è§£å†³äº†æ¥å£å¤æ‚åº¦å’Œæ€§èƒ½é—®é¢˜ã€‚</p>
</li>
<li>
<p><strong>Stagefrightæ¡†æ¶</strong>ï¼šæ¨¡å—åŒ–çš„è®¾è®¡æ”¯æŒå¤šç§åª’ä½“æ ¼å¼ï¼Œé€šè¿‡MediaExtractorã€MediaCodecå’Œæ¸²æŸ“ç®¡é“çš„é…åˆï¼Œå®ç°äº†å®Œæ•´çš„å¤šåª’ä½“æ’­æ”¾åŠŸèƒ½ã€‚</p>
</li>
<li>
<p><strong>ä¸iOSå¯¹æ¯”</strong>ï¼šAndroidçš„å¼€æ”¾æ€§å¸¦æ¥äº†æ›´å¤§çš„çµæ´»æ€§ä½†ä¹Ÿå¢åŠ äº†å¤æ‚åº¦ï¼Œè€ŒiOSçš„å‚ç›´æ•´åˆæä¾›äº†æ›´ä¸€è‡´çš„æ€§èƒ½è¡¨ç°ã€‚</p>
</li>
</ol>
<p>å…³é”®æ€§èƒ½æŒ‡æ ‡ï¼š</p>
<ul>
<li>Camera HAL3è¯·æ±‚å»¶è¿Ÿï¼š&lt; 33ms (30fps)</li>
<li>MediaCodecåˆå§‹åŒ–æ—¶é—´ï¼š&lt; 100ms</li>
<li>4K@30fpsè§£ç åŠŸè€—ï¼š&lt; 500mW</li>
<li>DRMå¯†é’¥åŠ è½½æ—¶é—´ï¼š&lt; 200ms</li>
</ul>
<h2 id="126_1">12.6 ç»ƒä¹ é¢˜</h2>
<h3 id="_3">åŸºç¡€é¢˜</h3>
<ol>
<li><strong>Camera HALç‰ˆæœ¬å·®å¼‚</strong>
   æè¿°Camera HAL v1å’Œv3åœ¨å¤„ç†é¢„è§ˆæµæ—¶çš„ä¸»è¦æ¶æ„å·®å¼‚ã€‚</li>
</ol>
<details markdown="block">
   <summary markdown="off">Hint: è€ƒè™‘åŒæ­¥vså¼‚æ­¥æ¨¡å‹</summary>

   æ€è€ƒv1çš„å›è°ƒæ¨¡å¼å’Œv3çš„request/resultæ¨¡å‹å¦‚ä½•å½±å“é¢„è§ˆæµçš„å¤„ç†æ•ˆç‡ã€‚
   </details>
<details markdown="block">
   <summary markdown="off">å‚è€ƒç­”æ¡ˆ</summary>

   HAL v1ä½¿ç”¨åŒæ­¥çš„å›è°ƒæ¨¡å¼ï¼Œé¢„è§ˆæ•°æ®é€šè¿‡data_callbackç›´æ¥ä¼ é€’ï¼Œæ•´ä¸ªæµç¨‹æ˜¯é˜»å¡å¼çš„ã€‚HAL v3é‡‡ç”¨å¼‚æ­¥çš„request/resultæ¨¡å‹ï¼Œé¢„è§ˆæµä½œä¸ºä¸€ä¸ªæŒç»­çš„streamé…ç½®ï¼Œé€šè¿‡capture requestçš„é‡å¤æäº¤å®ç°ï¼Œæ”¯æŒpipelineå¹¶è¡Œå¤„ç†ï¼Œæ˜¾è‘—æå‡äº†å¸§ç‡å’Œå“åº”é€Ÿåº¦ã€‚
   </details>
<ol start="2">
<li><strong>MediaCodecçŠ¶æ€æœº</strong>
   ç”»å‡ºMediaCodecçš„å®Œæ•´çŠ¶æ€è½¬æ¢å›¾ï¼Œå¹¶è¯´æ˜åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè¿›å…¥ErrorçŠ¶æ€ã€‚</li>
</ol>
<details markdown="block">
   <summary markdown="off">Hint: è€ƒè™‘configureå’Œstartçš„é¡ºåº</summary>

   MediaCodecæœ‰ä¸¥æ ¼çš„çŠ¶æ€è½¬æ¢è¦æ±‚ï¼Œé”™è¯¯çš„APIè°ƒç”¨é¡ºåºä¼šå¯¼è‡´å¼‚å¸¸ã€‚
   </details>
<details markdown="block">
   <summary markdown="off">å‚è€ƒç­”æ¡ˆ</summary>

   çŠ¶æ€è½¬æ¢ï¼šUninitialized â†’(configure)â†’ Configured â†’(start)â†’ Executing â†’(stop)â†’ Configured â†’(release)â†’ Releasedã€‚ErrorçŠ¶æ€å¯èƒ½ç”±ä»¥ä¸‹åŸå› è§¦å‘ï¼š1)ç¼–è§£ç å™¨èµ„æºä¸è¶³ 2)è¾“å…¥æ•°æ®æ ¼å¼é”™è¯¯ 3)ç¡¬ä»¶æ•…éšœ 4)DRMè®¸å¯è¯å¤±æ•ˆ 5)åœ¨é”™è¯¯çŠ¶æ€è°ƒç”¨APIã€‚
   </details>
<ol start="3">
<li><strong>Stagefrightç»„ä»¶äº¤äº’</strong>
   è§£é‡ŠMediaExtractorã€MediaCodecå’ŒMediaPlayerä¹‹é—´çš„æ•°æ®æµå…³ç³»ã€‚</li>
</ol>
<details markdown="block">
   <summary markdown="off">Hint: è€ƒè™‘push vs pullæ¨¡å‹</summary>

   æ³¨æ„å“ªä¸ªç»„ä»¶ä¸»åŠ¨æ‹‰å–æ•°æ®ï¼Œå“ªä¸ªç»„ä»¶è¢«åŠ¨æ¥æ”¶æ•°æ®ã€‚
   </details>
<details markdown="block">
   <summary markdown="off">å‚è€ƒç­”æ¡ˆ</summary>

   MediaExtractorè§£æå®¹å™¨æ ¼å¼ï¼Œæå–éŸ³è§†é¢‘è½¨é“æ•°æ®ã€‚MediaPlayerä½œä¸ºåè°ƒè€…ï¼Œä»MediaExtractoræ‹‰å–å‹ç¼©æ•°æ®ï¼Œæ¨é€ç»™å¯¹åº”çš„MediaCodecè¿›è¡Œè§£ç ã€‚è§£ç åçš„æ•°æ®é€šè¿‡AudioTrackè¾“å‡ºéŸ³é¢‘ï¼Œé€šè¿‡Surfaceè¾“å‡ºè§†é¢‘ã€‚æ•´ä½“æ˜¯pullæ¨¡å‹ï¼Œç”±æ¸²æŸ“ç«¯é©±åŠ¨æ•°æ®æµåŠ¨ã€‚
   </details>
<h3 id="_4">æŒ‘æˆ˜é¢˜</h3>
<ol start="4">
<li><strong>å¤šç›¸æœºåŒæ­¥æ–¹æ¡ˆè®¾è®¡</strong>
   è®¾è®¡ä¸€ä¸ªæ”¯æŒå››è·¯ç›¸æœºåŒæ—¶é‡‡é›†çš„ç³»ç»Ÿæ¶æ„ï¼Œè¦æ±‚æ—¶é—´æˆ³åŒæ­¥è¯¯å·®å°äº1msï¼Œè¯´æ˜ä½ çš„è®¾è®¡å¦‚ä½•å¤„ç†ï¼š</li>
</ol>
<ul>
<li>ç¡¬ä»¶æ—¶é’ŸåŒæ­¥</li>
<li>ç¼“å†²åŒºç®¡ç†</li>
<li>CPU/ISPèµ„æºè°ƒåº¦</li>
</ul>
<details markdown="block">
   <summary markdown="off">Hint: è€ƒè™‘ç¡¬ä»¶å’Œè½¯ä»¶ä¸¤ä¸ªå±‚é¢</summary>

   ç¡¬ä»¶å±‚é¢éœ€è¦å…±äº«æ—¶é’Ÿæºï¼Œè½¯ä»¶å±‚é¢éœ€è¦åè°ƒå¤šä¸ªHALå®ä¾‹ã€‚
   </details>
<details markdown="block">
   <summary markdown="off">å‚è€ƒç­”æ¡ˆ</summary>

   é‡‡ç”¨ä¸»ä»æ—¶é’Ÿæ¶æ„ï¼š1)ç¡¬ä»¶å±‚é€šè¿‡å…±äº«VSYNCä¿¡å·å®ç°å¸§åŒæ­¥ï¼Œä½¿ç”¨ç»Ÿä¸€çš„æ—¶é’Ÿæº(å¦‚TSC)ç”Ÿæˆæ—¶é—´æˆ³ã€‚2)è½¯ä»¶å±‚åœ¨CameraProviderä¸­å®ç°åŒæ­¥åè°ƒå™¨ï¼Œé¢„åˆ†é…ç¯å½¢ç¼“å†²åŒºæ± é¿å…åŠ¨æ€åˆ†é…å¼€é”€ã€‚3)é€šè¿‡è®¾ç½®CPUäº²å’Œæ€§å°†ä¸åŒç›¸æœºçš„ISPå¤„ç†åˆ†é…åˆ°ä¸åŒæ ¸å¿ƒï¼Œä½¿ç”¨ç¡¬ä»¶ä¼˜å…ˆçº§ç¡®ä¿å…³é”®è·¯å¾„çš„å®æ—¶æ€§ã€‚æ—¶é—´æˆ³åœ¨HALå±‚ç»Ÿä¸€æ ¡å‡†ï¼Œç¡®ä¿äºšæ¯«ç§’çº§åŒæ­¥ã€‚
   </details>
<ol start="5">
<li><strong>ä½å»¶è¿Ÿè§†é¢‘é€šè¯ä¼˜åŒ–</strong>
   é’ˆå¯¹1080p@30fpsçš„å®æ—¶è§†é¢‘é€šè¯åœºæ™¯ï¼Œè®¾è®¡ä¸€ä¸ªç«¯åˆ°ç«¯å»¶è¿Ÿå°äº100msçš„å¤„ç†pipelineï¼Œè€ƒè™‘ï¼š</li>
</ol>
<ul>
<li>ç¼–ç å™¨å‚æ•°ä¼˜åŒ–</li>
<li>ç¼“å†²åŒºå¤§å°è®¾ç½®</li>
<li>è·¨è¿›ç¨‹æ•°æ®ä¼ è¾“</li>
</ul>
<details markdown="block">
   <summary markdown="off">Hint: å»¶è¿Ÿæ¥æºåˆ†æ</summary>

   è¯†åˆ«é‡‡é›†ã€ç¼–ç ã€ä¼ è¾“ã€è§£ç ã€æ¸²æŸ“å„ç¯èŠ‚çš„å»¶è¿Ÿè´¡çŒ®ã€‚
   </details>
<details markdown="block">
   <summary markdown="off">å‚è€ƒç­”æ¡ˆ</summary>

   1)ä½¿ç”¨Camera2çš„TEMPLATE_RECORDæ¨¡æ¿ï¼Œå…³é—­3Aç®—æ³•çš„å¤æ‚å¤„ç†ã€‚2)MediaCodecé…ç½®ï¼šå¯ç”¨ä½å»¶è¿Ÿæ¨¡å¼ï¼Œè®¾ç½®1å¸§çš„ç¼“å†²æ·±åº¦ï¼Œä½¿ç”¨baseline profileï¼Œå…³é—­Bå¸§ã€‚3)ä½¿ç”¨Surfaceç›´é€šè·¯å¾„é¿å…å†…å­˜æ‹·è´ï¼Œé€šè¿‡GraphicBufferå®ç°é›¶æ‹·è´ä¼ è¾“ã€‚4)ç½‘ç»œä¼ è¾“ä½¿ç”¨RTP with FECï¼ŒåŠ¨æ€è°ƒæ•´ç ç‡ã€‚5)è§£ç ç«¯é¢„åˆ†é…Surfaceï¼Œä½¿ç”¨TextureViewç›´æ¥æ¸²æŸ“ã€‚æ•´ä½“å»¶è¿Ÿåˆ†è§£ï¼šé‡‡é›†20ms+ç¼–ç 15ms+ä¼ è¾“40ms+è§£ç 15ms+æ˜¾ç¤º10ms=100msã€‚
   </details>
<ol start="6">
<li><strong>DRMè§†é¢‘é˜²å½•åˆ¶æ–¹æ¡ˆ</strong>
   è®¾è®¡ä¸€ä¸ªé˜²æ­¢DRMä¿æŠ¤è§†é¢‘è¢«å½•åˆ¶çš„å®Œæ•´æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š</li>
</ol>
<ul>
<li>åº”ç”¨å±‚APIé™åˆ¶</li>
<li>æ¸²æŸ“è·¯å¾„ä¿æŠ¤</li>
<li>ç¡¬ä»¶çº§é˜²æŠ¤</li>
</ul>
<details markdown="block">
   <summary markdown="off">Hint: è€ƒè™‘æ‰€æœ‰å¯èƒ½çš„å½•åˆ¶è·¯å¾„</summary>

   åŒ…æ‹¬æˆªå±ã€HDMIè¾“å‡ºã€rootæƒé™è®¿é—®ç­‰å¤šç§æ”»å‡»å‘é‡ã€‚
   </details>
<details markdown="block">
   <summary markdown="off">å‚è€ƒç­”æ¡ˆ</summary>

   å¤šå±‚é˜²æŠ¤ä½“ç³»ï¼š1)åº”ç”¨å±‚é€šè¿‡FLAG_SECUREæ ‡è®°Surfaceï¼Œç¦æ­¢æˆªå±APIè®¿é—®ã€‚2)SurfaceFlingerè¯†åˆ«secure layerï¼Œåœ¨åˆæˆæ—¶è·³è¿‡è¿™äº›å›¾å±‚çš„æˆªå±å¤„ç†ã€‚3)GPUé©±åŠ¨å±‚é¢é™åˆ¶secure bufferçš„è¯»å–æƒé™ã€‚4)HDCPåè®®ä¿æŠ¤å¤–éƒ¨æ˜¾ç¤ºè¾“å‡ºã€‚5)TrustZoneä¸­çš„secure decoderç¡®ä¿è§£å¯†è¿‡ç¨‹éš”ç¦»ã€‚6)ç¡¬ä»¶OTPç†”ä¸é˜²æ­¢bootloaderè§£é”ã€‚7)å®šæœŸè¿œç¨‹è¯æ˜(Remote Attestation)éªŒè¯è®¾å¤‡å®Œæ•´æ€§ã€‚å³ä½¿è®¾å¤‡rootï¼Œè§†é¢‘å†…å®¹ä»åœ¨TEEä¸­å¤„ç†ï¼Œä¸»ç³»ç»Ÿæ— æ³•è®¿é—®æ˜æ–‡æ•°æ®ã€‚
   </details>
<h2 id="127_1">12.7 å¸¸è§é™·é˜±ä¸é”™è¯¯</h2>
<h3 id="camera">Cameraç›¸å…³</h3>
<ol>
<li>
<p><strong>ç›¸æœºèµ„æºæ³„éœ²</strong>
   - é”™è¯¯ï¼šå¿˜è®°è°ƒç”¨<code>CameraDevice.close()</code>
   - åæœï¼šå…¶ä»–åº”ç”¨æ— æ³•è®¿é—®ç›¸æœº
   - è§£å†³ï¼šä½¿ç”¨try-finallyæˆ–lifecycleæ„ŸçŸ¥ç»„ä»¶</p>
</li>
<li>
<p><strong>é¢„è§ˆå°ºå¯¸ä¸åŒ¹é…</strong>
   - é”™è¯¯ï¼šéšæ„è®¾ç½®é¢„è§ˆåˆ†è¾¨ç‡
   - åæœï¼šé¢„è§ˆå˜å½¢æˆ–é»‘å±
   - è§£å†³ï¼šä»<code>getOutputSizes()</code>é€‰æ‹©æ”¯æŒçš„å°ºå¯¸</p>
</li>
<li>
<p><strong>Surfaceç”Ÿå‘½å‘¨æœŸ</strong>
   - é”™è¯¯ï¼šSurfaceé”€æ¯åç»§ç»­ä½¿ç”¨
   - åæœï¼šåŸç”Ÿå´©æºƒ(Native Crash)
   - è§£å†³ï¼šç›‘å¬SurfaceHolder.Callback</p>
</li>
</ol>
<h3 id="mediacodec">MediaCodecç›¸å…³</h3>
<ol start="4">
<li>
<p><strong>ç¼“å†²åŒºè¶…æ—¶</strong>
   - é”™è¯¯ï¼š<code>dequeueBuffer</code>ä½¿ç”¨æ— é™è¶…æ—¶
   - åæœï¼šUIçº¿ç¨‹é˜»å¡ï¼ŒANR
   - è§£å†³ï¼šä½¿ç”¨åˆç†çš„è¶…æ—¶å€¼(å¦‚10ms)</p>
</li>
<li>
<p><strong>æ ¼å¼åå•†å¤±è´¥</strong>
   - é”™è¯¯ï¼šç¡¬ç¼–ç åª’ä½“æ ¼å¼å‚æ•°
   - åæœï¼šç¼–è§£ç å™¨åˆå§‹åŒ–å¤±è´¥
   - è§£å†³ï¼šä½¿ç”¨<code>MediaFormat.createVideo/AudioFormat()</code></p>
</li>
<li>
<p><strong>å¼‚æ­¥æ¨¡å¼æ··æ·†</strong>
   - é”™è¯¯ï¼šåŒæ­¥APIå’ŒCallbackæ··ç”¨
   - åæœï¼šæ­»é”æˆ–æ•°æ®ä¸¢å¤±
   - è§£å†³ï¼šåšæŒä½¿ç”¨ä¸€ç§æ¨¡å¼</p>
</li>
</ol>
<h3 id="_5">æ€§èƒ½ç›¸å…³</h3>
<ol start="7">
<li>
<p><strong>è¿‡åº¦çš„æ ¼å¼è½¬æ¢</strong>
   - é”™è¯¯ï¼šYUVâ†’RGBâ†’YUVè½¬æ¢é“¾
   - åæœï¼šCPUå ç”¨ç‡é«˜ï¼ŒåŠŸè€—å¤§
   - è§£å†³ï¼šä½¿ç”¨Surfaceç›´é€šè·¯å¾„</p>
</li>
<li>
<p><strong>å†…å­˜æŠ–åŠ¨</strong>
   - é”™è¯¯ï¼šé¢‘ç¹åˆ†é…å¤§ç¼“å†²åŒº
   - åæœï¼šGCé¢‘ç¹ï¼Œå¡é¡¿
   - è§£å†³ï¼šä½¿ç”¨ç¼“å†²åŒºæ± </p>
</li>
</ol>
<h2 id="128_1">12.8 æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h2>
<h3 id="_6">æ¶æ„è®¾è®¡å®¡æŸ¥</h3>
<ul>
<li>[ ] æ˜¯å¦æ­£ç¡®å¤„ç†äº†ç›¸æœºæƒé™çš„åŠ¨æ€ç”³è¯·ï¼Ÿ</li>
<li>[ ] æ˜¯å¦è€ƒè™‘äº†å¤šç›¸æœºè®¾å¤‡çš„å…¼å®¹æ€§ï¼Ÿ</li>
<li>[ ] åª’ä½“æ ¼å¼æ˜¯å¦åšäº†èƒ½åŠ›æŸ¥è¯¢è€Œéç¡¬ç¼–ç ï¼Ÿ</li>
<li>[ ] æ˜¯å¦å®ç°äº†ä¼˜é›…çš„é”™è¯¯æ¢å¤æœºåˆ¶ï¼Ÿ</li>
</ul>
<h3 id="_7">æ€§èƒ½ä¼˜åŒ–å®¡æŸ¥</h3>
<ul>
<li>[ ] æ˜¯å¦ä½¿ç”¨äº†ç¡¬ä»¶ç¼–è§£ç å™¨(å¦‚æœå¯ç”¨)ï¼Ÿ</li>
<li>[ ] æ˜¯å¦é¿å…äº†ä¸å¿…è¦çš„å†…å­˜æ‹·è´ï¼Ÿ</li>
<li>[ ] æ˜¯å¦æ­£ç¡®è®¾ç½®äº†çº¿ç¨‹ä¼˜å…ˆçº§ï¼Ÿ</li>
<li>[ ] æ˜¯å¦ç›‘æ§äº†ä¸¢å¸§ç‡å’Œå»¶è¿ŸæŒ‡æ ‡ï¼Ÿ</li>
</ul>
<h3 id="_8">å…¼å®¹æ€§æµ‹è¯•</h3>
<ul>
<li>[ ] æ˜¯å¦åœ¨ä¸åŒå‚å•†è®¾å¤‡ä¸Šæµ‹è¯•ï¼Ÿ</li>
<li>[ ] æ˜¯å¦å¤„ç†äº†ç¼–è§£ç å™¨ç¼ºå¤±çš„æƒ…å†µï¼Ÿ</li>
<li>[ ] æ˜¯å¦æ”¯æŒå¿…è¦çš„å‘åå…¼å®¹ï¼Ÿ</li>
<li>[ ] æ˜¯å¦é€šè¿‡äº†CTSåª’ä½“ç›¸å…³æµ‹è¯•ï¼Ÿ</li>
</ul>
<h3 id="_9">å®‰å…¨æ€§è€ƒè™‘</h3>
<ul>
<li>[ ] DRMå†…å®¹æ˜¯å¦æ­£ç¡®ä¿æŠ¤ï¼Ÿ</li>
<li>[ ] æ˜¯å¦é¿å…äº†æ•æ„Ÿæ•°æ®æ³„éœ²åˆ°æ—¥å¿—ï¼Ÿ</li>
<li>[ ] ä¸´æ—¶æ–‡ä»¶æ˜¯å¦å®‰å…¨æ¸…ç†ï¼Ÿ</li>
<li>[ ] æ˜¯å¦éªŒè¯äº†è¾“å…¥åª’ä½“æ–‡ä»¶çš„åˆæ³•æ€§ï¼Ÿ</li>
</ul>
<h3 id="_10">èµ„æºç®¡ç†</h3>
<ul>
<li>[ ] ç›¸æœºèµ„æºæ˜¯å¦æ­£ç¡®é‡Šæ”¾ï¼Ÿ</li>
<li>[ ] MediaCodecæ˜¯å¦æ­£ç¡®åœæ­¢å’Œé‡Šæ”¾ï¼Ÿ</li>
<li>[ ] Surfaceæ˜¯å¦æ­£ç¡®ç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼Ÿ</li>
<li>[ ] æ˜¯å¦å¤„ç†äº†ç³»ç»Ÿå†…å­˜å‹åŠ›äº‹ä»¶ï¼Ÿ</li>
</ul>
            </article>
            
            <nav class="page-nav"><a href="chapter11.html" class="nav-link prev">â† ç¬¬11ç« ï¼šéŸ³é¢‘ç³»ç»Ÿæ¶æ„</a><a href="chapter13.html" class="nav-link next">ç¬¬13ç« ï¼šAndroidå®‰å…¨æ¨¡å‹ â†’</a></nav>
        </main>
    </div>
</body>
</html>